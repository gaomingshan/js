# pnpm åŸç†ä¸ä¼˜åŠ¿

## æ¦‚è¿°

pnpmï¼ˆperformant npmï¼‰é€šè¿‡å†…å®¹å¯»å€å­˜å‚¨å’Œç¡¬é“¾æ¥æœºåˆ¶ï¼Œè§£å†³äº† npm/yarn çš„ç£ç›˜ç©ºé—´æµªè´¹å’Œå¹½çµä¾èµ–é—®é¢˜ã€‚

## ä¸€ã€æ ¸å¿ƒåŸç†

### 1.1 å†…å®¹å¯»å€å­˜å‚¨

**ä¼ ç»Ÿæ–¹å¼ï¼š**
```
æ¯ä¸ªé¡¹ç›®ç‹¬ç«‹çš„ node_modules/
project-a/node_modules/lodash/
project-b/node_modules/lodash/  # é‡å¤å­˜å‚¨
project-c/node_modules/lodash/
```

**pnpm æ–¹å¼ï¼š**
```
å…¨å±€ storeï¼ˆä¸€ä»½ï¼‰ï¼š
~/.pnpm-store/v3/files/00/1a2b3c.../

é¡¹ç›®ä¸­ï¼ˆç¡¬é“¾æ¥ï¼‰ï¼š
project-a/node_modules/.pnpm/lodash@4.17.21/
project-b/node_modules/.pnpm/lodash@4.17.21/  # æŒ‡å‘åŒä¸€æ–‡ä»¶
```

### 1.2 ç¡¬é“¾æ¥ï¼ˆHard Linkï¼‰

**åŸç†ï¼š** å¤šä¸ªæ–‡ä»¶åæŒ‡å‘åŒä¸€ä¸ª inode

```bash
# å…¨å±€ store
~/.pnpm-store/v3/files/00/abc123/index.js  (inode: 12345)
                    â†“
# é¡¹ç›®ä¸­çš„ç¡¬é“¾æ¥
node_modules/.pnpm/lodash@4.17.21/node_modules/lodash/index.js  (inode: 12345)
```

**ç‰¹ç‚¹ï¼š**
- âš¡ åˆ›å»ºæå¿«ï¼ˆä¸å¤åˆ¶æ–‡ä»¶ï¼‰
- ğŸ’¾ ä¸å ç”¨é¢å¤–ç©ºé—´
- ğŸ”„ ä¿®æ”¹ä¸€å¤„ï¼Œæ‰€æœ‰åœ°æ–¹ç”Ÿæ•ˆ

### 1.3 ç¬¦å·é“¾æ¥ï¼ˆSymbolic Linkï¼‰

**pnpm çš„åŒé‡é“¾æ¥ç»“æ„ï¼š**

```
node_modules/
â”œâ”€â”€ .pnpm/                        # çœŸå®æ–‡ä»¶ï¼ˆç¡¬é“¾æ¥åˆ° storeï¼‰
â”‚   â””â”€â”€ lodash@4.17.21/
â”‚       â””â”€â”€ node_modules/
â”‚           â””â”€â”€ lodash/
â””â”€â”€ lodash -> .pnpm/lodash@4.17.21/node_modules/lodash  # ç¬¦å·é“¾æ¥
```

## äºŒã€ä¸¥æ ¼çš„ä¾èµ–ç®¡ç†

### 2.1 æ²¡æœ‰å¹½çµä¾èµ–

**npm/yarn çš„å¹½çµä¾èµ–ï¼š**
```javascript
// package.json ä¸­æ²¡æœ‰å£°æ˜ lodash
{
  "dependencies": {
    "some-package": "^1.0.0"  // å®ƒä¾èµ–äº† lodash
  }
}

// ä½†å¯ä»¥ä½¿ç”¨ï¼ˆå¹½çµä¾èµ–ï¼‰
import _ from 'lodash';  // âš ï¸ èƒ½ç”¨ä½†ä¸åº”è¯¥
```

**pnpm çš„ä¸¥æ ¼ä¾èµ–ï¼š**
```
node_modules/
â”œâ”€â”€ .pnpm/
â”‚   â”œâ”€â”€ some-package@1.0.0/
â”‚   â”‚   â””â”€â”€ node_modules/
â”‚   â”‚       â”œâ”€â”€ some-package/
â”‚   â”‚       â””â”€â”€ lodash/        # lodash åœ¨è¿™é‡Œ
â”‚   â””â”€â”€ lodash@4.17.21/
â”‚       â””â”€â”€ node_modules/
â”‚           â””â”€â”€ lodash/
â””â”€â”€ some-package -> .pnpm/some-package@1.0.0/node_modules/some-package

# lodash ä¸åœ¨é¡¶å±‚ï¼Œæ— æ³•ç›´æ¥è®¿é—®
```

### 2.2 æ‰å¹³åŒ– vs åµŒå¥—

**pnpm çš„æ··åˆç­–ç•¥ï¼š**

```
node_modules/
â”œâ”€â”€ .pnpm/                    # æ‰å¹³åŒ–å­˜å‚¨
â”‚   â”œâ”€â”€ react@18.2.0/
â”‚   â”œâ”€â”€ lodash@4.17.21/
â”‚   â””â”€â”€ axios@1.4.0/
â””â”€â”€ react -> .pnpm/react@18.2.0/node_modules/react  # ç¬¦å·é“¾æ¥
```

**ä¼˜åŠ¿ï¼š**
- âœ… èŠ‚çœç©ºé—´ï¼ˆå»é‡ï¼‰
- âœ… æ²¡æœ‰å¹½çµä¾èµ–
- âœ… ä¾èµ–å…³ç³»æ¸…æ™°

## ä¸‰ã€æ€§èƒ½ä¼˜åŠ¿

### 3.1 å®‰è£…é€Ÿåº¦

```bash
# å†·å®‰è£…ï¼ˆæ— ç¼“å­˜ï¼‰
npm install:   45s
yarn install:  28s
pnpm install:  14s  âš¡âš¡

# çƒ­å®‰è£…ï¼ˆæœ‰ç¼“å­˜ï¼‰
npm install:   10s
yarn install:  5s
pnpm install:  1s   âš¡âš¡âš¡
```

**åŸå› ï¼š**
- ç¡¬é“¾æ¥åˆ›å»ºæå¿«
- ä¸éœ€è¦å¤åˆ¶æ–‡ä»¶
- å¹¶è¡Œå¤„ç†

### 3.2 ç£ç›˜å ç”¨

```bash
# 10ä¸ªé¡¹ç›®ï¼Œç›¸åŒä¾èµ–
npm/yarn:  5.2 GB  (æ¯ä¸ªé¡¹ç›®ç‹¬ç«‹å­˜å‚¨)
pnpm:      1.8 GB  (å…¨å±€ store + ç¡¬é“¾æ¥)

# èŠ‚çœ 65% ç©ºé—´
```

### 3.3 ç½‘ç»œæµé‡

```bash
# åªä¸‹è½½ä¸€æ¬¡
pnpm install lodash  # ä¸‹è½½åˆ° store
# å…¶ä»–é¡¹ç›®
pnpm install lodash  # ç›´æ¥ä½¿ç”¨ storeï¼Œæ— éœ€ä¸‹è½½
```

## å››ã€ç›®å½•ç»“æ„è¯¦è§£

### 4.1 é¡¹ç›®ç»“æ„

```
my-project/
â”œâ”€â”€ node_modules/
â”‚   â”œâ”€â”€ .pnpm/                     # çœŸå®æ–‡ä»¶
â”‚   â”‚   â”œâ”€â”€ lodash@4.17.21/
â”‚   â”‚   â”‚   â””â”€â”€ node_modules/
â”‚   â”‚   â”‚       â””â”€â”€ lodash/        # ç¡¬é“¾æ¥åˆ° store
â”‚   â”‚   â””â”€â”€ react@18.2.0/
â”‚   â”‚       â””â”€â”€ node_modules/
â”‚   â”‚           â”œâ”€â”€ react/         # ç¡¬é“¾æ¥åˆ° store
â”‚   â”‚           â””â”€â”€ loose-envify/  # react çš„ä¾èµ–
â”‚   â”œâ”€â”€ lodash -> .pnpm/lodash@4.17.21/node_modules/lodash
â”‚   â””â”€â”€ react -> .pnpm/react@18.2.0/node_modules/react
â””â”€â”€ package.json
```

### 4.2 å…¨å±€ store

```
~/.pnpm-store/
â””â”€â”€ v3/
    â””â”€â”€ files/
        â”œâ”€â”€ 00/
        â”‚   â””â”€â”€ 1a2b3c4d...  # ä»¥å†…å®¹å“ˆå¸Œå‘½å
        â”‚       â””â”€â”€ index.js
        â””â”€â”€ 01/
            â””â”€â”€ 5e6f7g8h...
                â””â”€â”€ package.json
```

**ç‰¹ç‚¹ï¼š**
- å†…å®¹å¯»å€ï¼ˆContent-Addressableï¼‰
- åŒä¸€æ–‡ä»¶åªå­˜ä¸€ä»½
- è·¨é¡¹ç›®å…±äº«

## äº”ã€ä¾èµ–è§£æ

### 5.1 pnpm çš„è§£æç­–ç•¥

```
ä¾èµ–å£°æ˜:
  package.json â†’ pnpm-lock.yaml
                    â†“
ä¾èµ–è§£æ:
  æ£€æŸ¥ lock æ–‡ä»¶ â†’ è®¡ç®—ä¾èµ–æ ‘
                    â†“
è·å–åŒ…:
  æ£€æŸ¥ store â†’ ä¸‹è½½ç¼ºå¤±çš„åŒ… â†’ å­˜å…¥ store
                    â†“
é“¾æ¥:
  åˆ›å»ºç¡¬é“¾æ¥ â†’ åˆ›å»ºç¬¦å·é“¾æ¥ â†’ å®Œæˆ
```

### 5.2 peer ä¾èµ–å¤„ç†

**è‡ªåŠ¨è§£æï¼š** pnpm è‡ªåŠ¨å¤„ç† peer ä¾èµ–å†²çª

```bash
# å¦‚æœæœ‰å¤šä¸ª React ç‰ˆæœ¬
node_modules/
â”œâ”€â”€ .pnpm/
â”‚   â”œâ”€â”€ react@18.2.0/
â”‚   â””â”€â”€ react@17.0.0/
â””â”€â”€ react -> .pnpm/react@18.2.0/node_modules/react  # ä½¿ç”¨ä¸»ç‰ˆæœ¬
```

## å…­ã€ä¸ npm/yarn å¯¹æ¯”

### 6.1 åŠŸèƒ½å¯¹æ¯”

| ç‰¹æ€§ | npm | Yarn | pnpm |
|------|-----|------|------|
| **å®‰è£…é€Ÿåº¦** | ğŸŒ | âš¡ | âš¡âš¡âš¡ |
| **ç£ç›˜å ç”¨** | ğŸ’¾ğŸ’¾ğŸ’¾ | ğŸ’¾ğŸ’¾ğŸ’¾ | ğŸ’¾ |
| **å¹½çµä¾èµ–** | âŒ æœ‰ | âŒ æœ‰ | âœ… æ—  |
| **Monorepo** | â­â­ | â­â­â­ | â­â­â­â­â­ |
| **å…¼å®¹æ€§** | âœ…âœ…âœ… | âœ…âœ… | âœ…âœ… |
| **å­¦ä¹ æˆæœ¬** | ä½ | ä¸­ | ä¸­ |

### 6.2 é€‚ç”¨åœºæ™¯

**æ¨èä½¿ç”¨ pnpmï¼š**
- âœ… æ‰€æœ‰æ–°é¡¹ç›®
- âœ… Monorepo
- âœ… ç£ç›˜ç©ºé—´æœ‰é™
- âœ… è¿½æ±‚æ€§èƒ½
- âœ… éœ€è¦ä¸¥æ ¼ä¾èµ–ç®¡ç†

**ç»§ç»­ä½¿ç”¨ npm/yarnï¼š**
- å›¢é˜Ÿå·²ä¹ æƒ¯ä¸”è¿è¡Œè‰¯å¥½
- æŸäº›å·¥å…·ä¸å…¼å®¹ pnpm

## ä¸ƒã€å¹½çµä¾èµ–ç¤ºä¾‹

### 7.1 é—®é¢˜æ¼”ç¤º

**ä½¿ç”¨ npmï¼š**
```json
{
  "dependencies": {
    "express": "^4.18.0"
  }
}
```

```javascript
// express ä¾èµ–äº† body-parserï¼Œæå‡åˆ°é¡¶å±‚
import bodyParser from 'body-parser';  // âš ï¸ èƒ½ç”¨ä½†ä¸å®‰å…¨
```

**é£é™©ï¼š**
- express æ›´æ–°å¯èƒ½ç§»é™¤ body-parser
- ä»£ç çªç„¶æŠ¥é”™

**ä½¿ç”¨ pnpmï¼š**
```javascript
import bodyParser from 'body-parser';  // âŒ æŠ¥é”™
// Error: Cannot find module 'body-parser'
```

**è§£å†³ï¼š**
```bash
pnpm add body-parser  # æ˜¾å¼å£°æ˜ä¾èµ–
```

## å…«ã€è¿ç§»åˆ° pnpm

### 8.1 è¿ç§»æ­¥éª¤

```bash
# 1. å®‰è£… pnpm
npm install -g pnpm

# 2. å¯¼å…¥ lock æ–‡ä»¶
pnpm import  # è‡ªåŠ¨è½¬æ¢ package-lock.json æˆ– yarn.lock

# 3. åˆ é™¤æ—§æ–‡ä»¶
rm -rf node_modules package-lock.json yarn.lock

# 4. å®‰è£…ä¾èµ–
pnpm install
```

### 8.2 ä¿®å¤å¹½çµä¾èµ–

```bash
# å®‰è£…ä¼šæŠ¥é”™ï¼Œæ˜¾ç¤ºç¼ºå¤±çš„ä¾èµ–
pnpm install

# æ ¹æ®é”™è¯¯æ·»åŠ ç¼ºå¤±çš„ä¾èµ–
pnpm add missing-package
```

## ä¹ã€pnpm çš„åˆ›æ–°ä¹‹å¤„

### 9.1 è§£å†³çš„æ ¸å¿ƒé—®é¢˜

1. **ç£ç›˜ç©ºé—´æµªè´¹** â†’ å…¨å±€ store + ç¡¬é“¾æ¥
2. **å¹½çµä¾èµ–** â†’ ä¸¥æ ¼çš„ä¾èµ–éš”ç¦»
3. **å®‰è£…é€Ÿåº¦æ…¢** â†’ å¹¶è¡Œ + ç¡¬é“¾æ¥
4. **Monorepo æ€§èƒ½** â†’ workspace åè®®

### 9.2 æŠ€æœ¯äº®ç‚¹

- ğŸ¯ **å†…å®¹å¯»å€**ï¼šç›¸åŒæ–‡ä»¶åªå­˜ä¸€ä»½
- ğŸ”— **åŒé‡é“¾æ¥**ï¼šç¡¬é“¾æ¥ + ç¬¦å·é“¾æ¥
- ğŸ“¦ **ä¸¥æ ¼æ¨¡å¼**ï¼šæ²¡æœ‰å¹½çµä¾èµ–
- âš¡ **æé€Ÿæ€§èƒ½**ï¼šç¡¬é“¾æ¥ç¬é—´å®Œæˆ

## å‚è€ƒèµ„æ–™

- [pnpm å®˜æ–¹æ–‡æ¡£](https://pnpm.io/)
- [pnpm å·¥ä½œåŸç†](https://pnpm.io/motivation)
- [ä¸ºä»€ä¹ˆé€‰æ‹© pnpm](https://pnpm.io/feature-comparison)

---

**å¯¼èˆª**  
[ä¸Šä¸€ç« ï¼šYarn Berryé«˜çº§ç‰¹æ€§](./20-yarn-berry.md) | [è¿”å›ç›®å½•](../README.md) | [ä¸‹ä¸€ç« ï¼špnpmåŸºç¡€ä½¿ç”¨](./22-pnpm-basics.md)
