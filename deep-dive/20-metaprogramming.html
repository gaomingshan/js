<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…ƒç¼–ç¨‹å®è·µ - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>å…ƒç¼–ç¨‹å®è·µ</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>å…ƒç¼–ç¨‹æ˜¯æŒ‡ç¼–å†™èƒ½å¤Ÿæ“ä½œç¨‹åºæœ¬èº«çš„ä»£ç ã€‚JavaScript æä¾›äº†å¤šç§å…ƒç¼–ç¨‹ç‰¹æ€§ï¼ŒåŒ…æ‹¬ Proxyã€Reflectã€Symbolã€è£…é¥°å™¨ç­‰ã€‚æŒæ¡è¿™äº›ç‰¹æ€§å¯ä»¥åˆ›å»ºæ›´çµæ´»ã€æ›´å¼ºå¤§çš„æŠ½è±¡ã€‚</p>
            
            <h2>ä¸€ã€å…ƒç¼–ç¨‹æ¦‚å¿µ</h2>
            
            <h3>1.1 ä»€ä¹ˆæ˜¯å…ƒç¼–ç¨‹</h3>
            <div class="info">
                <p><strong>å…ƒç¼–ç¨‹ï¼ˆMetaprogrammingï¼‰</strong>ï¼šç¨‹åºå¯ä»¥å°†å…¶ä»–ç¨‹åºï¼ˆæˆ–è‡ªèº«ï¼‰ä½œä¸ºæ•°æ®æ¥å¤„ç†ã€ä¿®æ”¹æˆ–ç”Ÿæˆã€‚</p>
                <p><strong>JavaScript çš„å…ƒç¼–ç¨‹èƒ½åŠ›</strong>ï¼š</p>
                <ul>
                    <li>åŠ¨æ€å±æ€§è®¿é—®</li>
                    <li>åŸå‹é“¾æ“ä½œ</li>
                    <li>Proxy å’Œ Reflect</li>
                    <li>Symbol å®šä¹‰å†…éƒ¨è¡Œä¸º</li>
                    <li>è£…é¥°å™¨ï¼ˆææ¡ˆé˜¶æ®µï¼‰</li>
                </ul>
            </div>
            
            <h3>1.2 å…ƒç¼–ç¨‹çš„åº”ç”¨åœºæ™¯</h3>
            <pre><code>// 1. æ¡†æ¶å’Œåº“å¼€å‘
// Vueã€React ç­‰æ¡†æ¶ä½¿ç”¨ Proxy å®ç°å“åº”å¼

// 2. API å°è£…
// è‡ªåŠ¨ç”Ÿæˆ API è°ƒç”¨æ–¹æ³•

// 3. éªŒè¯å’Œå®‰å…¨
// è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥

// 4. æ—¥å¿—å’Œç›‘æ§
// è‡ªåŠ¨è®°å½•å‡½æ•°è°ƒç”¨

// 5. ORM å’Œæ•°æ®è®¿é—®
// åŠ¨æ€ç”Ÿæˆæ•°æ®åº“æŸ¥è¯¢</code></pre>
            
            <h2>äºŒã€åŠ¨æ€å±æ€§è®¿é—®</h2>
            
            <h3>2.1 è®¡ç®—å±æ€§å</h3>
            <pre><code>// ES6 è®¡ç®—å±æ€§å
const prefix = 'user_';

const obj = {
    [prefix + 'name']: 'Alice',
    [prefix + 'age']: 25,
    [`${prefix}email`]: 'alice@email.com'
};

console.log(obj.user_name);   // "Alice"
console.log(obj.user_age);    // 25
console.log(obj.user_email);  // "alice@email.com"</code></pre>
            
            <h3>2.2 åŠ¨æ€æ–¹æ³•</h3>
            <pre><code>// åŠ¨æ€åˆ›å»ºæ–¹æ³•
function createAPI(endpoints) {
    const api = {};
    
    endpoints.forEach(endpoint => {
        api[`get${capitalize(endpoint)}`] = function() {
            return fetch(`/api/${endpoint}`);
        };
        
        api[`post${capitalize(endpoint)}`] = function(data) {
            return fetch(`/api/${endpoint}`, {
                method: 'POST',
                body: JSON.stringify(data)
            });
        };
    });
    
    return api;
}

function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

// ä½¿ç”¨
const api = createAPI(['users', 'posts', 'comments']);
api.getUsers();    // GET /api/users
api.postPosts({});  // POST /api/posts</code></pre>
            
            <h2>ä¸‰ã€Proxy é«˜çº§åº”ç”¨</h2>
            
            <h3>3.1 æ‡’åŠ è½½å±æ€§</h3>
            <pre><code>// å»¶è¿ŸåŠ è½½æ˜‚è´µçš„å±æ€§
function lazyLoad(obj, props) {
    return new Proxy(obj, {
        get(target, property) {
            if (property in props && !(property in target)) {
                target[property] = props[property]();  // è®¡ç®—
            }
            return Reflect.get(target, property);
        }
    });
}

// ä½¿ç”¨
const user = lazyLoad({
    name: 'Alice'
}, {
    // åªåœ¨é¦–æ¬¡è®¿é—®æ—¶è®¡ç®—
    expensiveData() {
        console.log('è®¡ç®—æ˜‚è´µæ•°æ®...');
        return Array(1000).fill(0).map((_, i) => i);
    }
});

console.log(user.name);          // "Alice"
console.log(user.expensiveData); // è®¡ç®—æ˜‚è´µæ•°æ®... â†’ [0, 1, ...]
console.log(user.expensiveData); // ç›´æ¥è¿”å›ï¼ˆå·²ç¼“å­˜ï¼‰</code></pre>
            
            <h3>3.2 é“¾å¼è°ƒç”¨</h3>
            <pre><code>// å®ç°é“¾å¼ API
function chainable(obj) {
    return new Proxy(obj, {
        get(target, property) {
            if (typeof target[property] === 'function') {
                return function(...args) {
                    target[property].apply(target, args);
                    return this;  // è¿”å›ä»£ç†å®ç°é“¾å¼è°ƒç”¨
                };
            }
            return Reflect.get(target, property);
        }
    });
}

// ä½¿ç”¨
const logger = chainable({
    log(msg) {
        console.log(msg);
    },
    warn(msg) {
        console.warn(msg);
    },
    error(msg) {
        console.error(msg);
    }
});

logger.log('Info').warn('Warning').error('Error');</code></pre>
            
            <h3>3.3 è‡ªåŠ¨ç¼“å­˜</h3>
            <pre><code>// è‡ªåŠ¨ç¼“å­˜å‡½æ•°ç»“æœ
function memoize(fn) {
    const cache = new Map();
    
    return new Proxy(fn, {
        apply(target, thisArg, args) {
            const key = JSON.stringify(args);
            
            if (cache.has(key)) {
                console.log('ä»ç¼“å­˜è¿”å›');
                return cache.get(key);
            }
            
            console.log('è®¡ç®—ç»“æœ');
            const result = Reflect.apply(target, thisArg, args);
            cache.set(key, result);
            return result;
        }
    });
}

// ä½¿ç”¨
const fibonacci = memoize(function(n) {
    if (n <= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
});

console.log(fibonacci(10));  // è®¡ç®—
console.log(fibonacci(10));  // ä»ç¼“å­˜è¿”å›</code></pre>
            
            <h2>å››ã€Symbol å…ƒç¼–ç¨‹</h2>
            
            <h3>4.1 è‡ªå®šä¹‰è¿­ä»£å™¨</h3>
            <pre><code>// ä½¿ç”¨ Symbol.iterator è‡ªå®šä¹‰è¿­ä»£è¡Œä¸º
class Range {
    constructor(start, end) {
        this.start = start;
        this.end = end;
    }
    
    [Symbol.iterator]() {
        let current = this.start;
        const end = this.end;
        
        return {
            next() {
                if (current <= end) {
                    return { value: current++, done: false };
                }
                return { done: true };
            }
        };
    }
}

// ä½¿ç”¨
for (const num of new Range(1, 5)) {
    console.log(num);  // 1, 2, 3, 4, 5
}</code></pre>
            
            <h3>4.2 è‡ªå®šä¹‰ç±»å‹è½¬æ¢</h3>
            <pre><code>// ä½¿ç”¨ Symbol.toPrimitive æ§åˆ¶ç±»å‹è½¬æ¢
class Money {
    constructor(amount, currency) {
        this.amount = amount;
        this.currency = currency;
    }
    
    [Symbol.toPrimitive](hint) {
        if (hint === 'number') {
            return this.amount;
        }
        if (hint === 'string') {
            return `${this.currency}${this.amount}`;
        }
        return this.amount;
    }
}

const money = new Money(100, '$');

console.log(+money);           // 100ï¼ˆnumberï¼‰
console.log(String(money));    // "$100"ï¼ˆstringï¼‰
console.log(money + 50);       // 150ï¼ˆdefault â†’ numberï¼‰</code></pre>
            
            <h3>4.3 å¯¹è±¡å­—ç¬¦ä¸²è¡¨ç¤º</h3>
            <pre><code>// ä½¿ç”¨ Symbol.toStringTag è‡ªå®šä¹‰ç±»å‹å­—ç¬¦ä¸²
class Collection {
    get [Symbol.toStringTag]() {
        return 'Collection';
    }
}

const coll = new Collection();
console.log(Object.prototype.toString.call(coll));
// "[object Collection]"</code></pre>
            
            <h2>äº”ã€å‡½æ•°å¼å…ƒç¼–ç¨‹</h2>
            
            <h3>5.1 é«˜é˜¶å‡½æ•°</h3>
            <pre><code>// ä½¿ç”¨é«˜é˜¶å‡½æ•°è¿›è¡Œå…ƒç¼–ç¨‹
function trace(fn) {
    return function(...args) {
        console.log(`è°ƒç”¨ ${fn.name}(${args.join(', ')})`);
        const result = fn.apply(this, args);
        console.log(`è¿”å› ${result}`);
        return result;
    };
}

// ä½¿ç”¨
const add = trace(function add(a, b) {
    return a + b;
});

add(2, 3);
// è°ƒç”¨ add(2, 3)
// è¿”å› 5</code></pre>
            
            <h3>5.2 å‡½æ•°ç»„åˆ</h3>
            <pre><code>// åŠ¨æ€ç»„åˆå‡½æ•°
function compose(...fns) {
    return function(value) {
        return fns.reduceRight((acc, fn) => fn(acc), value);
    };
}

// ä½¿ç”¨
const double = x => x * 2;
const addOne = x => x + 1;
const square = x => x * x;

const transform = compose(square, addOne, double);

console.log(transform(3));
// 3 â†’ double â†’ 6 â†’ addOne â†’ 7 â†’ square â†’ 49</code></pre>
            
            <h2>å…­ã€å®é™…é¡¹ç›®åº”ç”¨</h2>
            
            <h3>6.1 ORM æ¨¡å‹</h3>
            <pre><code>// ç®€åŒ–çš„ ORM å®ç°
function createModel(tableName) {
    return new Proxy({}, {
        get(target, property) {
            if (property === 'find') {
                return function(id) {
                    return fetch(`/api/${tableName}/${id}`);
                };
            }
            
            if (property === 'create') {
                return function(data) {
                    return fetch(`/api/${tableName}`, {
                        method: 'POST',
                        body: JSON.stringify(data)
                    });
                };
            }
            
            if (property === 'update') {
                return function(id, data) {
                    return fetch(`/api/${tableName}/${id}`, {
                        method: 'PUT',
                        body: JSON.stringify(data)
                    });
                };
            }
            
            return Reflect.get(target, property);
        }
    });
}

// ä½¿ç”¨
const User = createModel('users');
const Post = createModel('posts');

User.find(1);
User.create({ name: 'Alice' });
Post.update(1, { title: 'New Title' });</code></pre>
            
            <h3>6.2 ç±»å‹éªŒè¯åº“</h3>
            <pre><code>// è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥
function typed(schema) {
    return function(target) {
        return new Proxy(target, {
            set(obj, property, value) {
                if (property in schema) {
                    const type = schema[property];
                    
                    if (typeof value !== type) {
                        throw new TypeError(
                            `${property} must be ${type}`
                        );
                    }
                }
                
                return Reflect.set(obj, property, value);
            }
        });
    };
}

// ä½¿ç”¨
const validator = typed({
    name: 'string',
    age: 'number',
    active: 'boolean'
});

const user = validator({});

user.name = 'Alice';   // OK
user.age = 25;         // OK
user.age = '25';       // TypeError
user.active = true;    // OK</code></pre>
            
            <h2>ä¸ƒã€æ€§èƒ½è€ƒè™‘</h2>
            
            <h3>7.1 Proxy æ€§èƒ½å¼€é”€</h3>
            <pre><code>// Proxy æœ‰æ€§èƒ½æˆæœ¬
const obj = { x: 1 };
const proxy = new Proxy(obj, {
    get(target, property) {
        return target[property];
    }
});

// æ€§èƒ½å¯¹æ¯”
console.time('Direct');
for (let i = 0; i < 1000000; i++) {
    obj.x;
}
console.timeEnd('Direct');  // ~2ms

console.time('Proxy');
for (let i = 0; i < 1000000; i++) {
    proxy.x;
}
console.timeEnd('Proxy');  // ~20msï¼ˆæ…¢10å€ï¼‰

// å»ºè®®ï¼šéæ€§èƒ½å…³é”®è·¯å¾„ä½¿ç”¨ Proxy</code></pre>
            
            <h3>7.2 ä¼˜åŒ–ç­–ç•¥</h3>
            <pre><code>// 1. ç¼“å­˜ä»£ç†
const cache = new WeakMap();

function getProxy(obj) {
    if (cache.has(obj)) {
        return cache.get(obj);
    }
    
    const proxy = new Proxy(obj, handler);
    cache.set(obj, proxy);
    return proxy;
}

// 2. æ¡ä»¶ä»£ç†
function conditionalProxy(obj, shouldProxy) {
    if (!shouldProxy) {
        return obj;  // ä¸éœ€è¦æ—¶ç›´æ¥è¿”å›åŸå¯¹è±¡
    }
    return new Proxy(obj, handler);
}

// 3. æµ…å±‚ä»£ç†
// åªä»£ç†ç¬¬ä¸€å±‚ï¼Œæ·±å±‚å¯¹è±¡ä¸ä»£ç†</code></pre>
            
            <h2>å…«ã€æœ€ä½³å®è·µ</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>æ˜ç¡®ç›®çš„</strong>ï¼šä¸è¦è¿‡åº¦ä½¿ç”¨å…ƒç¼–ç¨‹</li>
                    <li><strong>æ–‡æ¡£åŒ–</strong>ï¼šå…ƒç¼–ç¨‹ä»£ç è¦æœ‰æ¸…æ™°æ–‡æ¡£</li>
                    <li><strong>æµ‹è¯•å……åˆ†</strong>ï¼šå…ƒç¼–ç¨‹é€»è¾‘å®¹æ˜“å‡ºé”™</li>
                    <li><strong>æ€§èƒ½æ„è¯†</strong>ï¼šæ³¨æ„ Proxy çš„æ€§èƒ½å¼€é”€</li>
                    <li><strong>é”™è¯¯å¤„ç†</strong>ï¼šå…ƒç¼–ç¨‹è¦å¤„ç†è¾¹ç•Œæƒ…å†µ</li>
                    <li><strong>æ¸è¿›å¢å¼º</strong>ï¼šå¯é€‰çš„å…ƒç¼–ç¨‹ç‰¹æ€§</li>
                    <li><strong>ç±»å‹å®‰å…¨</strong>ï¼šé…åˆ TypeScript ä½¿ç”¨</li>
                </ol>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="https://tc39.es/ecma262/#sec-well-known-symbols" target="_blank">ECMAScript - Well-Known Symbols</a></li>
                <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Meta_programming" target="_blank">MDN - å…ƒç¼–ç¨‹</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="20-reflect.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šReflect åå°„</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="21-garbage-collection.html" class="nav-link next">ä¸‹ä¸€èŠ‚ï¼šåƒåœ¾å›æ”¶æœºåˆ¶</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šåŠ¨æ€ API</h3>
                <div class="code-block">
                    <pre><code>// åŠ¨æ€ç”Ÿæˆ API æ–¹æ³•
console.log('=== åŠ¨æ€ API ===\n');

function createAPI(endpoints) {
    const api = {};
    
    endpoints.forEach(endpoint => {
        const name = endpoint.charAt(0).toUpperCase() + endpoint.slice(1);
        
        api[`get${name}`] = function() {
            console.log(`  GET /api/${endpoint}`);
            return Promise.resolve({ endpoint, method: 'GET' });
        };
        
        api[`post${name}`] = function(data) {
            console.log(`  POST /api/${endpoint}`, data);
            return Promise.resolve({ endpoint, method: 'POST', data });
        };
    });
    
    return api;
}

const api = createAPI(['users', 'posts']);

console.log('å¯ç”¨æ–¹æ³•:', Object.keys(api));
console.log('\nè°ƒç”¨:');
api.getUsers();
api.postPosts({ title: 'Hello' });</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šæ‡’åŠ è½½å±æ€§</h3>
                <div class="code-block">
                    <pre><code>// å»¶è¿Ÿè®¡ç®—æ˜‚è´µå±æ€§
console.log('=== æ‡’åŠ è½½ ===\n');

function lazyLoad(obj, props) {
    return new Proxy(obj, {
        get(target, property) {
            if (property in props && !(property in target)) {
                console.log(`  è®¡ç®— ${property}...`);
                target[property] = props[property]();
            }
            return Reflect.get(target, property);
        }
    });
}

const user = lazyLoad({
    name: 'Alice'
}, {
    data() {
        return Array(5).fill(0).map((_, i) => i);
    },
    meta() {
        return { created: Date.now() };
    }
});

console.log('è®¿é—® name:', user.name);
console.log('è®¿é—® data:', user.data);
console.log('å†æ¬¡è®¿é—® data:', user.data);
console.log('è®¿é—® meta:', user.meta);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šè‡ªå®šä¹‰è¿­ä»£å™¨</h3>
                <div class="code-block">
                    <pre><code>// Symbol.iterator å…ƒç¼–ç¨‹
console.log('=== è‡ªå®šä¹‰è¿­ä»£å™¨ ===\n');

class Range {
    constructor(start, end, step = 1) {
        this.start = start;
        this.end = end;
        this.step = step;
    }
    
    [Symbol.iterator]() {
        let current = this.start;
        const end = this.end;
        const step = this.step;
        
        return {
            next() {
                if (current <= end) {
                    const value = current;
                    current += step;
                    return { value, done: false };
                }
                return { done: true };
            }
        };
    }
}

console.log('Range(1, 5):');
for (const num of new Range(1, 5)) {
    console.log('  ' + num);
}

console.log('\nRange(0, 10, 2):');
for (const num of new Range(0, 10, 2)) {
    console.log('  ' + num);
}</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼šè‡ªå®šä¹‰ç±»å‹è½¬æ¢</h3>
                <div class="code-block">
                    <pre><code>// Symbol.toPrimitive
console.log('=== ç±»å‹è½¬æ¢ ===\n');

class Money {
    constructor(amount, currency) {
        this.amount = amount;
        this.currency = currency;
    }
    
    [Symbol.toPrimitive](hint) {
        console.log(`  hint: ${hint}`);
        
        if (hint === 'number') {
            return this.amount;
        }
        if (hint === 'string') {
            return `${this.currency}${this.amount}`;
        }
        return this.amount;
    }
}

const money = new Money(100, '$');

console.log('æ•°å­—ä¸Šä¸‹æ–‡:');
console.log('  +money =', +money);

console.log('\nå­—ç¬¦ä¸²ä¸Šä¸‹æ–‡:');
console.log('  String(money) =', String(money));

console.log('\né»˜è®¤ä¸Šä¸‹æ–‡:');
console.log('  money + 50 =', money + 50);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šå‡½æ•°è¿½è¸ª</h3>
                <div class="code-block">
                    <pre><code>// é«˜é˜¶å‡½æ•°è¿½è¸ª
console.log('=== å‡½æ•°è¿½è¸ª ===\n');

function trace(fn) {
    return function(...args) {
        console.log(`â†’ ${fn.name}(${args.join(', ')})`);
        const result = fn.apply(this, args);
        console.log(`â† ${result}`);
        return result;
    };
}

// è¿½è¸ªå‡½æ•°
const add = trace(function add(a, b) {
    return a + b;
});

const multiply = trace(function multiply(a, b) {
    return a * b;
});

console.log('è°ƒç”¨å‡½æ•°:\n');
const x = add(2, 3);
const y = multiply(4, 5);
console.log('\næœ€ç»ˆ: x =', x, 'y =', y);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šç±»å‹éªŒè¯</h3>
                <div class="code-block">
                    <pre><code>// è¿è¡Œæ—¶ç±»å‹æ£€æŸ¥
console.log('=== ç±»å‹éªŒè¯ ===\n');

function typed(schema) {
    return function(obj) {
        return new Proxy(obj, {
            set(target, property, value) {
                if (property in schema) {
                    const expectedType = schema[property];
                    const actualType = typeof value;
                    
                    if (actualType !== expectedType) {
                        console.log(`  âœ— ${property}: æœŸæœ› ${expectedType}, å®é™… ${actualType}`);
                        return false;
                    }
                    
                    console.log(`  âœ“ ${property} = ${value}`);
                }
                
                target[property] = value;
                return true;
            }
        });
    };
}

const validator = typed({
    name: 'string',
    age: 'number',
    active: 'boolean'
});

const user = validator({});

user.name = 'Alice';
user.age = 25;
user.age = '25';  // å¤±è´¥
user.active = true;</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
