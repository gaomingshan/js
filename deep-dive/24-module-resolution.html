<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å—è§£æç®—æ³• - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>æ¨¡å—è§£æç®—æ³•</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>æ¨¡å—è§£æï¼ˆModule Resolutionï¼‰æ˜¯æ¨¡å—ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œå†³å®šäº†å¦‚ä½•æ‰¾åˆ°å’ŒåŠ è½½æ¨¡å—æ–‡ä»¶ã€‚ç†è§£è§£æç®—æ³•æœ‰åŠ©äºè°ƒè¯•æ¨¡å—åŠ è½½é—®é¢˜ã€‚</p>
            
            <h2>ä¸€ã€ESM æ¨¡å—è§£æ</h2>
            
            <h3>1.1 ç›¸å¯¹è·¯å¾„</h3>
            <pre><code>// ç›¸å¯¹å¯¼å…¥
import { func } from './utils.js';      // åŒç›®å½•
import { func } from '../utils.js';     // çˆ¶ç›®å½•
import { func } from './lib/utils.js';  // å­ç›®å½•

// å¿…é¡»åŒ…å«æ–‡ä»¶æ‰©å±•åï¼ˆæµè§ˆå™¨ ESMï¼‰
import { func } from './utils';  // âŒ æµè§ˆå™¨ä¸­ä¼šæŠ¥é”™

// Node.js ESM å¯ä»¥çœç•¥ .jsï¼ˆéœ€é…ç½®ï¼‰
import { func } from './utils';  // âœ“ Node.js ä¸­å¯èƒ½å·¥ä½œ</code></pre>
            
            <h3>1.2 ç»å¯¹è·¯å¾„</h3>
            <pre><code>// URL å¯¼å…¥ï¼ˆæµè§ˆå™¨ï¼‰
import { func } from 'https://cdn.example.com/module.js';
import { func } from '/static/utils.js';  // ç›¸å¯¹äºç½‘ç«™æ ¹ç›®å½•

// æ–‡ä»¶ç³»ç»Ÿè·¯å¾„ï¼ˆNode.jsï¼‰
import { func } from 'file:///path/to/module.js';</code></pre>
            
            <h3>1.3 è£¸å¯¼å…¥ï¼ˆBare Importï¼‰</h3>
            <pre><code>// åŒ…åå¯¼å…¥
import React from 'react';
import { useState } from 'react';

// Node.js è§£ææµç¨‹ï¼š
// 1. æŸ¥æ‰¾ node_modules/react
// 2. è¯»å– package.json
// 3. æ‰¾åˆ° "main" æˆ– "exports" å­—æ®µ
// 4. åŠ è½½å¯¹åº”æ–‡ä»¶</code></pre>
            
            <h2>äºŒã€Node.js è§£æç®—æ³•</h2>
            
            <h3>2.1 CommonJS è§£æ</h3>
            <pre><code>// require() è§£æè§„åˆ™
const module = require('./module');

// è§£æé¡ºåºï¼š
// 1. ./module.js
// 2. ./module.json
// 3. ./module.node
// 4. ./module/package.jsonï¼ˆ"main" å­—æ®µï¼‰
// 5. ./module/index.js
// 6. ./module/index.json
// 7. ./module/index.node

// æŸ¥æ‰¾ node_modules
const lodash = require('lodash');

// æŸ¥æ‰¾è·¯å¾„ï¼ˆä»å½“å‰ç›®å½•å‘ä¸Šï¼‰ï¼š
// ./node_modules/lodash
// ../node_modules/lodash
// ../../node_modules/lodash
// ...ç›´åˆ°æ ¹ç›®å½•</code></pre>
            
            <h3>2.2 ESM è§£æï¼ˆNode.jsï¼‰</h3>
            <pre><code>// package.json é…ç½®
{
    "type": "module",  // å¯ç”¨ ESM
    "main": "./index.js",
    "exports": {
        ".": "./index.js",
        "./utils": "./src/utils.js"
    }
}

// å¯¼å…¥
import pkg from 'my-package';           // ä½¿ç”¨ exports["."]
import { func } from 'my-package/utils'; // ä½¿ç”¨ exports["./utils"]</code></pre>
            
            <h2>ä¸‰ã€package.json å­—æ®µ</h2>
            
            <h3>3.1 main å­—æ®µ</h3>
            <pre><code>// æ—§å¼å…¥å£ç‚¹
{
    "name": "my-package",
    "main": "./index.js"
}

// require('my-package') åŠ è½½ ./index.js
// import pkg from 'my-package' ä¹ŸåŠ è½½ ./index.js</code></pre>
            
            <h3>3.2 exports å­—æ®µ</h3>
            <pre><code>// ç°ä»£å…¥å£ç‚¹ï¼ˆä¼˜å…ˆçº§é«˜äº mainï¼‰
{
    "exports": {
        ".": "./index.js",
        "./feature": "./src/feature.js",
        "./utils/*": "./src/utils/*.js"
    }
}

// æ¡ä»¶å¯¼å‡º
{
    "exports": {
        ".": {
            "import": "./esm/index.js",    // ESM
            "require": "./cjs/index.js",   // CommonJS
            "browser": "./browser/index.js", // æµè§ˆå™¨
            "default": "./index.js"
        }
    }
}</code></pre>
            
            <h3>3.3 module å­—æ®µ</h3>
            <pre><code>// æŒ‡å®š ESM å…¥å£ï¼ˆéæ ‡å‡†ï¼Œå·¥å…·æ”¯æŒï¼‰
{
    "main": "./cjs/index.js",    // CommonJS
    "module": "./esm/index.js"   // ESM
}

// æ‰“åŒ…å·¥å…·ï¼ˆWebpackã€Rollupï¼‰ä¼˜å…ˆä½¿ç”¨ module</code></pre>
            
            <h2>å››ã€å¯¼å…¥æ˜ å°„ï¼ˆImport Mapsï¼‰</h2>
            
            <h3>4.1 åŸºæœ¬ç”¨æ³•</h3>
            <pre><code><!-- HTML ä¸­å®šä¹‰å¯¼å…¥æ˜ å°„ -->
&lt;script type="importmap"&gt;
{
    "imports": {
        "react": "https://cdn.example.com/react@18.0.0/index.js",
        "lodash": "/node_modules/lodash-es/lodash.js",
        "app/": "/src/"
    }
}
&lt;/script&gt;

&lt;script type="module"&gt;
    // è£¸å¯¼å…¥ç°åœ¨å¯ä»¥å·¥ä½œ
    import React from 'react';
    import _ from 'lodash';
    import { utils } from 'app/utils.js';
&lt;/script&gt;</code></pre>
            
            <h3>4.2 Scopes</h3>
            <pre><code>&lt;script type="importmap"&gt;
{
    "imports": {
        "lodash": "/lib/lodash.js"
    },
    "scopes": {
        "/vendor/": {
            "lodash": "/vendor/lodash-custom.js"
        }
    }
}
&lt;/script&gt;

// /app.js ä½¿ç”¨ /lib/lodash.js
// /vendor/app.js ä½¿ç”¨ /vendor/lodash-custom.js</code></pre>
            
            <h2>äº”ã€å¾ªç¯ä¾èµ–</h2>
            
            <h3>5.1 ESM å¾ªç¯ä¾èµ–</h3>
            <pre><code>// a.js
import { b } from './b.js';
console.log('a:', b);
export const a = 'A';

// b.js
import { a } from './a.js';
console.log('b:', a);  // undefinedï¼ˆæ­¤æ—¶ a è¿˜æœªåˆå§‹åŒ–ï¼‰
export const b = 'B';

// ESM å¤„ç†ï¼š
// 1. è§£ææ¨¡å—å›¾
// 2. åˆ›å»ºæ¨¡å—ç¯å¢ƒ
// 3. æ‰§è¡Œæ¨¡å—ï¼ˆæŒ‰æ‹“æ‰‘é¡ºåºï¼‰
// 4. å¯¼å…¥çš„ç»‘å®šæ˜¯æ´»çš„ï¼ˆLive Bindingï¼‰</code></pre>
            
            <h3>5.2 CommonJS å¾ªç¯ä¾èµ–</h3>
            <pre><code>// a.js
const b = require('./b.js');
console.log('a:', b);
exports.a = 'A';

// b.js
const a = require('./a.js');
console.log('b:', a);  // { a: undefined }ï¼ˆéƒ¨åˆ†å¯¼å‡ºï¼‰
exports.b = 'B';

// CommonJS å¤„ç†ï¼š
// 1. ç¼“å­˜æœªå®Œæˆçš„ exports
// 2. ç»§ç»­æ‰§è¡Œ
// 3. å¯èƒ½å¾—åˆ°éƒ¨åˆ†å¯¼å‡º</code></pre>
            
            <h2>å…­ã€æ€§èƒ½ä¼˜åŒ–</h2>
            
            <h3>6.1 é¢„åŠ è½½</h3>
            <pre><code><!-- é¢„åŠ è½½æ¨¡å— -->
&lt;link rel="modulepreload" href="./critical-module.js"&gt;

<!-- é¢„è¿æ¥åˆ° CDN -->
&lt;link rel="preconnect" href="https://cdn.example.com"&gt;</code></pre>
            
            <h3>6.2 åŠ¨æ€å¯¼å…¥</h3>
            <pre><code>// æŒ‰éœ€åŠ è½½
button.addEventListener('click', async () => {
    const { feature } = await import('./feature.js');
    feature();
});

// æ¡ä»¶åŠ è½½
if (condition) {
    const module = await import('./optional.js');
}

// å¹¶è¡ŒåŠ è½½
const [moduleA, moduleB] = await Promise.all([
    import('./a.js'),
    import('./b.js')
]);</code></pre>
            
            <h2>ä¸ƒã€æœ€ä½³å®è·µ</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>ä½¿ç”¨ exports å­—æ®µ</strong>ï¼šæ˜ç¡®å¯¼å‡ºè·¯å¾„</li>
                    <li><strong>é¿å…å¾ªç¯ä¾èµ–</strong>ï¼šé‡æ„ä»£ç ç»“æ„</li>
                    <li><strong>ä½¿ç”¨ç»å¯¹å¯¼å…¥</strong>ï¼šé…ç½®è·¯å¾„åˆ«å</li>
                    <li><strong>é¢„åŠ è½½å…³é”®æ¨¡å—</strong>ï¼šæå‡æ€§èƒ½</li>
                    <li><strong>åŠ¨æ€å¯¼å…¥</strong>ï¼šå‡å°‘åˆå§‹åŒ…å¤§å°</li>
                </ol>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="https://nodejs.org/api/esm.html" target="_blank">Node.js - ECMAScript Modules</a></li>
                <li><a href="https://github.com/WICG/import-maps" target="_blank">Import Maps Specification</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="23-optional-chaining.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šå¯é€‰é“¾ä¸ç©ºå€¼åˆå¹¶</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="24-module-graph.html" class="nav-link next">ä¸‹ä¸€èŠ‚ï¼šæ¨¡å—ä¾èµ–å›¾</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šæ¨¡å—è·¯å¾„è§£æ</h3>
                <div class="code-block">
                    <pre><code>// æ¨¡å—è·¯å¾„ç±»å‹æ¼”ç¤º
console.log('=== æ¨¡å—è·¯å¾„ ===\n');

console.log('1. ç›¸å¯¹è·¯å¾„:');
console.log('  import { x } from "./module.js"');
console.log('  import { y } from "../parent.js"');

console.log('\n2. ç»å¯¹è·¯å¾„:');
console.log('  import { x } from "/root/module.js"');
console.log('  import { x } from "https://cdn.com/lib.js"');

console.log('\n3. è£¸å¯¼å…¥:');
console.log('  import React from "react"');
console.log('  import _ from "lodash"');

console.log('\næ³¨æ„: æµè§ˆå™¨ ESM éœ€è¦å®Œæ•´æ‰©å±•å');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šå¾ªç¯ä¾èµ–æ¨¡æ‹Ÿ</h3>
                <div class="code-block">
                    <pre><code>// å¾ªç¯ä¾èµ–çš„é—®é¢˜
console.log('=== å¾ªç¯ä¾èµ– ===\n');

console.log('CommonJS å¾ªç¯ä¾èµ–:');
console.log('// a.js');
console.log('const b = require("./b");');
console.log('exports.a = "A";');
console.log('');
console.log('// b.js');
console.log('const a = require("./a");');
console.log('// a æ­¤æ—¶æ˜¯ { a: undefined }');
console.log('exports.b = "B";');

console.log('\nESM å¾ªç¯ä¾èµ–:');
console.log('// ESM ä½¿ç”¨ Live Binding');
console.log('// ä½†è®¿é—®æœªåˆå§‹åŒ–çš„å€¼ä¼šæŠ¥é”™');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šåŠ¨æ€å¯¼å…¥</h3>
                <div class="code-block">
                    <pre><code>// åŠ¨æ€å¯¼å…¥ç¤ºä¾‹ï¼ˆæ¨¡æ‹Ÿï¼‰
console.log('=== åŠ¨æ€å¯¼å…¥ ===\n');

async function loadModule(name) {
    console.log(`åŠ è½½æ¨¡å—: ${name}`);
    
    // æ¨¡æ‹Ÿå¼‚æ­¥åŠ è½½
    await new Promise(resolve => setTimeout(resolve, 100));
    
    return {
        name,
        version: '1.0.0',
        loaded: true
    };
}

console.log('æŒ‰éœ€åŠ è½½:');
loadModule('feature-a').then(module => {
    console.log('  å·²åŠ è½½:', module.name);
});

console.log('\nå¹¶è¡ŒåŠ è½½:');
Promise.all([
    loadModule('module-1'),
    loadModule('module-2')
]).then(modules => {
    console.log('  å…¨éƒ¨åŠ è½½å®Œæˆ');
});</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼špackage.json å­—æ®µ</h3>
                <div class="code-block">
                    <pre><code>// package.json é…ç½®ç¤ºä¾‹
console.log('=== package.json ===\n');

const packageConfig = {
    name: 'my-package',
    version: '1.0.0',
    main: './index.js',
    module: './esm/index.js',
    exports: {
        '.': {
            import: './esm/index.js',
            require: './cjs/index.js'
        },
        './utils': './src/utils.js'
    }
};

console.log('é…ç½®:');
console.log(JSON.stringify(packageConfig, null, 2));

console.log('\nè§£æ:');
console.log('  require("my-package") -> cjs/index.js');
console.log('  import pkg from "my-package" -> esm/index.js');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šè·¯å¾„è§£æä¼˜å…ˆçº§</h3>
                <div class="code-block">
                    <pre><code>// require() è§£æé¡ºåº
console.log('=== è§£æé¡ºåº ===\n');

console.log('require("./module"):');
console.log('  1. ./module.js');
console.log('  2. ./module.json');
console.log('  3. ./module.node');
console.log('  4. ./module/package.json (main)');
console.log('  5. ./module/index.js');

console.log('\nrequire("lodash"):');
console.log('  æŸ¥æ‰¾ node_modules:');
console.log('  1. ./node_modules/lodash');
console.log('  2. ../node_modules/lodash');
console.log('  3. ../../node_modules/lodash');
console.log('  4. ... ç›´åˆ°æ ¹ç›®å½•');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šæ¡ä»¶å¯¼å‡º</h3>
                <div class="code-block">
                    <pre><code>// æ¡ä»¶å¯¼å‡ºé…ç½®
console.log('=== æ¡ä»¶å¯¼å‡º ===\n');

const conditionalExports = {
    exports: {
        '.': {
            import: './esm/index.js',
            require: './cjs/index.js',
            browser: './browser/index.js',
            node: './node/index.js',
            default: './index.js'
        }
    }
};

console.log('é…ç½®:');
console.log(JSON.stringify(conditionalExports, null, 2));

console.log('\næ ¹æ®ç¯å¢ƒé€‰æ‹©:');
console.log('  Node.js ESM -> esm/index.js');
console.log('  Node.js CJS -> cjs/index.js');
console.log('  Browser -> browser/index.js');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
