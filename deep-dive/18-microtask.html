<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä»»åŠ¡é˜Ÿåˆ—æœºåˆ¶ - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>å¾®ä»»åŠ¡é˜Ÿåˆ—æœºåˆ¶</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>å¾®ä»»åŠ¡ï¼ˆMicrotaskï¼‰æ˜¯äº‹ä»¶å¾ªç¯ä¸­çš„é‡è¦æ¦‚å¿µï¼ŒPromise çš„å›è°ƒå°±æ˜¯é€šè¿‡å¾®ä»»åŠ¡é˜Ÿåˆ—æ‰§è¡Œçš„ã€‚ç†è§£å¾®ä»»åŠ¡æœºåˆ¶æ˜¯æŒæ¡å¼‚æ­¥æ‰§è¡Œé¡ºåºçš„å…³é”®ã€‚</p>
            
            <h2>ä¸€ã€ä»»åŠ¡åˆ†ç±»</h2>
            
            <h3>1.1 å®ä»»åŠ¡ vs å¾®ä»»åŠ¡</h3>
            <div class="info">
                <p><strong>å®ä»»åŠ¡ï¼ˆMacro Taskï¼‰</strong>ï¼š</p>
                <ul>
                    <li>setTimeout / setInterval</li>
                    <li>setImmediateï¼ˆNode.jsï¼‰</li>
                    <li>I/O æ“ä½œ</li>
                    <li>UI æ¸²æŸ“</li>
                    <li>scriptï¼ˆæ•´ä½“ä»£ç ï¼‰</li>
                </ul>
                
                <p><strong>å¾®ä»»åŠ¡ï¼ˆMicro Taskï¼‰</strong>ï¼š</p>
                <ul>
                    <li>Promise.then / catch / finally</li>
                    <li>queueMicrotask()</li>
                    <li>MutationObserver</li>
                    <li>process.nextTickï¼ˆNode.jsï¼Œä¼˜å…ˆçº§æ›´é«˜ï¼‰</li>
                </ul>
            </div>
            
            <h3>1.2 æ‰§è¡Œé¡ºåº</h3>
            <pre><code>// æ‰§è¡Œé¡ºåºç¤ºä¾‹
console.log('1: script start');

setTimeout(() => {
    console.log('2: setTimeout');
}, 0);

Promise.resolve().then(() => {
    console.log('3: promise1');
}).then(() => {
    console.log('4: promise2');
});

console.log('5: script end');

// è¾“å‡ºé¡ºåºï¼š
// 1: script start
// 5: script end
// 3: promise1
// 4: promise2
// 2: setTimeout</code></pre>
            
            <h2>äºŒã€äº‹ä»¶å¾ªç¯æœºåˆ¶</h2>
            
            <h3>2.1 æ‰§è¡Œæµç¨‹</h3>
            <pre><code>// äº‹ä»¶å¾ªç¯ä¼ªä»£ç 
while (true) {
    // 1. æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼ˆæ ˆä¸­æ²¡æœ‰å°±ä»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–ï¼‰
    task = macroTaskQueue.shift();
    execute(task);
    
    // 2. æ‰§è¡Œæ‰€æœ‰å¾®ä»»åŠ¡
    while (microTaskQueue.length > 0) {
        microTask = microTaskQueue.shift();
        execute(microTask);
    }
    
    // 3. æ¸²æŸ“ï¼ˆå¦‚æœéœ€è¦ï¼‰
    if (shouldRender()) {
        render();
    }
    
    // 4. ç»§ç»­ä¸‹ä¸€ä¸ªå®ä»»åŠ¡
}</code></pre>
            
            <h3>2.2 å…³é”®ç‚¹</h3>
            <div class="info">
                <ul>
                    <li><strong>å¾®ä»»åŠ¡ä¼˜å…ˆ</strong>ï¼šæ¯ä¸ªå®ä»»åŠ¡åæ‰§è¡Œæ‰€æœ‰å¾®ä»»åŠ¡</li>
                    <li><strong>æ¸…ç©ºé˜Ÿåˆ—</strong>ï¼šå¾®ä»»åŠ¡é˜Ÿåˆ—å¿…é¡»æ¸…ç©ºæ‰èƒ½æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡</li>
                    <li><strong>å¾®ä»»åŠ¡äº§ç”Ÿå¾®ä»»åŠ¡</strong>ï¼šæ–°çš„å¾®ä»»åŠ¡ä¼šåœ¨å½“å‰é˜Ÿåˆ—æ‰§è¡Œå®Œå‰åŠ å…¥</li>
                </ul>
            </div>
            
            <h2>ä¸‰ã€å¾®ä»»åŠ¡åˆ›å»ºæ–¹å¼</h2>
            
            <h3>3.1 Promise</h3>
            <pre><code>// Promise å›è°ƒæ˜¯å¾®ä»»åŠ¡
Promise.resolve().then(() => {
    console.log('å¾®ä»»åŠ¡1');
});

Promise.resolve().then(() => {
    console.log('å¾®ä»»åŠ¡2');
});

console.log('åŒæ­¥ä»£ç ');

// è¾“å‡ºï¼šåŒæ­¥ä»£ç  â†’ å¾®ä»»åŠ¡1 â†’ å¾®ä»»åŠ¡2</code></pre>
            
            <h3>3.2 queueMicrotask</h3>
            <pre><code>// ES2020 æ ‡å‡† API
queueMicrotask(() => {
    console.log('å¾®ä»»åŠ¡');
});

console.log('åŒæ­¥ä»£ç ');

// è¾“å‡ºï¼šåŒæ­¥ä»£ç  â†’ å¾®ä»»åŠ¡</code></pre>
            
            <h3>3.3 async/await</h3>
            <pre><code>// async/await åŸºäº Promiseï¼Œä¹Ÿæ˜¯å¾®ä»»åŠ¡
async function test() {
    console.log('1');
    await Promise.resolve();
    console.log('2');  // å¾®ä»»åŠ¡
}

test();
console.log('3');

// è¾“å‡ºï¼š1 â†’ 3 â†’ 2</code></pre>
            
            <h3>3.4 MutationObserver</h3>
            <pre><code>// MutationObserver å›è°ƒæ˜¯å¾®ä»»åŠ¡
const observer = new MutationObserver(() => {
    console.log('DOM å˜åŒ–');
});

observer.observe(document.body, {
    attributes: true
});

document.body.setAttribute('data-test', 'value');
console.log('åŒæ­¥ä»£ç ');

// è¾“å‡ºï¼šåŒæ­¥ä»£ç  â†’ DOM å˜åŒ–</code></pre>
            
            <h2>å››ã€æ‰§è¡Œé¡ºåºè¯¦è§£</h2>
            
            <h3>4.1 æ··åˆç¤ºä¾‹</h3>
            <pre><code>console.log('1');

setTimeout(() => {
    console.log('2');
    Promise.resolve().then(() => {
        console.log('3');
    });
}, 0);

Promise.resolve().then(() => {
    console.log('4');
    setTimeout(() => {
        console.log('5');
    }, 0);
});

console.log('6');

// åˆ†æï¼š
// åŒæ­¥ï¼š1, 6
// ç¬¬ä¸€è½®å¾®ä»»åŠ¡ï¼š4
// ç¬¬ä¸€ä¸ªå®ä»»åŠ¡ï¼š2
// ç¬¬äºŒè½®å¾®ä»»åŠ¡ï¼š3
// ç¬¬äºŒä¸ªå®ä»»åŠ¡ï¼š5

// è¾“å‡ºï¼š1 â†’ 6 â†’ 4 â†’ 2 â†’ 3 â†’ 5</code></pre>
            
            <h3>4.2 async/await æ‰§è¡Œé¡ºåº</h3>
            <pre><code>async function async1() {
    console.log('async1 start');
    await async2();
    console.log('async1 end');
}

async function async2() {
    console.log('async2');
}

console.log('script start');

setTimeout(() => {
    console.log('setTimeout');
}, 0);

async1();

new Promise(resolve => {
    console.log('promise1');
    resolve();
}).then(() => {
    console.log('promise2');
});

console.log('script end');

// è¾“å‡ºï¼š
// script start
// async1 start
// async2
// promise1
// script end
// async1 end
// promise2
// setTimeout</code></pre>
            
            <h3>4.3 å¾®ä»»åŠ¡åµŒå¥—</h3>
            <pre><code>// å¾®ä»»åŠ¡ä¸­äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡
Promise.resolve().then(() => {
    console.log('then1');
    
    Promise.resolve().then(() => {
        console.log('then2');
    }).then(() => {
        console.log('then3');
    });
}).then(() => {
    console.log('then4');
});

// è¾“å‡ºï¼šthen1 â†’ then2 â†’ then4 â†’ then3

// è§£é‡Šï¼š
// 1. then1 æ‰§è¡Œï¼Œäº§ç”Ÿ then2 å’Œ then4
// 2. then2 æ‰§è¡Œï¼Œäº§ç”Ÿ then3
// 3. then4 æ‰§è¡Œ
// 4. then3 æ‰§è¡Œ</code></pre>
            
            <h2>äº”ã€å¸¸è§é™·é˜±</h2>
            
            <h3>5.1 å¾®ä»»åŠ¡é˜Ÿåˆ—é˜»å¡</h3>
            <pre><code>// æ— é™äº§ç”Ÿå¾®ä»»åŠ¡ä¼šé˜»å¡å®ä»»åŠ¡
function recursiveMicrotask() {
    Promise.resolve().then(() => {
        console.log('å¾®ä»»åŠ¡');
        recursiveMicrotask();  // æŒç»­äº§ç”Ÿå¾®ä»»åŠ¡
    });
}

setTimeout(() => {
    console.log('è¿™ä¸ªå¯èƒ½æ°¸è¿œä¸ä¼šæ‰§è¡Œ');
}, 0);

// recursiveMicrotask();  // å–æ¶ˆæ³¨é‡Šä¼šå¯¼è‡´é˜»å¡

// æ³¨æ„ï¼šå¾®ä»»åŠ¡é˜Ÿåˆ—å¿…é¡»æ¸…ç©ºæ‰èƒ½æ‰§è¡Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡</code></pre>
            
            <h3>5.2 Promise æ„é€ å‡½æ•°åŒæ­¥</h3>
            <pre><code>// Promise æ„é€ å‡½æ•°æ˜¯åŒæ­¥æ‰§è¡Œçš„
console.log('1');

new Promise((resolve) => {
    console.log('2');  // åŒæ­¥æ‰§è¡Œ
    resolve();
}).then(() => {
    console.log('3');  // å¾®ä»»åŠ¡
});

console.log('4');

// è¾“å‡ºï¼š1 â†’ 2 â†’ 4 â†’ 3</code></pre>
            
            <h3>5.3 await çš„è½¬æ¢</h3>
            <pre><code>// await åçš„ä»£ç ç›¸å½“äº .then()
async function test() {
    console.log('1');
    await Promise.resolve();
    console.log('2');
}

// ç­‰ä»·äºï¼š
function testEquivalent() {
    console.log('1');
    Promise.resolve().then(() => {
        console.log('2');
    });
}

test();
console.log('3');

// è¾“å‡ºï¼š1 â†’ 3 â†’ 2</code></pre>
            
            <h2>å…­ã€Node.js ç‰¹æ®Šæ€§</h2>
            
            <h3>6.1 process.nextTick</h3>
            <pre><code>// Node.js ä¸­ nextTick ä¼˜å…ˆçº§æœ€é«˜
Promise.resolve().then(() => {
    console.log('promise');
});

process.nextTick(() => {
    console.log('nextTick');
});

console.log('sync');

// è¾“å‡ºï¼šsync â†’ nextTick â†’ promise

// nextTick åœ¨å¾®ä»»åŠ¡ä¹‹å‰æ‰§è¡Œ</code></pre>
            
            <h3>6.2 setImmediate</h3>
            <pre><code>// setImmediate vs setTimeout
setTimeout(() => {
    console.log('setTimeout');
}, 0);

setImmediate(() => {
    console.log('setImmediate');
});

// è¾“å‡ºé¡ºåºä¸ç¡®å®šï¼ˆå–å†³äºäº‹ä»¶å¾ªç¯é˜¶æ®µï¼‰

// ä½†åœ¨ I/O å›è°ƒä¸­ï¼š
const fs = require('fs');
fs.readFile('file.txt', () => {
    setTimeout(() => console.log('setTimeout'), 0);
    setImmediate(() => console.log('setImmediate'));
});

// è¾“å‡ºï¼šsetImmediate â†’ setTimeout
// å› ä¸º setImmediate åœ¨ check é˜¶æ®µï¼Œç´§è·Ÿ I/O å›è°ƒ</code></pre>
            
            <h2>ä¸ƒã€å®é™…åº”ç”¨</h2>
            
            <h3>7.1 æ‰¹é‡æ›´æ–°</h3>
            <pre><code>// ä½¿ç”¨å¾®ä»»åŠ¡å®ç°æ‰¹é‡æ›´æ–°
class BatchUpdater {
    constructor() {
        this.pending = false;
        this.callbacks = [];
    }
    
    update(callback) {
        this.callbacks.push(callback);
        
        if (!this.pending) {
            this.pending = true;
            queueMicrotask(() => {
                this.flush();
            });
        }
    }
    
    flush() {
        const callbacks = this.callbacks.slice();
        this.callbacks = [];
        this.pending = false;
        
        callbacks.forEach(cb => cb());
    }
}

// ä½¿ç”¨
const updater = new BatchUpdater();
updater.update(() => console.log('Update 1'));
updater.update(() => console.log('Update 2'));
updater.update(() => console.log('Update 3'));

// æ‰€æœ‰æ›´æ–°åœ¨ä¸€ä¸ªå¾®ä»»åŠ¡ä¸­æ‰¹é‡æ‰§è¡Œ</code></pre>
            
            <h3>7.2 ä¼˜å…ˆçº§ä»»åŠ¡</h3>
            <pre><code>// ä½¿ç”¨å¾®ä»»åŠ¡å®ç°é«˜ä¼˜å…ˆçº§ä»»åŠ¡
function highPriority(callback) {
    queueMicrotask(callback);
}

function lowPriority(callback) {
    setTimeout(callback, 0);
}

highPriority(() => console.log('High'));
lowPriority(() => console.log('Low'));

// è¾“å‡ºï¼šHigh â†’ Low</code></pre>
            
            <h2>å…«ã€æœ€ä½³å®è·µ</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>ç†è§£æ‰§è¡Œé¡ºåº</strong>ï¼šæŒæ¡å®ä»»åŠ¡å’Œå¾®ä»»åŠ¡çš„åŒºåˆ«</li>
                    <li><strong>é¿å…é˜»å¡</strong>ï¼šä¸è¦æ— é™äº§ç”Ÿå¾®ä»»åŠ¡</li>
                    <li><strong>ä½¿ç”¨ queueMicrotask</strong>ï¼šéœ€è¦å¾®ä»»åŠ¡æ—¶çš„æ ‡å‡†æ–¹å¼</li>
                    <li><strong>æ³¨æ„ async/await</strong>ï¼šawait åæ˜¯å¾®ä»»åŠ¡</li>
                    <li><strong>è°ƒè¯•æŠ€å·§</strong>ï¼šä½¿ç”¨ console.log è¿½è¸ªæ‰§è¡Œé¡ºåº</li>
                    <li><strong>æ€§èƒ½è€ƒè™‘</strong>ï¼šå¾®ä»»åŠ¡è¿‡å¤šå½±å“æ¸²æŸ“</li>
                </ol>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="https://html.spec.whatwg.org/multipage/webappapis.html#microtask-queue" target="_blank">HTML Standard - Microtask Queue</a></li>
                <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide" target="_blank">MDN - å¾®ä»»åŠ¡æŒ‡å—</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="18-thenable.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šThenable åè®®</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="19-event-loop-spec.html" class="nav-link next">ä¸‹ä¸€èŠ‚ï¼šäº‹ä»¶å¾ªç¯è§„èŒƒ</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šå®ä»»åŠ¡ vs å¾®ä»»åŠ¡</h3>
                <div class="code-block">
                    <pre><code>// æ‰§è¡Œé¡ºåºæ¼”ç¤º
console.log('=== å®ä»»åŠ¡ vs å¾®ä»»åŠ¡ ===\n');

console.log('1: åŒæ­¥ä»£ç å¼€å§‹');

setTimeout(() => {
    console.log('2: setTimeoutï¼ˆå®ä»»åŠ¡ï¼‰');
}, 0);

Promise.resolve().then(() => {
    console.log('3: Promise.thenï¼ˆå¾®ä»»åŠ¡ï¼‰');
});

console.log('4: åŒæ­¥ä»£ç ç»“æŸ');

console.log('\næ‰§è¡Œé¡ºåº:');
console.log('  åŒæ­¥ â†’ å¾®ä»»åŠ¡ â†’ å®ä»»åŠ¡');

setTimeout(() => {
    console.log('\nè¯´æ˜:');
    console.log('  - åŒæ­¥ä»£ç æœ€å…ˆæ‰§è¡Œ');
    console.log('  - å¾®ä»»åŠ¡åœ¨å®ä»»åŠ¡ä¹‹å‰');
}, 100);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šå¤æ‚æ‰§è¡Œé¡ºåº</h3>
                <div class="code-block">
                    <pre><code>// æ··åˆå®ä»»åŠ¡å’Œå¾®ä»»åŠ¡
console.log('=== å¤æ‚æ‰§è¡Œé¡ºåº ===\n');

console.log('1');

setTimeout(() => {
    console.log('2: setTimeout1');
    Promise.resolve().then(() => {
        console.log('3: promise in setTimeout');
    });
}, 0);

Promise.resolve().then(() => {
    console.log('4: promise1');
    setTimeout(() => {
        console.log('5: setTimeout in promise');
    }, 0);
});

console.log('6');

setTimeout(() => {
    console.log('\nåˆ†æ:');
    console.log('  1,6: åŒæ­¥ä»£ç ');
    console.log('  4: ç¬¬ä¸€è½®å¾®ä»»åŠ¡');
    console.log('  2: ç¬¬ä¸€ä¸ªå®ä»»åŠ¡');
    console.log('  3: ç¬¬äºŒè½®å¾®ä»»åŠ¡');
    console.log('  5: ç¬¬äºŒä¸ªå®ä»»åŠ¡');
}, 200);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šasync/await æ‰§è¡Œ</h3>
                <div class="code-block">
                    <pre><code>// async/await ä¸å¾®ä»»åŠ¡
console.log('=== async/await ===\n');

async function async1() {
    console.log('async1 start');
    await async2();
    console.log('async1 end');
}

async function async2() {
    console.log('async2');
}

console.log('script start');

setTimeout(() => {
    console.log('setTimeout');
}, 0);

async1();

new Promise(resolve => {
    console.log('promise1');
    resolve();
}).then(() => {
    console.log('promise2');
});

console.log('script end');

setTimeout(() => {
    console.log('\nè¯´æ˜:');
    console.log('  await åçš„ä»£ç  = .then()');
    console.log('  async1 end å’Œ promise2 éƒ½æ˜¯å¾®ä»»åŠ¡');
}, 100);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼šå¾®ä»»åŠ¡åµŒå¥—</h3>
                <div class="code-block">
                    <pre><code>// å¾®ä»»åŠ¡äº§ç”Ÿæ–°çš„å¾®ä»»åŠ¡
console.log('=== å¾®ä»»åŠ¡åµŒå¥— ===\n');

Promise.resolve().then(() => {
    console.log('then1');
    
    Promise.resolve().then(() => {
        console.log('then2');
    }).then(() => {
        console.log('then3');
    });
}).then(() => {
    console.log('then4');
});

Promise.resolve().then(() => {
    console.log('then5');
});

setTimeout(() => {
    console.log('\næ‰§è¡Œé¡ºåºåˆ†æ:');
    console.log('  ç¬¬1è½®: then1, then5');
    console.log('  ç¬¬2è½®: then2, then4');
    console.log('  ç¬¬3è½®: then3');
}, 100);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šPromise æ„é€ å‡½æ•°</h3>
                <div class="code-block">
                    <pre><code>// Promise æ„é€ å‡½æ•°æ˜¯åŒæ­¥çš„
console.log('=== Promise æ„é€ å‡½æ•° ===\n');

console.log('1');

new Promise((resolve) => {
    console.log('2: Promise æ„é€ å‡½æ•°ï¼ˆåŒæ­¥ï¼‰');
    resolve();
    console.log('3: resolve åï¼ˆåŒæ­¥ï¼‰');
}).then(() => {
    console.log('4: then å›è°ƒï¼ˆå¾®ä»»åŠ¡ï¼‰');
});

console.log('5');

setTimeout(() => {
    console.log('\nè¯´æ˜:');
    console.log('  æ„é€ å‡½æ•°é‡Œçš„ä»£ç æ˜¯åŒæ­¥æ‰§è¡Œçš„');
    console.log('  åªæœ‰ then å›è°ƒæ‰æ˜¯å¾®ä»»åŠ¡');
}, 50);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šqueueMicrotask</h3>
                <div class="code-block">
                    <pre><code>// queueMicrotask API
console.log('=== queueMicrotask ===\n');

console.log('1: åŒæ­¥å¼€å§‹');

queueMicrotask(() => {
    console.log('2: queueMicrotask 1');
});

Promise.resolve().then(() => {
    console.log('3: Promise.then');
});

queueMicrotask(() => {
    console.log('4: queueMicrotask 2');
});

console.log('5: åŒæ­¥ç»“æŸ');

setTimeout(() => {
    console.log('\nè¯´æ˜:');
    console.log('  queueMicrotask å’Œ Promise.then åŒçº§');
    console.log('  éƒ½æ˜¯å¾®ä»»åŠ¡ï¼ŒæŒ‰æ·»åŠ é¡ºåºæ‰§è¡Œ');
}, 50);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
