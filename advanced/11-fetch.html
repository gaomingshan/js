<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç½‘ç»œè¯·æ±‚ï¼ˆFetch APIï¼‰ - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>ç½‘ç»œè¯·æ±‚ï¼ˆFetch APIï¼‰</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>Fetch API æ˜¯ç°ä»£æµè§ˆå™¨æä¾›çš„ç½‘ç»œè¯·æ±‚æ¥å£ï¼ŒåŸºäº Promiseï¼Œæ›¿ä»£ä¼ ç»Ÿçš„ XMLHttpRequestã€‚</p>
            
            <h2>ä¸€ã€åŸºæœ¬ä½¿ç”¨</h2>
            
            <h3>1.1 GET è¯·æ±‚</h3>
            <pre><code>// åŸºæœ¬ GET è¯·æ±‚
fetch('https://api.example.com/data')
    .then(response => response.json())
    .then(data => console.log(data))
    .catch(error => console.error('Error:', error));

// ä½¿ç”¨ async/await
async function fetchData() {
    try {
        const response = await fetch('https://api.example.com/data');
        const data = await response.json();
        console.log(data);
    } catch (error) {
        console.error('Error:', error);
    }
}</code></pre>
            
            <h3>1.2 POST è¯·æ±‚</h3>
            <pre><code>fetch('https://api.example.com/users', {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json'
    },
    body: JSON.stringify({
        name: 'Alice',
        age: 25
    })
})
.then(response => response.json())
.then(data => console.log(data));</code></pre>
            
            <h2>äºŒã€Request é…ç½®</h2>
            
            <h3>2.1 è¯·æ±‚æ–¹æ³•</h3>
            <pre><code>// GET
fetch(url);
fetch(url, { method: 'GET' });

// POST
fetch(url, { method: 'POST', body: data });

// PUT
fetch(url, { method: 'PUT', body: data });

// DELETE
fetch(url, { method: 'DELETE' });

// PATCH
fetch(url, { method: 'PATCH', body: data });</code></pre>
            
            <h3>2.2 è¯·æ±‚å¤´</h3>
            <pre><code>fetch(url, {
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer token',
        'Accept': 'application/json'
    }
});</code></pre>
            
            <h3>2.3 è¯·æ±‚ä½“</h3>
            <pre><code>// JSON
fetch(url, {
    method: 'POST',
    body: JSON.stringify({ key: 'value' })
});

// FormData
const formData = new FormData();
formData.append('file', fileInput.files[0]);
fetch(url, {
    method: 'POST',
    body: formData
});

// URLSearchParams
const params = new URLSearchParams();
params.append('key', 'value');
fetch(url, {
    method: 'POST',
    body: params
});</code></pre>
            
            <h3>2.4 å…¶ä»–é…ç½®</h3>
            <pre><code>fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data),
    
    // å‡­è¯ï¼ˆCookieï¼‰
    credentials: 'include',  // 'omit', 'same-origin', 'include'
    
    // ç¼“å­˜
    cache: 'no-cache',  // 'default', 'no-cache', 'reload', 'force-cache'
    
    // é‡å®šå‘
    redirect: 'follow',  // 'follow', 'error', 'manual'
    
    // Referrer
    referrerPolicy: 'no-referrer'
});</code></pre>
            
            <h2>ä¸‰ã€Response å¯¹è±¡</h2>
            
            <h3>3.1 çŠ¶æ€ä¿¡æ¯</h3>
            <pre><code>const response = await fetch(url);

response.ok;         // çŠ¶æ€ç  200-299 ä¸º true
response.status;     // çŠ¶æ€ç ï¼ˆ200, 404 ç­‰ï¼‰
response.statusText; // çŠ¶æ€æ–‡æœ¬ï¼ˆ'OK', 'Not Found' ç­‰ï¼‰
response.headers;    // Headers å¯¹è±¡
response.url;        // æœ€ç»ˆ URLï¼ˆå¯èƒ½ç»è¿‡é‡å®šå‘ï¼‰</code></pre>
            
            <h3>3.2 è¯»å–å“åº”ä½“</h3>
            <pre><code>// JSON
const data = await response.json();

// æ–‡æœ¬
const text = await response.text();

// Blob
const blob = await response.blob();

// ArrayBuffer
const buffer = await response.arrayBuffer();

// FormData
const formData = await response.formData();</code></pre>
            
            <div class="warning">
                <strong>æ³¨æ„ï¼š</strong>å“åº”ä½“åªèƒ½è¯»å–ä¸€æ¬¡ï¼Œå†æ¬¡è¯»å–ä¼šæŠ¥é”™ã€‚
            </div>
            
            <h3>3.3 Headers æ“ä½œ</h3>
            <pre><code>// è¯»å–å“åº”å¤´
const contentType = response.headers.get('Content-Type');

// æ£€æŸ¥æ˜¯å¦å­˜åœ¨
response.headers.has('Content-Type');

// éå†
for (const [key, value] of response.headers) {
    console.log(key, value);
}

// è®¾ç½®è¯·æ±‚å¤´
const headers = new Headers();
headers.append('Content-Type', 'application/json');
headers.set('Authorization', 'Bearer token');
headers.delete('X-Custom');</code></pre>
            
            <h2>å››ã€é”™è¯¯å¤„ç†</h2>
            
            <h3>4.1 ç½‘ç»œé”™è¯¯</h3>
            <pre><code>fetch(url)
    .then(response => {
        // fetch åªåœ¨ç½‘ç»œé”™è¯¯æ—¶ reject
        // HTTP é”™è¯¯çŠ¶æ€ç ä¸ä¼š reject
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .catch(error => {
        console.error('Fetch error:', error);
    });</code></pre>
            
            <h3>4.2 å®Œæ•´é”™è¯¯å¤„ç†</h3>
            <pre><code>async function fetchWithErrorHandling(url, options = {}) {
    try {
        const response = await fetch(url, options);
        
        if (!response.ok) {
            const error = new Error(`HTTP Error: ${response.status}`);
            error.response = response;
            throw error;
        }
        
        return await response.json();
    } catch (error) {
        if (error.name === 'TypeError') {
            // ç½‘ç»œé”™è¯¯
            console.error('Network error:', error);
        } else {
            // HTTP é”™è¯¯
            console.error('HTTP error:', error);
        }
        throw error;
    }
}</code></pre>
            
            <h2>äº”ã€è¶…æ—¶æ§åˆ¶</h2>
            
            <h3>5.1 AbortController</h3>
            <pre><code>// ä½¿ç”¨ AbortController å–æ¶ˆè¯·æ±‚
const controller = new AbortController();
const signal = controller.signal;

fetch(url, { signal })
    .then(response => response.json())
    .catch(error => {
        if (error.name === 'AbortError') {
            console.log('Request aborted');
        }
    });

// å–æ¶ˆè¯·æ±‚
controller.abort();</code></pre>
            
            <h3>5.2 è¶…æ—¶åŒ…è£…</h3>
            <pre><code>function fetchWithTimeout(url, options = {}, timeout = 5000) {
    const controller = new AbortController();
    const signal = controller.signal;
    
    const timeoutId = setTimeout(() => controller.abort(), timeout);
    
    return fetch(url, { ...options, signal })
        .finally(() => clearTimeout(timeoutId));
}</code></pre>
            
            <h2>å…­ã€å¹¶å‘è¯·æ±‚</h2>
            
            <h3>6.1 Promise.all</h3>
            <pre><code>// å¹¶è¡Œè¯·æ±‚
const [users, posts, comments] = await Promise.all([
    fetch('/api/users').then(r => r.json()),
    fetch('/api/posts').then(r => r.json()),
    fetch('/api/comments').then(r => r.json())
]);</code></pre>
            
            <h3>6.2 Promise.allSettled</h3>
            <pre><code>// ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆï¼ˆæ— è®ºæˆåŠŸå¤±è´¥ï¼‰
const results = await Promise.allSettled([
    fetch('/api/users'),
    fetch('/api/posts'),
    fetch('/api/comments')
]);

results.forEach((result, index) => {
    if (result.status === 'fulfilled') {
        console.log(`Request ${index} succeeded`);
    } else {
        console.log(`Request ${index} failed:`, result.reason);
    }
});</code></pre>
            
            <h2>ä¸ƒã€æ–‡ä»¶ä¸Šä¼ </h2>
            
            <h3>7.1 å•æ–‡ä»¶ä¸Šä¼ </h3>
            <pre><code>const fileInput = document.getElementById('file');
const file = fileInput.files[0];

const formData = new FormData();
formData.append('file', file);

fetch('/api/upload', {
    method: 'POST',
    body: formData
})
.then(response => response.json())
.then(data => console.log(data));</code></pre>
            
            <h3>7.2 å¤šæ–‡ä»¶ä¸Šä¼ </h3>
            <pre><code>const files = Array.from(fileInput.files);
const formData = new FormData();

files.forEach((file, index) => {
    formData.append(`file${index}`, file);
});

fetch('/api/upload', {
    method: 'POST',
    body: formData
});</code></pre>
            
            <h2>å…«ã€Fetch vs XMLHttpRequest</h2>
            
            <table>
                <thead>
                    <tr>
                        <th>ç‰¹æ€§</th>
                        <th>Fetch</th>
                        <th>XMLHttpRequest</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>API é£æ ¼</td>
                        <td>Promise</td>
                        <td>å›è°ƒ</td>
                    </tr>
                    <tr>
                        <td>è¯­æ³•</td>
                        <td>ç®€æ´</td>
                        <td>å¤æ‚</td>
                    </tr>
                    <tr>
                        <td>æµå¼ä¼ è¾“</td>
                        <td>æ”¯æŒ</td>
                        <td>ä¸æ”¯æŒ</td>
                    </tr>
                    <tr>
                        <td>ä¸Šä¼ è¿›åº¦</td>
                        <td>ä¸ç›´æ¥æ”¯æŒ</td>
                        <td>æ”¯æŒ</td>
                    </tr>
                    <tr>
                        <td>å–æ¶ˆè¯·æ±‚</td>
                        <td>AbortController</td>
                        <td>abort()</td>
                    </tr>
                </tbody>
            </table>
            
            <h2>ä¹ã€æœ€ä½³å®è·µ</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>é”™è¯¯å¤„ç†</strong>ï¼šæ£€æŸ¥ response.ok</li>
                    <li><strong>è¶…æ—¶æ§åˆ¶</strong>ï¼šä½¿ç”¨ AbortController</li>
                    <li><strong>å‡­è¯</strong>ï¼šæ˜ç¡®è®¾ç½® credentials</li>
                    <li><strong>Content-Type</strong>ï¼šæ­£ç¡®è®¾ç½®è¯·æ±‚å¤´</li>
                    <li><strong>å–æ¶ˆè¯·æ±‚</strong>ï¼šç»„ä»¶å¸è½½æ—¶å–æ¶ˆæœªå®Œæˆè¯·æ±‚</li>
                    <li><strong>é‡è¯•æœºåˆ¶</strong>ï¼šå®ç°è‡ªåŠ¨é‡è¯•</li>
                </ol>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="https://fetch.spec.whatwg.org/" target="_blank">Fetch Standard</a></li>
                <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Fetch_API" target="_blank">MDN - Fetch API</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="11-storage.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šæœ¬åœ°å­˜å‚¨</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="../index.html" class="nav-link next">æ·±å…¥åŸç†ç¯‡</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šåŸºæœ¬ Fetch è¯·æ±‚</h3>
                <div class="code-block">
                    <pre><code>// æ¨¡æ‹Ÿ Fetch APIï¼ˆå®é™…ä½¿ç”¨ä¸­ä¼šçœŸæ­£å‘èµ·è¯·æ±‚ï¼‰
console.log('=== Fetch åŸºç¡€ ===\n');

console.log('GET è¯·æ±‚:');
console.log(`fetch('https://api.example.com/data')`);
console.log('  .then(response => response.json())');
console.log('  .then(data => console.log(data))');

console.log('\nä½¿ç”¨ async/await:');
console.log('async function fetchData() {');
console.log('  const response = await fetch(url);');
console.log('  const data = await response.json();');
console.log('  return data;');
console.log('}');

console.log('\nFetch è¿”å› Promise');
console.log('Response å¯¹è±¡åŒ…å«:');
console.log('  - status: çŠ¶æ€ç ');
console.log('  - ok: æ˜¯å¦æˆåŠŸ (200-299)');
console.log('  - headers: å“åº”å¤´');
console.log('  - body: å“åº”ä½“ï¼ˆéœ€è¦è§£æï¼‰');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šPOST è¯·æ±‚</h3>
                <div class="code-block">
                    <pre><code>// æ¼”ç¤º POST è¯·æ±‚é…ç½®
console.log('=== POST è¯·æ±‚ ===\n');

const requestData = {
    name: 'Alice',
    age: 25,
    email: 'alice@example.com'
};

console.log('è¯·æ±‚æ•°æ®:', requestData);

console.log('\nPOST è¯·æ±‚é…ç½®:');
const config = {
    method: 'POST',
    headers: {
        'Content-Type': 'application/json',
        'Authorization': 'Bearer token123'
    },
    body: JSON.stringify(requestData)
};

console.log('method:', config.method);
console.log('headers:', config.headers);
console.log('body:', config.body);

console.log('\nå®Œæ•´è¯·æ±‚:');
console.log(`fetch('https://api.example.com/users', config)`);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šé”™è¯¯å¤„ç†</h3>
                <div class="code-block">
                    <pre><code>// å®Œæ•´çš„é”™è¯¯å¤„ç†ç¤ºä¾‹
async function fetchWithErrorHandling(url, options = {}) {
    try {
        console.log('å‘èµ·è¯·æ±‚:', url);
        
        // æ¨¡æ‹Ÿ fetch
        const mockResponse = {
            ok: true,
            status: 200,
            json: async () => ({ id: 1, name: 'Alice' })
        };
        
        // æ£€æŸ¥å“åº”çŠ¶æ€
        if (!mockResponse.ok) {
            throw new Error(`HTTP Error: ${mockResponse.status}`);
        }
        
        const data = await mockResponse.json();
        console.log('è¯·æ±‚æˆåŠŸ:', data);
        return data;
        
    } catch (error) {
        console.error('è¯·æ±‚å¤±è´¥:', error.message);
        
        if (error.name === 'TypeError') {
            console.log('  åŸå› : ç½‘ç»œé”™è¯¯');
        } else {
            console.log('  åŸå› : HTTP é”™è¯¯');
        }
        
        throw error;
    }
}

// æµ‹è¯•
fetchWithErrorHandling('https://api.example.com/data');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼šè¶…æ—¶æ§åˆ¶</h3>
                <div class="code-block">
                    <pre><code>// å¸¦è¶…æ—¶çš„ Fetch å°è£…
function fetchWithTimeout(url, options = {}, timeout = 5000) {
    console.log(`å‘èµ·è¯·æ±‚ï¼Œè¶…æ—¶æ—¶é—´: ${timeout}ms`);
    
    return new Promise((resolve, reject) => {
        const timer = setTimeout(() => {
            reject(new Error('Request timeout'));
        }, timeout);
        
        // æ¨¡æ‹Ÿ fetch
        const mockFetch = new Promise((res) => {
            setTimeout(() => {
                res({
                    ok: true,
                    json: () => Promise.resolve({ data: 'success' })
                });
            }, 1000);  // æ¨¡æ‹Ÿ1ç§’å“åº”
        });
        
        mockFetch
            .then(response => {
                clearTimeout(timer);
                resolve(response);
            })
            .catch(error => {
                clearTimeout(timer);
                reject(error);
            });
    });
}

// æµ‹è¯•
fetchWithTimeout('https://api.example.com/slow', {}, 3000)
    .then(response => response.json())
    .then(data => console.log('æˆåŠŸ:', data))
    .catch(error => console.log('å¤±è´¥:', error.message));</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šå¹¶å‘è¯·æ±‚</h3>
                <div class="code-block">
                    <pre><code>// æ¨¡æ‹Ÿå¤šä¸ª API è¯·æ±‚
function mockFetch(url, delay) {
    return new Promise(resolve => {
        setTimeout(() => {
            resolve({
                ok: true,
                json: () => Promise.resolve({ 
                    url, 
                    data: `Data from ${url}` 
                })
            });
        }, delay);
    });
}

// å¹¶å‘è¯·æ±‚
async function fetchMultiple() {
    console.log('=== å¹¶å‘è¯·æ±‚ ===\n');
    console.log('å¼€å§‹å¹¶å‘è¯·æ±‚...');
    
    const start = Date.now();
    
    const [users, posts, comments] = await Promise.all([
        mockFetch('/api/users', 300).then(r => r.json()),
        mockFetch('/api/posts', 200).then(r => r.json()),
        mockFetch('/api/comments', 100).then(r => r.json())
    ]);
    
    const time = Date.now() - start;
    
    console.log('users:', users);
    console.log('posts:', posts);
    console.log('comments:', comments);
    console.log(`\næ€»è€—æ—¶: ${time}ms (å¹¶è¡Œ)`);}

fetchMultiple();</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šFetch å·¥å…·å°è£…</h3>
                <div class="code-block">
                    <pre><code>// å®ç”¨çš„ Fetch å·¥å…·ç±»
class FetchUtil {
    constructor(baseURL = '', defaultOptions = {}) {
        this.baseURL = baseURL;
        this.defaultOptions = defaultOptions;
    }
    
    async request(url, options = {}) {
        const config = {
            ...this.defaultOptions,
            ...options,
            headers: {
                'Content-Type': 'application/json',
                ...this.defaultOptions.headers,
                ...options.headers
            }
        };
        
        console.log('Request:', this.baseURL + url);
        console.log('Method:', config.method || 'GET');
        
        // è¿™é‡Œåº”è¯¥æ˜¯çœŸæ­£çš„ fetch
        // return fetch(this.baseURL + url, config);
        
        // æ¨¡æ‹Ÿå“åº”
        return Promise.resolve({
            ok: true,
            json: () => Promise.resolve({ success: true })
        });
    }
    
    get(url, options) {
        return this.request(url, { ...options, method: 'GET' });
    }
    
    post(url, data, options) {
        return this.request(url, {
            ...options,
            method: 'POST',
            body: JSON.stringify(data)
        });
    }
}

// ä½¿ç”¨
const api = new FetchUtil('https://api.example.com');

api.get('/users')
    .then(r => r.json())
    .then(data => console.log('GET:', data));

api.post('/users', { name: 'Alice' })
    .then(r => r.json())
    .then(data => console.log('POST:', data));</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
