<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Promise è¯¦è§£ - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>Promise è¯¦è§£</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>Promise æ˜¯ ES6 å¼•å…¥çš„å¼‚æ­¥ç¼–ç¨‹è§£å†³æ–¹æ¡ˆï¼Œè§£å†³äº†å›è°ƒåœ°ç‹±é—®é¢˜ã€‚Promise ä»£è¡¨ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„æœ€ç»ˆå®Œæˆæˆ–å¤±è´¥ã€‚</p>
            
            <h2>ä¸€ã€Promise åŸºç¡€</h2>
            
            <h3>1.1 Promise çŠ¶æ€</h3>
            <div class="info">
                Promise æœ‰ä¸‰ç§çŠ¶æ€ï¼š
                <ul>
                    <li><strong>pending</strong>ï¼ˆè¿›è¡Œä¸­ï¼‰ï¼šåˆå§‹çŠ¶æ€</li>
                    <li><strong>fulfilled</strong>ï¼ˆå·²æˆåŠŸï¼‰ï¼šæ“ä½œæˆåŠŸå®Œæˆ</li>
                    <li><strong>rejected</strong>ï¼ˆå·²å¤±è´¥ï¼‰ï¼šæ“ä½œå¤±è´¥</li>
                </ul>
                çŠ¶æ€åªèƒ½ä» pending å˜ä¸º fulfilled æˆ– rejectedï¼Œä¸”çŠ¶æ€ä¸€æ—¦æ”¹å˜å°±ä¸ä¼šå†å˜ã€‚
            </div>
            
            <h3>1.2 åˆ›å»º Promise</h3>
            <pre><code>const promise = new Promise((resolve, reject) => {
    // å¼‚æ­¥æ“ä½œ
    setTimeout(() => {
        const success = true;
        if (success) {
            resolve('æˆåŠŸçš„æ•°æ®');
        } else {
            reject(new Error('å¤±è´¥åŸå› '));
        }
    }, 1000);
});</code></pre>
            
            <h3>1.3 ä½¿ç”¨ Promise</h3>
            <pre><code>promise
    .then(result => {
        console.log('æˆåŠŸ:', result);
        return result;
    })
    .catch(error => {
        console.error('å¤±è´¥:', error);
    })
    .finally(() => {
        console.log('æ— è®ºæˆåŠŸå¤±è´¥éƒ½æ‰§è¡Œ');
    });</code></pre>
            
            <h2>äºŒã€Promise æ–¹æ³•</h2>
            
            <h3>2.1 then()</h3>
            <pre><code>promise.then(onFulfilled, onRejected);

// é“¾å¼è°ƒç”¨
promise
    .then(result => {
        return result * 2;
    })
    .then(result => {
        return result * 3;
    })
    .then(result => {
        console.log(result);
    });</code></pre>
            
            <h3>2.2 catch()</h3>
            <pre><code>// æ•è·é”™è¯¯
promise
    .then(result => {
        throw new Error('å‡ºé”™äº†');
    })
    .catch(error => {
        console.error(error.message);
    });

// ç­‰ä»·äº
promise.then(null, error => {
    console.error(error);
});</code></pre>
            
            <h3>2.3 finally()</h3>
            <pre><code>promise
    .then(result => console.log(result))
    .catch(error => console.error(error))
    .finally(() => {
        // æ¸…ç†æ“ä½œï¼Œæ— è®ºæˆåŠŸå¤±è´¥
        console.log('æ¸…ç†å®Œæˆ');
    });</code></pre>
            
            <h2>ä¸‰ã€Promise é™æ€æ–¹æ³•</h2>
            
            <h3>3.1 Promise.resolve()</h3>
            <pre><code>// è¿”å›ä¸€ä¸ªæˆåŠŸçš„ Promise
Promise.resolve('value');

// ç­‰ä»·äº
new Promise(resolve => resolve('value'));</code></pre>
            
            <h3>3.2 Promise.reject()</h3>
            <pre><code>// è¿”å›ä¸€ä¸ªå¤±è´¥çš„ Promise
Promise.reject(new Error('å¤±è´¥'));

// ç­‰ä»·äº
new Promise((resolve, reject) => reject(new Error('å¤±è´¥')));</code></pre>
            
            <h3>3.3 Promise.all()</h3>
            <p>ç­‰å¾…æ‰€æœ‰ Promise å®Œæˆï¼Œå…¨éƒ¨æˆåŠŸæ‰æˆåŠŸï¼š</p>
            
            <pre><code>const p1 = Promise.resolve(1);
const p2 = Promise.resolve(2);
const p3 = Promise.resolve(3);

Promise.all([p1, p2, p3])
    .then(results => {
        console.log(results); // [1, 2, 3]
    });

// ä»»ä½•ä¸€ä¸ªå¤±è´¥ï¼Œæ•´ä½“å¤±è´¥
const p4 = Promise.reject('error');
Promise.all([p1, p2, p4])
    .catch(error => {
        console.log(error); // 'error'
    });</code></pre>
            
            <h3>3.4 Promise.race()</h3>
            <p>è¿”å›æœ€å…ˆå®Œæˆçš„ Promise ç»“æœï¼š</p>
            
            <pre><code>const p1 = new Promise(resolve => setTimeout(() => resolve('æ…¢'), 1000));
const p2 = new Promise(resolve => setTimeout(() => resolve('å¿«'), 500));

Promise.race([p1, p2])
    .then(result => {
        console.log(result); // 'å¿«'
    });</code></pre>
            
            <h3>3.5 Promise.allSettled() (ES2020)</h3>
            <p>ç­‰å¾…æ‰€æœ‰ Promise å®Œæˆï¼Œæ— è®ºæˆåŠŸå¤±è´¥ï¼š</p>
            
            <pre><code>const promises = [
    Promise.resolve(1),
    Promise.reject('error'),
    Promise.resolve(3)
];

Promise.allSettled(promises)
    .then(results => {
        console.log(results);
        // [
        //   { status: 'fulfilled', value: 1 },
        //   { status: 'rejected', reason: 'error' },
        //   { status: 'fulfilled', value: 3 }
        // ]
    });</code></pre>
            
            <h3>3.6 Promise.any() (ES2021)</h3>
            <p>è¿”å›ç¬¬ä¸€ä¸ªæˆåŠŸçš„ Promiseï¼š</p>
            
            <pre><code>const p1 = Promise.reject('error1');
const p2 = new Promise(resolve => setTimeout(() => resolve('æˆåŠŸ'), 500));
const p3 = Promise.reject('error2');

Promise.any([p1, p2, p3])
    .then(result => {
        console.log(result); // 'æˆåŠŸ'
    });</code></pre>
            
            <h2>å››ã€Promise é“¾</h2>
            
            <h3>4.1 é“¾å¼è°ƒç”¨</h3>
            <pre><code>fetchUser(1)
    .then(user => fetchPosts(user.id))
    .then(posts => fetchComments(posts[0].id))
    .then(comments => {
        console.log(comments);
    })
    .catch(error => {
        console.error('ä»»ä½•æ­¥éª¤å‡ºé”™éƒ½åœ¨è¿™é‡Œæ•è·');
    });</code></pre>
            
            <h3>4.2 è¿”å›å€¼å¤„ç†</h3>
            <pre><code>Promise.resolve(1)
    .then(value => {
        return value + 1;  // è¿”å›æ™®é€šå€¼
    })
    .then(value => {
        return Promise.resolve(value + 1);  // è¿”å› Promise
    })
    .then(value => {
        console.log(value); // 3
    });</code></pre>
            
            <h2>äº”ã€é”™è¯¯å¤„ç†</h2>
            
            <h3>5.1 é”™è¯¯ä¼ æ’­</h3>
            <pre><code>Promise.resolve()
    .then(() => {
        throw new Error('é”™è¯¯1');
    })
    .then(() => {
        console.log('ä¸ä¼šæ‰§è¡Œ');
    })
    .catch(error => {
        console.error(error.message); // 'é”™è¯¯1'
    });</code></pre>
            
            <h3>5.2 é”™è¯¯æ¢å¤</h3>
            <pre><code>Promise.reject('é”™è¯¯')
    .catch(error => {
        console.error(error);
        return 'æ¢å¤å€¼';
    })
    .then(value => {
        console.log(value); // 'æ¢å¤å€¼'
    });</code></pre>
            
            <h2>å…­ã€Promise å®æˆ˜æ¨¡å¼</h2>
            
            <h3>6.1 è¶…æ—¶æ§åˆ¶</h3>
            <pre><code>function timeout(ms) {
    return new Promise((resolve, reject) => {
        setTimeout(() => reject(new Error('è¶…æ—¶')), ms);
    });
}

function fetchWithTimeout(url, ms) {
    return Promise.race([
        fetch(url),
        timeout(ms)
    ]);
}</code></pre>
            
            <h3>6.2 é‡è¯•æœºåˆ¶</h3>
            <pre><code>function retry(fn, times) {
    return fn().catch(err => {
        if (times > 1) {
            return retry(fn, times - 1);
        }
        throw err;
    });
}

retry(() => fetchData(), 3);</code></pre>
            
            <h3>6.3 ä¸²è¡Œæ‰§è¡Œ</h3>
            <pre><code>function runSerial(tasks) {
    return tasks.reduce((promise, task) => {
        return promise.then(results => {
            return task().then(result => [...results, result]);
        });
    }, Promise.resolve([]));
}</code></pre>
            
            <h2>ä¸ƒã€æœ€ä½³å®è·µ</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>æ€»æ˜¯è¿”å›</strong>ï¼šthen ä¸­è¦ä¹ˆè¿”å›å€¼ï¼Œè¦ä¹ˆè¿”å› Promise</li>
                    <li><strong>é”™è¯¯å¤„ç†</strong>ï¼šä½¿ç”¨ catch æ•è·é”™è¯¯</li>
                    <li><strong>é¿å…åµŒå¥—</strong>ï¼šä½¿ç”¨é“¾å¼è°ƒç”¨ä»£æ›¿åµŒå¥—</li>
                    <li><strong>Promise.all</strong>ï¼šå¹¶è¡Œæ‰§è¡Œå¤šä¸ªç‹¬ç«‹çš„å¼‚æ­¥æ“ä½œ</li>
                    <li><strong>finally</strong>ï¼šç”¨äºæ¸…ç†æ“ä½œ</li>
                </ol>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="https://tc39.es/ecma262/#sec-promise-objects" target="_blank">ECMAScript - Promise Objects</a></li>
                <li><a href="https://promisesaplus.com/" target="_blank">Promises/A+ è§„èŒƒ</a></li>
                <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank">MDN - Promise</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="09-callbacks.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šå›è°ƒå‡½æ•°</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="09-async-await.html" class="nav-link next">ä¸‹ä¸€èŠ‚ï¼šasync/await</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šPromise åŸºç¡€</h3>
                <div class="code-block">
                    <pre><code>// åˆ›å»º Promise
const promise = new Promise((resolve, reject) => {
    const success = true;
    setTimeout(() => {
        if (success) {
            resolve('æ“ä½œæˆåŠŸ');
        } else {
            reject(new Error('æ“ä½œå¤±è´¥'));
        }
    }, 500);
});

// ä½¿ç”¨ Promise
promise
    .then(result => {
        console.log('æˆåŠŸ:', result);
    })
    .catch(error => {
        console.error('å¤±è´¥:', error.message);
    })
    .finally(() => {
        console.log('å®Œæˆ');
    });

// Promise.resolve å¿«æ·æ–¹å¼
Promise.resolve('ç›´æ¥æˆåŠŸ').then(console.log);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šPromise é“¾å¼è°ƒç”¨</h3>
                <div class="code-block">
                    <pre><code>// é“¾å¼è°ƒç”¨
console.log('å¼€å§‹é“¾å¼è°ƒç”¨');

Promise.resolve(1)
    .then(value => {
        console.log('ç¬¬1æ­¥:', value);
        return value + 1;
    })
    .then(value => {
        console.log('ç¬¬2æ­¥:', value);
        return value * 2;
    })
    .then(value => {
        console.log('ç¬¬3æ­¥:', value);
        return value * value;
    })
    .then(value => {
        console.log('æœ€ç»ˆç»“æœ:', value);
    });

// é”™è¯¯ä¼šè·³è¿‡åç»­çš„ then
console.log('\né”™è¯¯å¤„ç†:');
Promise.resolve(1)
    .then(value => {
        throw new Error('å‡ºé”™äº†');
    })
    .then(value => {
        console.log('ä¸ä¼šæ‰§è¡Œ');
    })
    .catch(error => {
        console.log('æ•è·é”™è¯¯:', error.message);
        return 'æ¢å¤å€¼';
    })
    .then(value => {
        console.log('æ¢å¤å:', value);
    });</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šPromise.all</h3>
                <div class="code-block">
                    <pre><code>// æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
const task1 = () => new Promise(resolve => {
    setTimeout(() => resolve('ä»»åŠ¡1å®Œæˆ'), 300);
});

const task2 = () => new Promise(resolve => {
    setTimeout(() => resolve('ä»»åŠ¡2å®Œæˆ'), 200);
});

const task3 = () => new Promise(resolve => {
    setTimeout(() => resolve('ä»»åŠ¡3å®Œæˆ'), 100);
});

console.log('Promise.all - ç­‰å¾…å…¨éƒ¨å®Œæˆ:');
Promise.all([task1(), task2(), task3()])
    .then(results => {
        console.log('å…¨éƒ¨å®Œæˆ:', results);
    });

// ä»»ä½•ä¸€ä¸ªå¤±è´¥ï¼Œæ•´ä½“å¤±è´¥
console.log('\nPromise.all - æœ‰ä¸€ä¸ªå¤±è´¥:');
const taskFail = () => Promise.reject('ä»»åŠ¡å¤±è´¥');

Promise.all([task1(), taskFail(), task3()])
    .catch(error => {
        console.log('æ•è·é”™è¯¯:', error);
    });</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼šPromise.race å’Œ allSettled</h3>
                <div class="code-block">
                    <pre><code>// Promise.race - è¿”å›æœ€å¿«çš„
const slow = new Promise(resolve => 
    setTimeout(() => resolve('æ…¢'), 500));
const fast = new Promise(resolve => 
    setTimeout(() => resolve('å¿«'), 200));

console.log('Promise.race:');
Promise.race([slow, fast])
    .then(result => console.log('æœ€å¿«çš„:', result));

// Promise.allSettled - ç­‰å¾…å…¨éƒ¨å®Œæˆï¼ˆæ— è®ºæˆè´¥ï¼‰
const promises = [
    Promise.resolve('æˆåŠŸ1'),
    Promise.reject('å¤±è´¥'),
    Promise.resolve('æˆåŠŸ2')
];

console.log('\nPromise.allSettled:');
Promise.allSettled(promises)
    .then(results => {
        results.forEach((result, index) => {
            if (result.status === 'fulfilled') {
                console.log(`${index}: æˆåŠŸ -`, result.value);
            } else {
                console.log(`${index}: å¤±è´¥ -`, result.reason);
            }
        });
    });</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šå®ç”¨æ¨¡å¼ - è¶…æ—¶æ§åˆ¶</h3>
                <div class="code-block">
                    <pre><code>// è¶…æ—¶æ§åˆ¶
function timeout(ms) {
    return new Promise((resolve, reject) => {
        setTimeout(() => reject(new Error('è¶…æ—¶')), ms);
    });
}

function fetchWithTimeout(task, ms) {
    return Promise.race([
        task,
        timeout(ms)
    ]);
}

// æ¨¡æ‹Ÿæ…¢ä»»åŠ¡
const slowTask = new Promise(resolve => {
    setTimeout(() => resolve('ä»»åŠ¡å®Œæˆ'), 2000);
});

console.log('è¶…æ—¶æ§åˆ¶æµ‹è¯•:');
fetchWithTimeout(slowTask, 1000)
    .then(result => console.log('æˆåŠŸ:', result))
    .catch(error => console.log('å¤±è´¥:', error.message));

// å¿«ä»»åŠ¡ä¸ä¼šè¶…æ—¶
const fastTask = new Promise(resolve => {
    setTimeout(() => resolve('å¿«é€Ÿå®Œæˆ'), 500);
});

fetchWithTimeout(fastTask, 1000)
    .then(result => console.log('æˆåŠŸ:', result));</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šä¸²è¡Œå’Œå¹¶è¡Œ</h3>
                <div class="code-block">
                    <pre><code>// åˆ›å»ºä»»åŠ¡
const createTask = (name, delay) => () => {
    return new Promise(resolve => {
        setTimeout(() => {
            console.log(`${name} å®Œæˆ`);
            resolve(name);
        }, delay);
    });
};

// ä¸²è¡Œæ‰§è¡Œï¼ˆä¸€ä¸ªæ¥ä¸€ä¸ªï¼‰
async function runSerial(tasks) {
    console.log('=== ä¸²è¡Œæ‰§è¡Œ ===');
    for (const task of tasks) {
        await task();
    }
}

// å¹¶è¡Œæ‰§è¡Œï¼ˆåŒæ—¶è¿›è¡Œï¼‰
function runParallel(tasks) {
    console.log('\n=== å¹¶è¡Œæ‰§è¡Œ ===');
    return Promise.all(tasks.map(task => task()));
}

const tasks = [
    createTask('ä»»åŠ¡1', 300),
    createTask('ä»»åŠ¡2', 200),
    createTask('ä»»åŠ¡3', 100)
];

// æ‰§è¡Œä¸²è¡Œ
runSerial(tasks.map(t => t)).then(() => {
    // æ‰§è¡Œå¹¶è¡Œ
    const tasks2 = [
        createTask('å¹¶è¡Œ1', 300),
        createTask('å¹¶è¡Œ2', 200),
        createTask('å¹¶è¡Œ3', 100)
    ];
    return runParallel(tasks2);
});</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
