<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CommonJS è§„èŒƒ - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>CommonJS è§„èŒƒ</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>CommonJS æ˜¯ Node.js é‡‡ç”¨çš„æ¨¡å—åŒ–è§„èŒƒï¼Œä½¿ç”¨ require() å’Œ module.exportsï¼Œåœ¨è¿è¡Œæ—¶åŒæ­¥åŠ è½½æ¨¡å—ã€‚</p>
            
            <h2>ä¸€ã€åŸºæœ¬è¯­æ³•</h2>
            
            <h3>1.1 å¯¼å‡ºï¼ˆmodule.exportsï¼‰</h3>
            <pre><code>// å¯¼å‡ºå¯¹è±¡
module.exports = {
    name: 'Alice',
    age: 25,
    greet() {
        return 'Hello';
    }
};

// å¯¼å‡ºå‡½æ•°
module.exports = function(x, y) {
    return x + y;
};

// å¯¼å‡ºç±»
module.exports = class User {
    constructor(name) {
        this.name = name;
    }
};</code></pre>
            
            <h3>1.2 exports å¿«æ·æ–¹å¼</h3>
            <pre><code>// exports æ˜¯ module.exports çš„å¼•ç”¨
exports.name = 'Alice';
exports.age = 25;
exports.greet = function() {
    return 'Hello';
};

// ç­‰ä»·äº
module.exports.name = 'Alice';
module.exports.age = 25;</code></pre>
            
            <div class="warning">
                <strong>æ³¨æ„ï¼š</strong>ä¸èƒ½ç›´æ¥ç»™ exports èµ‹å€¼ï¼Œè¿™ä¼šåˆ‡æ–­ä¸ module.exports çš„å¼•ç”¨ã€‚
                <pre><code>// é”™è¯¯ âŒ
exports = { name: 'Alice' };

// æ­£ç¡® âœ…
module.exports = { name: 'Alice' };</code></pre>
            </div>
            
            <h3>1.3 å¯¼å…¥ï¼ˆrequireï¼‰</h3>
            <pre><code>// å¯¼å…¥æ¨¡å—
const utils = require('./utils');
const fs = require('fs');
const path = require('path');

// è§£æ„å¯¼å…¥
const { name, age } = require('./user');

// å¯¼å…¥å¹¶é‡å‘½å
const userUtils = require('./utils/user');</code></pre>
            
            <h2>äºŒã€æ¨¡å—è·¯å¾„</h2>
            
            <h3>2.1 ç›¸å¯¹è·¯å¾„</h3>
            <pre><code>// ç›¸å¯¹è·¯å¾„ï¼ˆå¿…é¡»ä»¥ ./ æˆ– ../ å¼€å¤´ï¼‰
const utils = require('./utils');
const config = require('../config');
const api = require('../../api/index');</code></pre>
            
            <h3>2.2 ç»å¯¹è·¯å¾„</h3>
            <pre><code>// ç»å¯¹è·¯å¾„
const module = require('/home/user/project/module');
const module = require('C:\\project\\module');</code></pre>
            
            <h3>2.3 æ¨¡å—æ ‡è¯†ç¬¦</h3>
            <pre><code>// æ ¸å¿ƒæ¨¡å—
const fs = require('fs');
const http = require('http');

// npm åŒ…ï¼ˆnode_modulesï¼‰
const express = require('express');
const lodash = require('lodash');</code></pre>
            
            <h2>ä¸‰ã€æ¨¡å—åŠ è½½æœºåˆ¶</h2>
            
            <h3>3.1 æ¨¡å—æŸ¥æ‰¾é¡ºåº</h3>
            <pre><code>// require('module') æŸ¥æ‰¾é¡ºåºï¼š
// 1. æ ¸å¿ƒæ¨¡å—ï¼ˆfs, http ç­‰ï¼‰
// 2. å½“å‰ç›®å½• node_modules
// 3. çˆ¶ç›®å½• node_modules
// 4. ç»§ç»­å‘ä¸ŠæŸ¥æ‰¾
// 5. å…¨å±€ node_modules</code></pre>
            
            <h3>3.2 æ–‡ä»¶æ‰©å±•å</h3>
            <pre><code>// è‡ªåŠ¨è¡¥å…¨æ‰©å±•å
require('./module');
// å°è¯•é¡ºåºï¼š
// 1. module.js
// 2. module.json
// 3. module.node
// 4. module/index.js</code></pre>
            
            <h3>3.3 ç¼“å­˜æœºåˆ¶</h3>
            <pre><code>// æ¨¡å—åªåŠ è½½ä¸€æ¬¡ï¼Œç»“æœè¢«ç¼“å­˜
const a = require('./module'); // ç¬¬ä¸€æ¬¡åŠ è½½
const b = require('./module'); // ä»ç¼“å­˜è¯»å–
console.log(a === b); // true

// æŸ¥çœ‹ç¼“å­˜
console.log(require.cache);

// æ¸…é™¤ç¼“å­˜
delete require.cache[require.resolve('./module')];

// é‡æ–°åŠ è½½
const fresh = require('./module');</code></pre>
            
            <h2>å››ã€module å¯¹è±¡</h2>
            
            <h3>4.1 module å±æ€§</h3>
            <pre><code>// module å¯¹è±¡
console.log(module.id);        // æ¨¡å—æ ‡è¯†ç¬¦
console.log(module.filename);  // æ¨¡å—æ–‡ä»¶å
console.log(module.loaded);    // æ˜¯å¦å·²åŠ è½½
console.log(module.parent);    // çˆ¶æ¨¡å—
console.log(module.children);  // å­æ¨¡å—æ•°ç»„
console.log(module.paths);     // æ¨¡å—æœç´¢è·¯å¾„</code></pre>
            
            <h3>4.2 require å¯¹è±¡</h3>
            <pre><code>// require.main - ä¸»æ¨¡å—
if (require.main === module) {
    console.log('ç›´æ¥è¿è¡Œ');
} else {
    console.log('è¢«å¯¼å…¥è¿è¡Œ');
}

// require.resolve - è§£ææ¨¡å—è·¯å¾„
const path = require.resolve('./module');

// require.cache - æ¨¡å—ç¼“å­˜
console.log(require.cache);

// require.extensions - æ‰©å±•åå¤„ç†å™¨ï¼ˆå·²åºŸå¼ƒï¼‰</code></pre>
            
            <h2>äº”ã€å¾ªç¯ä¾èµ–</h2>
            
            <h3>5.1 é—®é¢˜æ¼”ç¤º</h3>
            <pre><code>// a.js
console.log('a starting');
exports.done = false;
const b = require('./b');
console.log('in a, b.done =', b.done);
exports.done = true;
console.log('a done');

// b.js
console.log('b starting');
exports.done = false;
const a = require('./a');
console.log('in b, a.done =', a.done);
exports.done = true;
console.log('b done');

// main.js
const a = require('./a');
const b = require('./b');
console.log('main, a.done =', a.done, 'b.done =', b.done);</code></pre>
            
            <h3>5.2 è¾“å‡ºç»“æœ</h3>
            <pre><code>// æ‰§è¡Œç»“æœï¼š
a starting
b starting
in b, a.done = false  // a è¿˜æœªå®ŒæˆåŠ è½½
b done
in a, b.done = true
a done
main, a.done = true b.done = true</code></pre>
            
            <h2>å…­ã€CommonJS vs ES Modules</h2>
            
            <table>
                <thead>
                    <tr>
                        <th>ç‰¹æ€§</th>
                        <th>CommonJS</th>
                        <th>ES Modules</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>è¯­æ³•</td>
                        <td>require/module.exports</td>
                        <td>import/export</td>
                    </tr>
                    <tr>
                        <td>åŠ è½½æ—¶æœº</td>
                        <td>è¿è¡Œæ—¶</td>
                        <td>ç¼–è¯‘æ—¶</td>
                    </tr>
                    <tr>
                        <td>åŠ è½½æ–¹å¼</td>
                        <td>åŒæ­¥</td>
                        <td>å¼‚æ­¥</td>
                    </tr>
                    <tr>
                        <td>è¾“å‡º</td>
                        <td>å€¼çš„æ‹·è´</td>
                        <td>å€¼çš„å¼•ç”¨</td>
                    </tr>
                    <tr>
                        <td>this</td>
                        <td>æ¨¡å—æœ¬èº«</td>
                        <td>undefined</td>
                    </tr>
                    <tr>
                        <td>Tree Shaking</td>
                        <td>ä¸æ”¯æŒ</td>
                        <td>æ”¯æŒ</td>
                    </tr>
                    <tr>
                        <td>ç¯å¢ƒ</td>
                        <td>Node.js</td>
                        <td>æµè§ˆå™¨ + Node.js</td>
                    </tr>
                </tbody>
            </table>
            
            <h2>ä¸ƒã€å€¼çš„æ‹·è´ vs å¼•ç”¨</h2>
            
            <h3>7.1 CommonJSï¼ˆå€¼æ‹·è´ï¼‰</h3>
            <pre><code>// counter.js
let count = 0;
exports.count = count;
exports.increment = function() {
    count++;
};

// main.js
const counter = require('./counter');
console.log(counter.count); // 0
counter.increment();
console.log(counter.count); // ä»ç„¶æ˜¯ 0ï¼ˆå€¼çš„æ‹·è´ï¼‰</code></pre>
            
            <h3>7.2 ES Modulesï¼ˆå€¼å¼•ç”¨ï¼‰</h3>
            <pre><code>// counter.js
export let count = 0;
export function increment() {
    count++;
}

// main.js
import { count, increment } from './counter.js';
console.log(count); // 0
increment();
console.log(count); // 1ï¼ˆå€¼çš„å¼•ç”¨ï¼‰</code></pre>
            
            <h2>å…«ã€å®ç”¨æ¨¡å¼</h2>
            
            <h3>8.1 å•ä¾‹æ¨¡å¼</h3>
            <pre><code>// database.js
class Database {
    constructor() {
        this.connection = null;
    }
    
    connect() {
        if (!this.connection) {
            this.connection = createConnection();
        }
        return this.connection;
    }
}

// å¯¼å‡ºå•ä¾‹
module.exports = new Database();</code></pre>
            
            <h3>8.2 å·¥å‚æ¨¡å¼</h3>
            <pre><code>// logger.js
module.exports = function createLogger(name) {
    return {
        name,
        log(message) {
            console.log(`[${name}] ${message}`);
        }
    };
};

// ä½¿ç”¨
const createLogger = require('./logger');
const logger = createLogger('App');
logger.log('Started');</code></pre>
            
            <h3>8.3 å‘½åç©ºé—´</h3>
            <pre><code>// utils/index.js
module.exports = {
    string: require('./string'),
    array: require('./array'),
    object: require('./object')
};

// ä½¿ç”¨
const utils = require('./utils');
utils.string.capitalize('hello');
utils.array.unique([1, 2, 2]);</code></pre>
            
            <h2>ä¹ã€æœ€ä½³å®è·µ</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>ä½¿ç”¨ module.exports</strong>ï¼šé¿å… exports çš„é™·é˜±</li>
                    <li><strong>æ˜ç¡®è·¯å¾„</strong>ï¼šç›¸å¯¹è·¯å¾„ç”¨ ./ æˆ– ../</li>
                    <li><strong>é¿å…å¾ªç¯ä¾èµ–</strong>ï¼šé‡æ„æ¨¡å—ç»“æ„</li>
                    <li><strong>ç¼“å­˜åˆ©ç”¨</strong>ï¼šäº†è§£æ¨¡å—ç¼“å­˜æœºåˆ¶</li>
                    <li><strong>å…¥å£æ–‡ä»¶</strong>ï¼šä½¿ç”¨ index.js ä½œä¸ºå…¥å£</li>
                    <li><strong>è¿ç§»åˆ° ESM</strong>ï¼šæ–°é¡¹ç›®ä¼˜å…ˆä½¿ç”¨ ES Modules</li>
                </ol>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="http://www.commonjs.org/" target="_blank">CommonJS å®˜ç½‘</a></li>
                <li><a href="https://nodejs.org/api/modules.html" target="_blank">Node.js Modules æ–‡æ¡£</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="12-modules.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šES6 æ¨¡å—</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="13-babel.html" class="nav-link next">ä¸‹ä¸€èŠ‚ï¼šBabel è½¬è¯‘</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šmodule.exports vs exports</h3>
                <div class="code-block">
                    <pre><code>// æ¼”ç¤º module.exports å’Œ exports çš„åŒºåˆ«
console.log('=== module.exports vs exports ===\n');

// æ¨¡æ‹Ÿæ¨¡å—ç³»ç»Ÿ
function createModule() {
    const module = { exports: {} };
    const exports = module.exports; // exports æ˜¯å¼•ç”¨
    
    return { module, exports };
}

// æƒ…å†µ1ï¼šä½¿ç”¨ exports æ·»åŠ å±æ€§ï¼ˆæ­£ç¡® âœ…ï¼‰
const mod1 = createModule();
mod1.exports.name = 'Alice';
mod1.exports.age = 25;
console.log('æƒ…å†µ1ï¼ˆæ­£ç¡®ï¼‰:');
console.log('  module.exports:', mod1.module.exports);
console.log('  ç»“æœ: æ­£å¸¸å¯¼å‡º');

// æƒ…å†µ2ï¼šç›´æ¥èµ‹å€¼ exportsï¼ˆé”™è¯¯ âŒï¼‰
const mod2 = createModule();
mod2.exports = { name: 'Bob' }; // åˆ‡æ–­å¼•ç”¨
console.log('\næƒ…å†µ2ï¼ˆé”™è¯¯ï¼‰:');
console.log('  module.exports:', mod2.module.exports);
console.log('  ç»“æœ: å¯¼å‡ºç©ºå¯¹è±¡ï¼');

// æƒ…å†µ3ï¼šä½¿ç”¨ module.exportsï¼ˆæ­£ç¡® âœ…ï¼‰
const mod3 = createModule();
mod3.module.exports = { name: 'Charlie' };
console.log('\næƒ…å†µ3ï¼ˆæ­£ç¡®ï¼‰:');
console.log('  module.exports:', mod3.module.exports);
console.log('  ç»“æœ: æ­£å¸¸å¯¼å‡º');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šæ¨¡å—ç¼“å­˜æœºåˆ¶</h3>
                <div class="code-block">
                    <pre><code>// æ¨¡æ‹Ÿ CommonJS æ¨¡å—ç¼“å­˜
console.log('=== æ¨¡å—ç¼“å­˜ ===\n');

// æ¨¡æ‹Ÿæ¨¡å—ç¼“å­˜
const moduleCache = {};
let loadCount = 0;

function require(id) {
    // æ£€æŸ¥ç¼“å­˜
    if (moduleCache[id]) {
        console.log(`ä»ç¼“å­˜åŠ è½½: ${id}`);
        return moduleCache[id].exports;
    }
    
    // åˆ›å»ºæ¨¡å—
    console.log(`é¦–æ¬¡åŠ è½½: ${id}`);
    loadCount++;
    
    const module = {
        id,
        exports: {},
        loaded: false
    };
    
    // å­˜å…¥ç¼“å­˜
    moduleCache[id] = module;
    
    // æ¨¡æ‹Ÿæ¨¡å—ä»£ç æ‰§è¡Œ
    module.exports = {
        name: 'Module',
        loadTime: Date.now()
    };
    
    module.loaded = true;
    return module.exports;
}

// æµ‹è¯•
const mod1 = require('./module');
const mod2 = require('./module');
const mod3 = require('./module');

console.log('\nç»“æœ:');
console.log('  æ€»åŠ è½½æ¬¡æ•°:', loadCount);
console.log('  mod1 === mod2:', mod1 === mod2);
console.log('  mod2 === mod3:', mod2 === mod3);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šå¾ªç¯ä¾èµ–</h3>
                <div class="code-block">
                    <pre><code>// æ¨¡æ‹Ÿ CommonJS å¾ªç¯ä¾èµ–
console.log('=== å¾ªç¯ä¾èµ–æ¼”ç¤º ===\n');

const cache = {};

function createModule(id, code) {
    const module = { id, exports: {}, loaded: false };
    cache[id] = module;
    code(module, module.exports, (id) => cache[id].exports);
    module.loaded = true;
    return module.exports;
}

// æ¨¡å— a
createModule('a', (module, exports, require) => {
    console.log('a starting');
    exports.done = false;
    
    const b = require('b');  // æ­¤æ—¶ b è¿˜æœªå®Œæˆ
    console.log('in a, b.done =', b.done);
    
    exports.done = true;
    console.log('a done');
});

// æ¨¡å— b
createModule('b', (module, exports, require) => {
    console.log('b starting');
    exports.done = false;
    
    const a = require('a');  // a æœªå®Œæˆï¼Œè¿”å›éƒ¨åˆ†å¯¼å‡º
    console.log('in b, a.done =', a.done);
    
    exports.done = true;
    console.log('b done');
});

console.log('\næœ€ç»ˆçŠ¶æ€:');
console.log('  a.done =', cache.a.exports.done);
console.log('  b.done =', cache.b.exports.done);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼šå€¼æ‹·è´ vs å€¼å¼•ç”¨</h3>
                <div class="code-block">
                    <pre><code>// CommonJS å€¼æ‹·è´ç‰¹æ€§
console.log('=== CommonJS å€¼æ‹·è´ ===\n');

// æ¨¡æ‹Ÿ counter æ¨¡å—
const counterModule = (() => {
    let count = 0;
    
    // CommonJS å¯¼å‡ºå€¼çš„æ‹·è´
    const exports = {
        count: count,  // å¯¼å‡ºæ—¶çš„å€¼
        increment() {
            count++;
            console.log('  å†…éƒ¨ count =', count);
        },
        getCount() {
            return count;
        }
    };
    
    return exports;
})();

console.log('åˆå§‹å€¼:');
console.log('  exports.count =', counterModule.count);

console.log('\nè°ƒç”¨ increment():');
counterModule.increment();

console.log('\nå†æ¬¡æŸ¥çœ‹ exports.count:');
console.log('  exports.count =', counterModule.count);
console.log('  ä»ç„¶æ˜¯ 0ï¼ˆå€¼çš„æ‹·è´ï¼‰');

console.log('\né€šè¿‡ getCount() è·å–:');
console.log('  getCount() =', counterModule.getCount());
console.log('  å®é™…å€¼æ˜¯ 1');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šå•ä¾‹æ¨¡å¼</h3>
                <div class="code-block">
                    <pre><code>// CommonJS å•ä¾‹æ¨¡å¼
console.log('=== å•ä¾‹æ¨¡å¼ ===\n');

// æ¨¡æ‹Ÿæ•°æ®åº“æ¨¡å—
const createDatabaseModule = (() => {
    class Database {
        constructor() {
            this.connections = [];
            console.log('Database å®ä¾‹å·²åˆ›å»º');
        }
        
        connect(name) {
            console.log(`  è¿æ¥åˆ°: ${name}`);
            this.connections.push(name);
        }
        
        getConnections() {
            return this.connections;
        }
    }
    
    // å¯¼å‡ºå•ä¾‹
    return new Database();
})();

// æ¨¡å— A ä½¿ç”¨
console.log('æ¨¡å— A å¯¼å…¥:');
const db1 = createDatabaseModule;
db1.connect('DB_A');

// æ¨¡å— B ä½¿ç”¨ï¼ˆå…±äº«åŒä¸€å®ä¾‹ï¼‰
console.log('\næ¨¡å— B å¯¼å…¥:');
const db2 = createDatabaseModule;
db2.connect('DB_B');

console.log('\néªŒè¯å•ä¾‹:');
console.log('  db1 === db2:', db1 === db2);
console.log('  è¿æ¥æ•°:', db1.getConnections().length);
console.log('  æ‰€æœ‰è¿æ¥:', db1.getConnections());</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šCommonJS vs ES Modules</h3>
                <div class="code-block">
                    <pre><code>// å¯¹æ¯”ä¸¤ç§æ¨¡å—ç³»ç»Ÿ
console.log('=== CommonJS vs ES Modules ===\n');

const comparison = [
    ['ç‰¹æ€§', 'CommonJS', 'ES Modules'],
    ['è¯­æ³•', 'require/exports', 'import/export'],
    ['åŠ è½½æ—¶æœº', 'è¿è¡Œæ—¶', 'ç¼–è¯‘æ—¶'],
    ['åŠ è½½æ–¹å¼', 'åŒæ­¥', 'å¼‚æ­¥'],
    ['è¾“å‡º', 'å€¼æ‹·è´', 'å€¼å¼•ç”¨'],
    ['this', 'æ¨¡å—å¯¹è±¡', 'undefined'],
    ['Tree Shaking', 'ä¸æ”¯æŒ', 'æ”¯æŒ'],
    ['åŠ¨æ€åŠ è½½', 'require(å˜é‡)', 'import()'],
    ['ç¯å¢ƒ', 'Node.js', 'æµè§ˆå™¨+Node.js']
];

comparison.forEach((row, index) => {
    if (index === 0) {
        console.log(row.join(' | '));
        console.log('-'.repeat(50));
    } else {
        console.log(row.join(' | '));
    }
});

console.log('\næ¨è:');
console.log('  - æ–°é¡¹ç›®: ä½¿ç”¨ ES Modules');
console.log('  - Node.js: å¯ä»¥æ··ç”¨ï¼ˆ.mjs æˆ– package.json type)');
console.log('  - æµè§ˆå™¨: ä½¿ç”¨ ES Modules');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
