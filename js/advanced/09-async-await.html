<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>async/await è¯­æ³• - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>async/await è¯­æ³•</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>async/await æ˜¯ ES2017 å¼•å…¥çš„å¼‚æ­¥ç¼–ç¨‹è¯­æ³•ç³–ï¼ŒåŸºäº Promiseï¼Œè®©å¼‚æ­¥ä»£ç çœ‹èµ·æ¥åƒåŒæ­¥ä»£ç ï¼Œæå¤§æå‡äº†ä»£ç å¯è¯»æ€§ã€‚</p>
            
            <h2>ä¸€ã€async å‡½æ•°</h2>
            
            <h3>1.1 async åŸºç¡€</h3>
            <pre><code>// async å‡½æ•°æ€»æ˜¯è¿”å› Promise
async function fetchData() {
    return 'data';
}

fetchData().then(data => {
    console.log(data); // 'data'
});

// ç­‰ä»·äº
function fetchData() {
    return Promise.resolve('data');
}</code></pre>
            
            <h3>1.2 async å‡½æ•°å£°æ˜æ–¹å¼</h3>
            <pre><code>// å‡½æ•°å£°æ˜
async function func1() {}

// å‡½æ•°è¡¨è¾¾å¼
const func2 = async function() {};

// ç®­å¤´å‡½æ•°
const func3 = async () => {};

// å¯¹è±¡æ–¹æ³•
const obj = {
    async method() {}
};

// ç±»æ–¹æ³•
class MyClass {
    async method() {}
}</code></pre>
            
            <h2>äºŒã€await è¡¨è¾¾å¼</h2>
            
            <h3>2.1 await åŸºç¡€</h3>
            <pre><code>async function example() {
    // await ç­‰å¾… Promise å®Œæˆ
    const result = await Promise.resolve('value');
    console.log(result); // 'value'
    
    // await å¯ä»¥ç­‰å¾…ä»»ä½•å€¼
    const num = await 42;
    console.log(num); // 42
}</code></pre>
            
            <h3>2.2 await ç‰¹æ€§</h3>
            <div class="info">
                <ul>
                    <li>åªèƒ½åœ¨ async å‡½æ•°ä¸­ä½¿ç”¨</li>
                    <li>æš‚åœ async å‡½æ•°æ‰§è¡Œï¼Œç­‰å¾… Promise å®Œæˆ</li>
                    <li>Promise fulfilled æ—¶è¿”å›ç»“æœ</li>
                    <li>Promise rejected æ—¶æŠ›å‡ºé”™è¯¯</li>
                </ul>
            </div>
            
            <h2>ä¸‰ã€é”™è¯¯å¤„ç†</h2>
            
            <h3>3.1 try/catch</h3>
            <pre><code>async function fetchUser(id) {
    try {
        const user = await fetch(`/api/user/${id}`);
        const data = await user.json();
        return data;
    } catch (error) {
        console.error('è·å–ç”¨æˆ·å¤±è´¥:', error);
        throw error;
    }
}</code></pre>
            
            <h3>3.2 æ•è·ç‰¹å®šé”™è¯¯</h3>
            <pre><code>async function example() {
    try {
        await riskyOperation();
    } catch (error) {
        if (error.name === 'NetworkError') {
            // å¤„ç†ç½‘ç»œé”™è¯¯
        } else if (error.name === 'ValidationError') {
            // å¤„ç†éªŒè¯é”™è¯¯
        } else {
            throw error; // é‡æ–°æŠ›å‡º
        }
    }
}</code></pre>
            
            <h2>å››ã€å¹¶å‘æ§åˆ¶</h2>
            
            <h3>4.1 ä¸²è¡Œæ‰§è¡Œ</h3>
            <pre><code>async function sequential() {
    const result1 = await task1(); // ç­‰å¾…å®Œæˆ
    const result2 = await task2(); // ç„¶åæ‰§è¡Œ
    const result3 = await task3(); // æœ€åæ‰§è¡Œ
    return [result1, result2, result3];
}</code></pre>
            
            <h3>4.2 å¹¶è¡Œæ‰§è¡Œ</h3>
            <pre><code>async function parallel() {
    // åŒæ—¶å¯åŠ¨
    const promise1 = task1();
    const promise2 = task2();
    const promise3 = task3();
    
    // ç­‰å¾…æ‰€æœ‰å®Œæˆ
    const results = await Promise.all([
        promise1,
        promise2,
        promise3
    ]);
    return results;
}

// æˆ–ä½¿ç”¨ Promise.all
async function parallelSimple() {
    return await Promise.all([
        task1(),
        task2(),
        task3()
    ]);
}</code></pre>
            
            <h2>äº”ã€å®ç”¨æ¨¡å¼</h2>
            
            <h3>5.1 å¾ªç¯ä¸­ä½¿ç”¨ await</h3>
            <pre><code>// ä¸²è¡Œå¤„ç†
async function processItems(items) {
    for (const item of items) {
        await processItem(item); // ä¸€ä¸ªæ¥ä¸€ä¸ª
    }
}

// å¹¶è¡Œå¤„ç†
async function processItemsParallel(items) {
    await Promise.all(
        items.map(item => processItem(item))
    );
}</code></pre>
            
            <h3>5.2 æ¡ä»¶ await</h3>
            <pre><code>async function conditionalAwait(useCache) {
    let data;
    if (useCache) {
        data = getFromCache();
    } else {
        data = await fetchFromServer();
    }
    return data;
}</code></pre>
            
            <h3>5.3 è¶…æ—¶æ§åˆ¶</h3>
            <pre><code>async function fetchWithTimeout(url, timeout) {
    const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('è¶…æ—¶')), timeout);
    });
    
    return Promise.race([
        fetch(url),
        timeoutPromise
    ]);
}</code></pre>
            
            <h3>5.4 é‡è¯•æœºåˆ¶</h3>
            <pre><code>async function retry(fn, maxAttempts) {
    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
        try {
            return await fn();
        } catch (error) {
            if (attempt === maxAttempts) {
                throw error;
            }
            console.log(`é‡è¯•ç¬¬ ${attempt} æ¬¡`);
            await new Promise(resolve => 
                setTimeout(resolve, 1000 * attempt)
            );
        }
    }
}</code></pre>
            
            <h2>å…­ã€async/await vs Promise</h2>
            
            <table>
                <thead>
                    <tr>
                        <th>ç‰¹æ€§</th>
                        <th>Promise</th>
                        <th>async/await</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>è¯­æ³•</td>
                        <td>é“¾å¼è°ƒç”¨</td>
                        <td>åŒæ­¥é£æ ¼</td>
                    </tr>
                    <tr>
                        <td>é”™è¯¯å¤„ç†</td>
                        <td>.catch()</td>
                        <td>try/catch</td>
                    </tr>
                    <tr>
                        <td>å¯è¯»æ€§</td>
                        <td>è¾ƒå·®ï¼ˆåµŒå¥—å¤šæ—¶ï¼‰</td>
                        <td>æ›´å¥½</td>
                    </tr>
                    <tr>
                        <td>è°ƒè¯•</td>
                        <td>è¾ƒéš¾</td>
                        <td>æ›´å®¹æ˜“</td>
                    </tr>
                    <tr>
                        <td>æ¡ä»¶é€»è¾‘</td>
                        <td>å¤æ‚</td>
                        <td>ç®€å•</td>
                    </tr>
                </tbody>
            </table>
            
            <h2>ä¸ƒã€å¸¸è§é™·é˜±</h2>
            
            <h3>7.1 å¿˜è®° await</h3>
            <div class="warning">
                <pre><code>// é”™è¯¯ï¼šå¿˜è®° await
async function wrong() {
    const result = fetchData(); // è¿”å› Promiseï¼Œä¸æ˜¯å€¼
    console.log(result); // Promise { pending }
}

// æ­£ç¡®
async function correct() {
    const result = await fetchData();
    console.log(result); // å®é™…çš„å€¼
}</code></pre>
            </div>
            
            <h3>7.2 ä¸²è¡Œ vs å¹¶è¡Œ</h3>
            <div class="warning">
                <pre><code>// æ…¢ï¼šä¸²è¡Œæ‰§è¡Œ
async function slow() {
    const a = await task1(); // ç­‰å¾…
    const b = await task2(); // å†ç­‰å¾…
    return [a, b];
}

// å¿«ï¼šå¹¶è¡Œæ‰§è¡Œ
async function fast() {
    const [a, b] = await Promise.all([
        task1(),
        task2()
    ]);
    return [a, b];
}</code></pre>
            </div>
            
            <h3>7.3 å¾ªç¯ä¸­çš„ await</h3>
            <pre><code>// forEach ä¸ä¼šç­‰å¾…
async function wrong(items) {
    items.forEach(async item => {
        await processItem(item); // ä¸ä¼šæŒ‰é¢„æœŸå·¥ä½œ
    });
}

// æ­£ç¡®æ–¹å¼
async function correct(items) {
    for (const item of items) {
        await processItem(item);
    }
}</code></pre>
            
            <h2>å…«ã€æœ€ä½³å®è·µ</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>æ€»æ˜¯ç”¨ await</strong>ï¼šä¸è¦å¿˜è®° await Promise</li>
                    <li><strong>å¹¶è¡Œä¼˜å…ˆ</strong>ï¼šç‹¬ç«‹ä»»åŠ¡ä½¿ç”¨ Promise.all</li>
                    <li><strong>é”™è¯¯å¤„ç†</strong>ï¼šä½¿ç”¨ try/catch</li>
                    <li><strong>é¿å…é˜»å¡</strong>ï¼šä¸è¦åœ¨å¾ªç¯ä¸­ä¸²è¡Œæ‰§è¡Œè€—æ—¶æ“ä½œ</li>
                    <li><strong>è¿”å› Promise</strong>ï¼šasync å‡½æ•°å¯ä»¥ç›´æ¥è¿”å› await çš„ç»“æœ</li>
                </ol>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="https://tc39.es/ecma262/#sec-async-function-definitions" target="_blank">ECMAScript - Async Functions</a></li>
                <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/async_function" target="_blank">MDN - async function</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="09-promises.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šPromise è¯¦è§£</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="09-event-loop.html" class="nav-link next">ä¸‹ä¸€èŠ‚ï¼šäº‹ä»¶å¾ªç¯</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šasync/await åŸºç¡€</h3>
                <div class="code-block">
                    <pre><code>// async å‡½æ•°è¿”å› Promise
async function getMessage() {
    return 'Hello';
}

getMessage().then(msg => console.log(msg));

// await ç­‰å¾… Promise
async function example() {
    const result = await Promise.resolve('World');
    console.log('Result:', result);
    
    // await ä»»ä½•å€¼
    const num = await 42;
    console.log('Number:', num);
}

example();</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šé”™è¯¯å¤„ç†</h3>
                <div class="code-block">
                    <pre><code>// ä½¿ç”¨ try/catch å¤„ç†é”™è¯¯
async function fetchUser(id) {
    try {
        if (id < 0) {
            throw new Error('ID ä¸èƒ½ä¸ºè´Ÿæ•°');
        }
        
        // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
        await new Promise(resolve => setTimeout(resolve, 300));
        return { id, name: 'User' + id };
    } catch (error) {
        console.error('é”™è¯¯:', error.message);
        throw error;
    }
}

// æµ‹è¯•æˆåŠŸ
fetchUser(1)
    .then(user => console.log('æˆåŠŸ:', user))
    .catch(err => console.log('æ•è·:', err.message));

// æµ‹è¯•å¤±è´¥
fetchUser(-1)
    .then(user => console.log('æˆåŠŸ:', user))
    .catch(err => console.log('æ•è·:', err.message));</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šä¸²è¡Œ vs å¹¶è¡Œ</h3>
                <div class="code-block">
                    <pre><code>// æ¨¡æ‹Ÿå¼‚æ­¥ä»»åŠ¡
const task = (name, delay) => {
    return new Promise(resolve => {
        setTimeout(() => {
            console.log(`${name} å®Œæˆ`);
            resolve(name);
        }, delay);
    });
};

// ä¸²è¡Œæ‰§è¡Œï¼ˆæ…¢ï¼‰
async function sequential() {
    console.log('=== ä¸²è¡Œæ‰§è¡Œ ===');
    const start = Date.now();
    
    await task('ä»»åŠ¡1', 300);
    await task('ä»»åŠ¡2', 200);
    await task('ä»»åŠ¡3', 100);
    
    console.log('æ€»è€—æ—¶:', Date.now() - start, 'ms');
}

// å¹¶è¡Œæ‰§è¡Œï¼ˆå¿«ï¼‰
async function parallel() {
    console.log('\n=== å¹¶è¡Œæ‰§è¡Œ ===');
    const start = Date.now();
    
    await Promise.all([
        task('å¹¶è¡Œ1', 300),
        task('å¹¶è¡Œ2', 200),
        task('å¹¶è¡Œ3', 100)
    ]);
    
    console.log('æ€»è€—æ—¶:', Date.now() - start, 'ms');
}

// æ‰§è¡Œ
sequential().then(() => parallel());</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼šå¾ªç¯ä¸­ä½¿ç”¨ await</h3>
                <div class="code-block">
                    <pre><code>// ä¸²è¡Œå¤„ç†æ•°ç»„
async function processSerial(items) {
    console.log('ä¸²è¡Œå¤„ç†:');
    for (const item of items) {
        await new Promise(resolve => setTimeout(resolve, 200));
        console.log('  å¤„ç†:', item);
    }
}

// å¹¶è¡Œå¤„ç†æ•°ç»„
async function processParallel(items) {
    console.log('\nå¹¶è¡Œå¤„ç†:');
    await Promise.all(
        items.map(async item => {
            await new Promise(resolve => setTimeout(resolve, 200));
            console.log('  å¤„ç†:', item);
        })
    );
}

const items = [1, 2, 3];

processSerial(items).then(() => {
    return processParallel(items);
});</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šè¶…æ—¶æ§åˆ¶</h3>
                <div class="code-block">
                    <pre><code>// è¶…æ—¶åŒ…è£…å‡½æ•°
async function withTimeout(promise, ms) {
    const timeout = new Promise((_, reject) => {
        setTimeout(() => reject(new Error('è¶…æ—¶')), ms);
    });
    return Promise.race([promise, timeout]);
}

// æµ‹è¯•
async function testTimeout() {
    // å¿«ä»»åŠ¡ï¼ˆä¸ä¼šè¶…æ—¶ï¼‰
    const fastTask = new Promise(resolve => {
        setTimeout(() => resolve('å¿«é€Ÿå®Œæˆ'), 500);
    });
    
    try {
        const result = await withTimeout(fastTask, 1000);
        console.log('æˆåŠŸ:', result);
    } catch (error) {
        console.log('å¤±è´¥:', error.message);
    }
    
    // æ…¢ä»»åŠ¡ï¼ˆä¼šè¶…æ—¶ï¼‰
    const slowTask = new Promise(resolve => {
        setTimeout(() => resolve('æ…¢é€Ÿå®Œæˆ'), 2000);
    });
    
    try {
        const result = await withTimeout(slowTask, 1000);
        console.log('æˆåŠŸ:', result);
    } catch (error) {
        console.log('å¤±è´¥:', error.message);
    }
}

testTimeout();</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šé‡è¯•æœºåˆ¶</h3>
                <div class="code-block">
                    <pre><code>// é‡è¯•å‡½æ•°
async function retry(fn, maxAttempts = 3, delay = 1000) {
    for (let attempt = 1; attempt <= maxAttempts; attempt++) {
        try {
            return await fn();
        } catch (error) {
            console.log(`ç¬¬ ${attempt} æ¬¡å°è¯•å¤±è´¥`);
            if (attempt === maxAttempts) {
                throw new Error(`å¤±è´¥ ${maxAttempts} æ¬¡: ${error.message}`);
            }
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
}

// æ¨¡æ‹Ÿä¸ç¨³å®šçš„æ“ä½œ
let attempts = 0;
async function unstableOperation() {
    attempts++;
    if (attempts < 3) {
        throw new Error('æš‚æ—¶å¤±è´¥');
    }
    return 'æˆåŠŸ!';
}

// æµ‹è¯•é‡è¯•
retry(unstableOperation, 3, 500)
    .then(result => console.log('æœ€ç»ˆç»“æœ:', result))
    .catch(error => console.error('æœ€ç»ˆå¤±è´¥:', error.message));</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
