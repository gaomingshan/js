<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thenable åè®® - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>Thenable åè®®</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>Thenable æ˜¯ Promise/A+ è§„èŒƒä¸­çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªå…·æœ‰ then æ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°ã€‚ç†è§£ Thenable å¯¹äºæŒæ¡ Promise äº’æ“ä½œæ€§å’Œå®ç°è‡ªå®šä¹‰å¼‚æ­¥å¯¹è±¡è‡³å…³é‡è¦ã€‚</p>
            
            <h2>ä¸€ã€Thenable å®šä¹‰</h2>
            
            <h3>1.1 ä»€ä¹ˆæ˜¯ Thenable</h3>
            <div class="info">
                <p><strong>Thenable</strong> æ˜¯ä¸€ä¸ªå®šä¹‰äº† <code>then</code> æ–¹æ³•çš„å¯¹è±¡æˆ–å‡½æ•°ã€‚</p>
                <pre><code>// Thenable æ¥å£
interface Thenable {
    then(onFulfilled?, onRejected?): any;
}</code></pre>
            </div>
            
            <h3>1.2 åŸºæœ¬ç¤ºä¾‹</h3>
            <pre><code>// æœ€ç®€å•çš„ Thenable
const thenable = {
    then(onFulfilled) {
        setTimeout(() => {
            onFulfilled('Hello');
        }, 100);
    }
};

// Promise ä¼šè¯†åˆ«å¹¶å¤„ç†å®ƒ
Promise.resolve(thenable).then(value => {
    console.log(value);  // "Hello"
});</code></pre>
            
            <h3>1.3 Thenable vs Promise</h3>
            <pre><code>// Promise æ˜¯ Thenable
const promise = new Promise(resolve => resolve(42));
console.log(typeof promise.then);  // "function"

// ä½† Thenable ä¸ä¸€å®šæ˜¯ Promise
const thenable = {
    then(onFulfilled) {
        onFulfilled(42);
    }
};
console.log(thenable instanceof Promise);  // false</code></pre>
            
            <h2>äºŒã€Thenable æ£€æµ‹</h2>
            
            <h3>2.1 å¦‚ä½•æ£€æµ‹ Thenable</h3>
            <pre><code>// æ£€æµ‹ä¸€ä¸ªå€¼æ˜¯å¦æ˜¯ Thenable
function isThenable(value) {
    return (
        value !== null &&
        (typeof value === 'object' || typeof value === 'function') &&
        typeof value.then === 'function'
    );
}

// æµ‹è¯•
console.log(isThenable(Promise.resolve()));     // true
console.log(isThenable({ then() {} }));         // true
console.log(isThenable({ then: 'not a fn' })); // false
console.log(isThenable(null));                  // false
console.log(isThenable(42));                    // false</code></pre>
            
            <h3>2.2 é¸­å­ç±»å‹</h3>
            <pre><code>// Promise ä½¿ç”¨é¸­å­ç±»å‹æ£€æµ‹ Thenable
// åªè¦æœ‰ then æ–¹æ³•å°±è®¤ä¸ºæ˜¯ Thenable

const fakeThen = {
    then: 'I am not a function'
};

Promise.resolve(fakeThen).then(
    value => console.log('fulfilled:', value),
    error => console.log('rejected:', error)
);
// TypeError: fakeThen.then is not a function</code></pre>
            
            <h2>ä¸‰ã€Promise Resolution Procedure</h2>
            
            <h3>3.1 è§„èŒƒå®šä¹‰</h3>
            <pre><code>// Promise è§£æè¿‡ç¨‹ï¼ˆç®€åŒ–ï¼‰
function resolvePromise(promise, x) {
    // 1. å¦‚æœ promise å’Œ x æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼ŒæŠ›å‡º TypeError
    if (promise === x) {
        throw new TypeError('Chaining cycle');
    }
    
    // 2. å¦‚æœ x æ˜¯ Promiseï¼Œé‡‡ç”¨å…¶çŠ¶æ€
    if (x instanceof Promise) {
        x.then(
            value => resolve(promise, value),
            reason => reject(promise, reason)
        );
        return;
    }
    
    // 3. å¦‚æœ x æ˜¯å¯¹è±¡æˆ–å‡½æ•°
    if (x !== null && (typeof x === 'object' || typeof x === 'function')) {
        let then;
        try {
            then = x.then;
        } catch (e) {
            reject(promise, e);
            return;
        }
        
        // 4. å¦‚æœ then æ˜¯å‡½æ•°ï¼Œè°ƒç”¨å®ƒ
        if (typeof then === 'function') {
            let called = false;
            try {
                then.call(
                    x,
                    value => {
                        if (called) return;
                        called = true;
                        resolvePromise(promise, value);
                    },
                    reason => {
                        if (called) return;
                        called = true;
                        reject(promise, reason);
                    }
                );
            } catch (e) {
                if (!called) {
                    reject(promise, e);
                }
            }
            return;
        }
    }
    
    // 5. å¦åˆ™ï¼Œç›´æ¥ resolve
    resolve(promise, x);
}</code></pre>
            
            <h3>3.2 å…³é”®ç‚¹</h3>
            <div class="info">
                <ul>
                    <li><strong>é˜²æ­¢å¾ªç¯å¼•ç”¨</strong>ï¼špromise ä¸èƒ½ resolve è‡ªå·±</li>
                    <li><strong>åªè°ƒç”¨ä¸€æ¬¡</strong>ï¼šonFulfilled/onRejected åªèƒ½è°ƒç”¨ä¸€æ¬¡</li>
                    <li><strong>å¼‚å¸¸å®‰å…¨</strong>ï¼šæ•è· then è®¿é—®å’Œè°ƒç”¨ä¸­çš„å¼‚å¸¸</li>
                    <li><strong>é€’å½’è§£æ</strong>ï¼šæ”¯æŒ thenable è¿”å› thenable</li>
                </ul>
            </div>
            
            <h2>å››ã€è‡ªå®šä¹‰ Thenable</h2>
            
            <h3>4.1 ç®€å• Thenable</h3>
            <pre><code>// å®ç°ä¸€ä¸ªå»¶è¿Ÿ Thenable
class DelayedThenable {
    constructor(value, delay) {
        this.value = value;
        this.delay = delay;
    }
    
    then(onFulfilled, onRejected) {
        setTimeout(() => {
            try {
                const result = onFulfilled(this.value);
                // è¿”å›æ–°çš„ thenable ä»¥æ”¯æŒé“¾å¼è°ƒç”¨
                if (isThenable(result)) {
                    result.then(onFulfilled, onRejected);
                }
            } catch (e) {
                if (onRejected) onRejected(e);
            }
        }, this.delay);
    }
}

// ä½¿ç”¨
const delayed = new DelayedThenable('Hello', 1000);
Promise.resolve(delayed).then(console.log);  // 1ç§’åè¾“å‡º "Hello"</code></pre>
            
            <h3>4.2 ä¸ Promise äº’æ“ä½œ</h3>
            <pre><code>// è‡ªå®šä¹‰ Thenable ä¸ Promise é“¾å¼è°ƒç”¨
const customThenable = {
    value: 10,
    
    then(onFulfilled) {
        setTimeout(() => {
            onFulfilled(this.value * 2);
        }, 100);
    }
};

Promise.resolve(5)
    .then(x => customThenable)  // è¿”å› thenable
    .then(x => {
        console.log(x);  // 20ï¼ˆä¸æ˜¯ 10ï¼Œå› ä¸ºè¢« resolveï¼‰
        return x + 10;
    })
    .then(console.log);  // 30</code></pre>
            
            <h3>4.3 Thenable æ„é€ å‡½æ•°</h3>
            <pre><code>// ä½¿ç”¨ Thenable æ¨¡å¼åˆ›å»ºå¯¹è±¡
function createThenable(value) {
    return {
        then(onFulfilled, onRejected) {
            try {
                if (value instanceof Error) {
                    onRejected(value);
                } else {
                    onFulfilled(value);
                }
            } catch (e) {
                onRejected(e);
            }
        }
    };
}

// ä½¿ç”¨
Promise.resolve(createThenable(42))
    .then(console.log);  // 42

Promise.resolve(createThenable(new Error('fail')))
    .catch(console.error);  // Error: fail</code></pre>
            
            <h2>äº”ã€Thenable é™·é˜±</h2>
            
            <h3>5.1 æ¶æ„ Thenable</h3>
            <pre><code>// æ¶æ„ thenable å¯èƒ½ç ´å Promise é“¾
const evilThenable = {
    then(onFulfilled, onRejected) {
        onFulfilled(1);
        onFulfilled(2);  // è¿åè§„èŒƒï¼šå¤šæ¬¡è°ƒç”¨
        onRejected(new Error());  // è¿åè§„èŒƒï¼šåŒæ—¶è°ƒç”¨ä¸¤ä¸ª
    }
};

// Promise å®ç°å¿…é¡»é˜²å¾¡è¿™ç§æƒ…å†µ
Promise.resolve(evilThenable).then(
    value => console.log('Value:', value),  // åªè¾“å‡ºä¸€æ¬¡
    error => console.log('Error:', error)   // ä¸ä¼šè¢«è°ƒç”¨
);</code></pre>
            
            <h3>5.2 è®¿é—® then çš„å‰¯ä½œç”¨</h3>
            <pre><code>// è®¿é—® then å±æ€§å¯èƒ½æœ‰å‰¯ä½œç”¨
const trickyThenable = {
    get then() {
        console.log('è®¿é—® then å±æ€§');
        return function(onFulfilled) {
            onFulfilled(42);
        };
    }
};

// Promise åªä¼šè®¿é—® then ä¸€æ¬¡ï¼ˆæ ¹æ®è§„èŒƒï¼‰
Promise.resolve(trickyThenable).then(console.log);
// è¾“å‡ºï¼šè®¿é—® then å±æ€§ â†’ 42</code></pre>
            
            <h3>5.3 then æŠ›å‡ºå¼‚å¸¸</h3>
            <pre><code>// then è®¿é—®æˆ–è°ƒç”¨æ—¶æŠ›å‡ºå¼‚å¸¸
const throwingThenable = {
    get then() {
        throw new Error('Cannot access then');
    }
};

Promise.resolve(throwingThenable)
    .then(
        value => console.log('Fulfilled:', value),
        error => console.log('Rejected:', error.message)
    );
// è¾“å‡ºï¼šRejected: Cannot access then</code></pre>
            
            <h2>å…­ã€å®é™…åº”ç”¨</h2>
            
            <h3>6.1 jQuery Deferred</h3>
            <pre><code>// jQuery Deferred æ˜¯ thenable
const deferred = $.Deferred();

// å¯ä»¥ä¸ Promise äº’æ“ä½œ
Promise.resolve(deferred.promise()).then(value => {
    console.log(value);
});

deferred.resolve('Hello from jQuery');</code></pre>
            
            <h3>6.2 Async/Await ä¸ Thenable</h3>
            <pre><code>// async/await ä¹Ÿæ”¯æŒ thenable
const thenable = {
    then(resolve) {
        setTimeout(() => resolve('Result'), 100);
    }
};

async function test() {
    const result = await thenable;  // ç­‰å¾… thenable
    console.log(result);  // "Result"
}

test();</code></pre>
            
            <h3>6.3 è‡ªå®šä¹‰å¼‚æ­¥å®¹å™¨</h3>
            <pre><code>// åˆ›å»ºè‡ªå®šä¹‰å¼‚æ­¥å®¹å™¨
class AsyncBox {
    constructor(value) {
        this._value = value;
    }
    
    then(onFulfilled) {
        // å¼‚æ­¥è§£åŒ…
        return new AsyncBox(
            Promise.resolve(this._value).then(onFulfilled)
        );
    }
    
    async unwrap() {
        return await this._value;
    }
}

// ä½¿ç”¨
const box = new AsyncBox(42);
const result = await box.then(x => x * 2);  // AsyncBox
console.log(await result.unwrap());  // 84</code></pre>
            
            <h2>ä¸ƒã€æœ€ä½³å®è·µ</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>å®ç°å®Œæ•´çš„ then</strong>ï¼šåŒ…å« onFulfilled å’Œ onRejected</li>
                    <li><strong>éµå®ˆè§„èŒƒ</strong>ï¼šåªè°ƒç”¨ä¸€æ¬¡å›è°ƒï¼Œå¤„ç†å¼‚å¸¸</li>
                    <li><strong>è¿”å› Thenable</strong>ï¼šæ”¯æŒé“¾å¼è°ƒç”¨</li>
                    <li><strong>å°å¿ƒå‰¯ä½œç”¨</strong>ï¼šè®¿é—® then å¯èƒ½æœ‰å‰¯ä½œç”¨</li>
                    <li><strong>ä½¿ç”¨ Promise.resolve</strong>ï¼šæ ‡å‡†åŒ– thenable</li>
                    <li><strong>é¿å…æ¶æ„ thenable</strong>ï¼šéªŒè¯è¾“å…¥</li>
                    <li><strong>ä¼˜å…ˆ Promise</strong>ï¼šæ–°ä»£ç ä½¿ç”¨åŸç”Ÿ Promise</li>
                </ol>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="https://promisesaplus.com/" target="_blank">Promise/A+ è§„èŒƒ</a></li>
                <li><a href="https://tc39.es/ecma262/#sec-promise-resolve-functions" target="_blank">ECMAScript - Promise Resolve</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="18-promise-aplus.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šPromise/A+</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="18-microtask.html" class="nav-link next">ä¸‹ä¸€èŠ‚ï¼šå¾®ä»»åŠ¡é˜Ÿåˆ—</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šåŸºæœ¬ Thenable</h3>
                <div class="code-block">
                    <pre><code>// æœ€ç®€å•çš„ Thenable
console.log('=== åŸºæœ¬ Thenable ===\n');

const simpleThenable = {
    then(onFulfilled, onRejected) {
        console.log('  then æ–¹æ³•è¢«è°ƒç”¨');
        setTimeout(() => {
            console.log('  æ‰§è¡Œå›è°ƒ');
            onFulfilled('Hello from Thenable');
        }, 100);
    }
};

console.log('åˆ›å»º Promise:');
Promise.resolve(simpleThenable)
    .then(value => {
        console.log('  Promise resolved:', value);
    });

console.log('Promise å·²åˆ›å»º\n');
console.log('è¯´æ˜:');
console.log('  - Thenable è¢« Promise è¯†åˆ«');
console.log('  - then æ–¹æ³•è‡ªåŠ¨è°ƒç”¨');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šThenable æ£€æµ‹</h3>
                <div class="code-block">
                    <pre><code>// æ£€æµ‹ Thenable
console.log('=== Thenable æ£€æµ‹ ===\n');

function isThenable(value) {
    return (
        value !== null &&
        (typeof value === 'object' || typeof value === 'function') &&
        typeof value.then === 'function'
    );
}

const testCases = [
    { name: 'Promise', value: Promise.resolve(42) },
    { name: 'Thenableå¯¹è±¡', value: { then() {} } },
    { name: 'æ™®é€šå¯¹è±¡', value: { value: 42 } },
    { name: 'å‡½æ•°with then', value: Object.assign(() => {}, { then() {} }) },
    { name: 'æ•°å­—', value: 42 },
    { name: 'null', value: null },
    { name: 'undefined', value: undefined }
];

testCases.forEach(({ name, value }) => {
    const result = isThenable(value);
    console.log(`${name}: ${result ? 'âœ“ æ˜¯' : 'âœ— å¦'}`);
});</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šè‡ªå®šä¹‰ Thenable</h3>
                <div class="code-block">
                    <pre><code>// å®ç°å»¶è¿Ÿ Thenable
console.log('=== å»¶è¿Ÿ Thenable ===\n');

class DelayedValue {
    constructor(value, delay) {
        this.value = value;
        this.delay = delay;
    }
    
    then(onFulfilled, onRejected) {
        console.log(`  å»¶è¿Ÿ ${this.delay}ms åè¿”å›`);
        setTimeout(() => {
            try {
                onFulfilled(this.value);
            } catch (e) {
                if (onRejected) onRejected(e);
            }
        }, this.delay);
    }
}

console.log('åˆ›å»ºå»¶è¿Ÿå€¼:');
const delayed = new DelayedValue('Delayed Result', 500);

console.log('å¼€å§‹ç­‰å¾…...');
Promise.resolve(delayed).then(value => {
    console.log('  æ”¶åˆ°:', value);
});</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼šThenable é“¾å¼è°ƒç”¨</h3>
                <div class="code-block">
                    <pre><code>// Thenable åœ¨ Promise é“¾ä¸­
console.log('=== Thenable é“¾å¼è°ƒç”¨ ===\n');

const thenable1 = {
    then(resolve) {
        console.log('  thenable1 æ‰§è¡Œ');
        setTimeout(() => resolve(10), 100);
    }
};

const thenable2 = {
    then(resolve) {
        console.log('  thenable2 æ‰§è¡Œ');
        setTimeout(() => resolve(20), 100);
    }
};

console.log('å¼€å§‹é“¾å¼è°ƒç”¨:');
Promise.resolve(5)
    .then(x => {
        console.log('  æ­¥éª¤1: x =', x);
        return thenable1;
    })
    .then(x => {
        console.log('  æ­¥éª¤2: x =', x);
        return thenable2;
    })
    .then(x => {
        console.log('  æ­¥éª¤3: x =', x);
        return x + 30;
    })
    .then(x => {
        console.log('  æœ€ç»ˆç»“æœ:', x);
    });</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šæ¶æ„ Thenable</h3>
                <div class="code-block">
                    <pre><code>// å±•ç¤ºæ¶æ„ Thenable çš„é˜²å¾¡
console.log('=== æ¶æ„ Thenable ===\n');

const evilThenable = {
    then(onFulfilled, onRejected) {
        console.log('  æ¶æ„ then è¢«è°ƒç”¨');
        
        // è¿åè§„èŒƒï¼šå¤šæ¬¡è°ƒç”¨
        onFulfilled(1);
        console.log('  ç¬¬1æ¬¡è°ƒç”¨ onFulfilled(1)');
        
        onFulfilled(2);
        console.log('  ç¬¬2æ¬¡è°ƒç”¨ onFulfilled(2)');
        
        onRejected(new Error('evil'));
        console.log('  è¿˜è°ƒç”¨äº† onRejected');
    }
};

console.log('Promise å¤„ç†:');
Promise.resolve(evilThenable).then(
    value => console.log('  Promise resolved:', value),
    error => console.log('  Promise rejected:', error)
);

console.log('\nè¯´æ˜:');
console.log('  Promise å®ç°ä¼šå¿½ç•¥åç»­è°ƒç”¨');
console.log('  åªæœ‰ç¬¬ä¸€æ¬¡è°ƒç”¨ç”Ÿæ•ˆ');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šasync/await ä¸ Thenable</h3>
                <div class="code-block">
                    <pre><code>// async/await æ”¯æŒ Thenable
console.log('=== async/await ä¸ Thenable ===\n');

const customThenable = {
    value: 42,
    
    then(resolve) {
        console.log('  Thenable.then è¢«è°ƒç”¨');
        setTimeout(() => {
            console.log('  å¼‚æ­¥è¿”å›å€¼');
            resolve(this.value * 2);
        }, 200);
    }
};

async function test() {
    console.log('å¼€å§‹ await:');
    
    const result = await customThenable;
    console.log('  await ç»“æœ:', result);
    
    const doubled = await {
        then: resolve => setTimeout(() => resolve(result * 2), 100)
    };
    console.log('  å†æ¬¡ await:', doubled);
    
    return doubled + 10;
}

test().then(final => {
    console.log('  æœ€ç»ˆç»“æœ:', final);
});</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
