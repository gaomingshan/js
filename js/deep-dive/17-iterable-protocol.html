<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯è¿­ä»£åè®® - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>å¯è¿­ä»£åè®®ï¼ˆIterable Protocolï¼‰</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>å¯è¿­ä»£åè®®ï¼ˆIterable Protocolï¼‰å’Œè¿­ä»£å™¨åè®®ï¼ˆIterator Protocolï¼‰æ˜¯ ES6 å¼•å…¥çš„æ ¸å¿ƒæ¦‚å¿µï¼Œå®ƒä»¬å®šä¹‰äº†ç»Ÿä¸€çš„éå†æ¥å£ï¼Œä½¿å¾—å„ç§æ•°æ®ç»“æ„å¯ä»¥è¢« for...of ç­‰è¯­æ³•ç»Ÿä¸€å¤„ç†ã€‚</p>
            
            <h2>ä¸€ã€è¿­ä»£å™¨åè®®</h2>
            
            <h3>1.1 Iterator æ¥å£</h3>
            <pre><code>// è¿­ä»£å™¨æ¥å£å®šä¹‰
interface Iterator {
    next(): IteratorResult;
}

interface IteratorResult {
    value: any;        // å½“å‰å€¼
    done: boolean;     // æ˜¯å¦å®Œæˆ
}

// ç¤ºä¾‹
const iterator = {
    current: 0,
    last: 3,
    
    next() {
        if (this.current <= this.last) {
            return {
                value: this.current++,
                done: false
            };
        } else {
            return {
                value: undefined,
                done: true
            };
        }
    }
};

console.log(iterator.next());  // { value: 0, done: false }
console.log(iterator.next());  // { value: 1, done: false }
console.log(iterator.next());  // { value: 2, done: false }
console.log(iterator.next());  // { value: 3, done: false }
console.log(iterator.next());  // { value: undefined, done: true }</code></pre>
            
            <h3>1.2 æ‰‹åŠ¨å®ç°è¿­ä»£å™¨</h3>
            <pre><code>// åˆ›å»ºè¿­ä»£å™¨å·¥å‚å‡½æ•°
function createIterator(array) {
    let index = 0;
    
    return {
        next() {
            if (index < array.length) {
                return {
                    value: array[index++],
                    done: false
                };
            } else {
                return {
                    value: undefined,
                    done: true
                };
            }
        }
    };
}

const iterator = createIterator([1, 2, 3]);
console.log(iterator.next());  // { value: 1, done: false }
console.log(iterator.next());  // { value: 2, done: false }
console.log(iterator.next());  // { value: 3, done: false }
console.log(iterator.next());  // { value: undefined, done: true }</code></pre>
            
            <h2>äºŒã€å¯è¿­ä»£åè®®</h2>
            
            <h3>2.1 Iterable æ¥å£</h3>
            <pre><code>// å¯è¿­ä»£å¯¹è±¡å¿…é¡»å®ç° [Symbol.iterator] æ–¹æ³•
interface Iterable {
    [Symbol.iterator](): Iterator;
}

// å®ç°å¯è¿­ä»£å¯¹è±¡
const iterable = {
    data: [1, 2, 3],
    
    [Symbol.iterator]() {
        let index = 0;
        const data = this.data;
        
        return {
            next() {
                if (index < data.length) {
                    return {
                        value: data[index++],
                        done: false
                    };
                } else {
                    return {
                        value: undefined,
                        done: true
                    };
                }
            }
        };
    }
};

// ä½¿ç”¨ for...of
for (const value of iterable) {
    console.log(value);  // 1, 2, 3
}</code></pre>
            
            <h3>2.2 å†…ç½®å¯è¿­ä»£å¯¹è±¡</h3>
            <pre><code>// JavaScript å†…ç½®çš„å¯è¿­ä»£å¯¹è±¡

// 1. Array
const arr = [1, 2, 3];
for (const item of arr) {
    console.log(item);  // 1, 2, 3
}

// 2. String
const str = 'hello';
for (const char of str) {
    console.log(char);  // h, e, l, l, o
}

// 3. Set
const set = new Set([1, 2, 3]);
for (const item of set) {
    console.log(item);  // 1, 2, 3
}

// 4. Map
const map = new Map([['a', 1], ['b', 2]]);
for (const [key, value] of map) {
    console.log(key, value);  // a 1, b 2
}

// 5. TypedArray
const uint8 = new Uint8Array([1, 2, 3]);
for (const item of uint8) {
    console.log(item);  // 1, 2, 3
}

// 6. arguments å¯¹è±¡
function test() {
    for (const arg of arguments) {
        console.log(arg);
    }
}
test(1, 2, 3);  // 1, 2, 3

// 7. NodeList
// document.querySelectorAll('div') è¿”å›å¯è¿­ä»£å¯¹è±¡</code></pre>
            
            <h2>ä¸‰ã€ä½¿ç”¨è¿­ä»£å™¨</h2>
            
            <h3>3.1 for...of å¾ªç¯</h3>
            <pre><code>// for...of è‡ªåŠ¨è°ƒç”¨è¿­ä»£å™¨
const arr = [1, 2, 3];

for (const item of arr) {
    console.log(item);
}

// ç­‰ä»·äº
const iterator = arr[Symbol.iterator]();
let result = iterator.next();
while (!result.done) {
    const item = result.value;
    console.log(item);
    result = iterator.next();
}</code></pre>
            
            <h3>3.2 å±•å¼€è¿ç®—ç¬¦</h3>
            <pre><code>// å±•å¼€è¿ç®—ç¬¦ä½¿ç”¨è¿­ä»£å™¨
const arr1 = [1, 2, 3];
const arr2 = [...arr1, 4, 5];  // [1, 2, 3, 4, 5]

const str = 'hello';
const chars = [...str];  // ['h', 'e', 'l', 'l', 'o']

const set = new Set([1, 2, 3]);
const arr3 = [...set];  // [1, 2, 3]</code></pre>
            
            <h3>3.3 è§£æ„èµ‹å€¼</h3>
            <pre><code>// è§£æ„ä½¿ç”¨è¿­ä»£å™¨
const [a, b, c] = [1, 2, 3];
console.log(a, b, c);  // 1 2 3

const [x, ...rest] = [1, 2, 3, 4, 5];
console.log(x);     // 1
console.log(rest);  // [2, 3, 4, 5]

// å­—ç¬¦ä¸²è§£æ„
const [first, second] = 'hello';
console.log(first, second);  // h e</code></pre>
            
            <h3>3.4 å…¶ä»–æ¶ˆè´¹è¿­ä»£å™¨çš„æ–¹æ³•</h3>
            <pre><code>// Array.from()
const set = new Set([1, 2, 3]);
const arr = Array.from(set);  // [1, 2, 3]

// Promise.all()
const promises = [Promise.resolve(1), Promise.resolve(2)];
Promise.all(promises).then(console.log);  // [1, 2]

// Promise.race()
Promise.race(promises).then(console.log);  // 1

// Map/Set æ„é€ å‡½æ•°
const map = new Map([['a', 1], ['b', 2]]);
const newSet = new Set([1, 2, 3]);</code></pre>
            
            <h2>å››ã€è‡ªå®šä¹‰å¯è¿­ä»£å¯¹è±¡</h2>
            
            <h3>4.1 èŒƒå›´å¯¹è±¡</h3>
            <pre><code>// å®ç°ä¸€ä¸ªèŒƒå›´å¯¹è±¡
class Range {
    constructor(start, end) {
        this.start = start;
        this.end = end;
    }
    
    [Symbol.iterator]() {
        let current = this.start;
        const end = this.end;
        
        return {
            next() {
                if (current <= end) {
                    return {
                        value: current++,
                        done: false
                    };
                } else {
                    return {
                        value: undefined,
                        done: true
                    };
                }
            }
        };
    }
}

const range = new Range(1, 5);
for (const num of range) {
    console.log(num);  // 1, 2, 3, 4, 5
}

console.log([...range]);  // [1, 2, 3, 4, 5]</code></pre>
            
            <h3>4.2 æ–æ³¢é‚£å¥‘æ•°åˆ—</h3>
            <pre><code>// æ— é™æ–æ³¢é‚£å¥‘æ•°åˆ—
const fibonacci = {
    [Symbol.iterator]() {
        let prev = 0, curr = 1;
        
        return {
            next() {
                const value = curr;
                [prev, curr] = [curr, prev + curr];
                
                return {
                    value,
                    done: false  // æ°¸è¿œä¸ç»“æŸ
                };
            }
        };
    }
};

// å–å‰ 10 ä¸ª
const fibs = [];
const iterator = fibonacci[Symbol.iterator]();
for (let i = 0; i < 10; i++) {
    fibs.push(iterator.next().value);
}
console.log(fibs);  // [1, 1, 2, 3, 5, 8, 13, 21, 34, 55]</code></pre>
            
            <h3>4.3 å¯¹è±¡è¿­ä»£</h3>
            <pre><code>// è®©æ™®é€šå¯¹è±¡å¯è¿­ä»£
const obj = {
    a: 1,
    b: 2,
    c: 3,
    
    [Symbol.iterator]() {
        const keys = Object.keys(this);
        let index = 0;
        
        return {
            next: () => {
                if (index < keys.length) {
                    const key = keys[index++];
                    return {
                        value: [key, this[key]],
                        done: false
                    };
                } else {
                    return {
                        value: undefined,
                        done: true
                    };
                }
            }
        };
    }
};

for (const [key, value] of obj) {
    console.log(key, value);  // a 1, b 2, c 3
}</code></pre>
            
            <h2>äº”ã€è¿­ä»£å™¨çš„æå‰ç»ˆæ­¢</h2>
            
            <h3>5.1 return æ–¹æ³•</h3>
            <pre><code>// å®ç° return æ–¹æ³•
const iterable = {
    [Symbol.iterator]() {
        let count = 0;
        
        return {
            next() {
                return {
                    value: count++,
                    done: false
                };
            },
            
            return() {
                console.log('è¿­ä»£å™¨è¢«æå‰å…³é—­');
                return {
                    value: undefined,
                    done: true
                };
            }
        };
    }
};

// break ä¼šè§¦å‘ return
for (const value of iterable) {
    console.log(value);
    if (value === 2) {
        break;  // è§¦å‘ return()
    }
}</code></pre>
            
            <h3>5.2 è§¦å‘ return çš„æƒ…å†µ</h3>
            <pre><code>// ä»¥ä¸‹æƒ…å†µä¼šè§¦å‘ return()

// 1. break
for (const item of iterable) {
    if (condition) break;
}

// 2. continueï¼ˆåœ¨åµŒå¥—å¾ªç¯ä¸­ï¼‰
outer: for (const item of iterable) {
    for (const x of array) {
        if (condition) continue outer;
    }
}

// 3. return
function test() {
    for (const item of iterable) {
        if (condition) return;
    }
}

// 4. throw
for (const item of iterable) {
    if (condition) throw new Error();
}

// 5. è§£æ„ä¸å®Œæ•´
const [a, b] = iterable;  // åªå–å‰ä¸¤ä¸ªï¼Œè§¦å‘ return</code></pre>
            
            <h2>å…­ã€æœ€ä½³å®è·µ</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>å®ç° Symbol.iterator</strong>ï¼šä½¿å¯¹è±¡å¯è¿­ä»£</li>
                    <li><strong>éµå¾ªåè®®</strong>ï¼šnext() è¿”å›æ­£ç¡®æ ¼å¼</li>
                    <li><strong>å®ç° return()</strong>ï¼šæ”¯æŒæå‰ç»ˆæ­¢</li>
                    <li><strong>ä½¿ç”¨ for...of</strong>ï¼šæ¯”æ‰‹åŠ¨è°ƒç”¨ next() æ›´ç®€æ´</li>
                    <li><strong>åˆ©ç”¨å†…ç½®è¿­ä»£å™¨</strong>ï¼šArrayã€Setã€Map ç­‰</li>
                    <li><strong>æ³¨æ„æ— é™è¿­ä»£å™¨</strong>ï¼šéœ€è¦æ‰‹åŠ¨æ§åˆ¶åœæ­¢</li>
                    <li><strong>ç”Ÿæˆå™¨æ›´ç®€å•</strong>ï¼šå¤æ‚è¿­ä»£å™¨ç”¨ generator</li>
                </ol>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="https://tc39.es/ecma262/#sec-iteration" target="_blank">ECMAScript - Iteration</a></li>
                <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Iteration_protocols" target="_blank">MDN - è¿­ä»£åè®®</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="16-boxing.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šè£…ç®±ä¸æ‹†ç®±</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="17-generator.html" class="nav-link next">ä¸‹ä¸€èŠ‚ï¼šç”Ÿæˆå™¨å‡½æ•°</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šåŸºæœ¬è¿­ä»£å™¨</h3>
                <div class="code-block">
                    <pre><code>// æ‰‹åŠ¨å®ç°è¿­ä»£å™¨
console.log('=== åŸºæœ¬è¿­ä»£å™¨ ===\n');

function createIterator(array) {
    let index = 0;
    
    return {
        next() {
            if (index < array.length) {
                return {
                    value: array[index++],
                    done: false
                };
            } else {
                return {
                    value: undefined,
                    done: true
                };
            }
        }
    };
}

const iterator = createIterator(['a', 'b', 'c']);

console.log('æ‰‹åŠ¨è°ƒç”¨ next():');
console.log('  1.', iterator.next());
console.log('  2.', iterator.next());
console.log('  3.', iterator.next());
console.log('  4.', iterator.next());

console.log('\ndone: true è¡¨ç¤ºè¿­ä»£ç»“æŸ');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šå¯è¿­ä»£å¯¹è±¡</h3>
                <div class="code-block">
                    <pre><code>// å®ç°å¯è¿­ä»£å¯¹è±¡
console.log('=== å¯è¿­ä»£å¯¹è±¡ ===\n');

const myIterable = {
    data: [10, 20, 30],
    
    [Symbol.iterator]() {
        let index = 0;
        const data = this.data;
        
        return {
            next() {
                if (index < data.length) {
                    return { value: data[index++], done: false };
                } else {
                    return { value: undefined, done: true };
                }
            }
        };
    }
};

console.log('ä½¿ç”¨ for...of:');
for (const value of myIterable) {
    console.log('  å€¼:', value);
}

console.log('\nä½¿ç”¨å±•å¼€è¿ç®—ç¬¦:');
console.log('  [...myIterable]:', [...myIterable]);

console.log('\nä½¿ç”¨è§£æ„:');
const [first, second] = myIterable;
console.log('  first:', first, 'second:', second);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šRange èŒƒå›´å¯¹è±¡</h3>
                <div class="code-block">
                    <pre><code>// å®ç°èŒƒå›´è¿­ä»£å™¨
console.log('=== Range å¯¹è±¡ ===\n');

class Range {
    constructor(start, end, step = 1) {
        this.start = start;
        this.end = end;
        this.step = step;
    }
    
    [Symbol.iterator]() {
        let current = this.start;
        const end = this.end;
        const step = this.step;
        
        return {
            next() {
                if (current <= end) {
                    const value = current;
                    current += step;
                    return { value, done: false };
                } else {
                    return { value: undefined, done: true };
                }
            }
        };
    }
}

console.log('Range(1, 5):');
const range1 = new Range(1, 5);
console.log('  [...]:', [...range1]);

console.log('\nRange(0, 10, 2):');
const range2 = new Range(0, 10, 2);
for (const num of range2) {
    console.log('  ' + num);
}</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼šæ–æ³¢é‚£å¥‘è¿­ä»£å™¨</h3>
                <div class="code-block">
                    <pre><code>// æ— é™æ–æ³¢é‚£å¥‘æ•°åˆ—
console.log('=== æ–æ³¢é‚£å¥‘è¿­ä»£å™¨ ===\n');

const fibonacci = {
    [Symbol.iterator]() {
        let prev = 0, curr = 1;
        
        return {
            next() {
                const value = curr;
                [prev, curr] = [curr, prev + curr];
                return { value, done: false };
            }
        };
    }
};

console.log('å‰ 10 ä¸ªæ–æ³¢é‚£å¥‘æ•°:');
const fibs = [];
const iter = fibonacci[Symbol.iterator]();
for (let i = 0; i < 10; i++) {
    fibs.push(iter.next().value);
}
console.log('  ' + fibs.join(', '));

console.log('\nä½¿ç”¨ for...ofï¼ˆéœ€è¦æ‰‹åŠ¨ breakï¼‰:');
let count = 0;
for (const fib of fibonacci) {
    console.log('  ' + fib);
    if (++count >= 5) break;
}</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šå¯¹è±¡è¿­ä»£</h3>
                <div class="code-block">
                    <pre><code>// è®©æ™®é€šå¯¹è±¡å¯è¿­ä»£
console.log('=== å¯¹è±¡è¿­ä»£ ===\n');

const user = {
    name: 'Alice',
    age: 25,
    city: 'Beijing',
    
    [Symbol.iterator]() {
        const keys = Object.keys(this).filter(k => k !== Symbol.iterator);
        let index = 0;
        
        return {
            next: () => {
                if (index < keys.length) {
                    const key = keys[index++];
                    return {
                        value: [key, this[key]],
                        done: false
                    };
                } else {
                    return { value: undefined, done: true };
                }
            }
        };
    }
};

console.log('éå†å¯¹è±¡:');
for (const [key, value] of user) {
    console.log(`  ${key}: ${value}`);
}

console.log('\nè½¬æ¢ä¸º Map:');
const map = new Map(user);
console.log('  map.size:', map.size);
console.log('  map.get("name"):', map.get('name'));</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šæå‰ç»ˆæ­¢</h3>
                <div class="code-block">
                    <pre><code>// è¿­ä»£å™¨çš„ return æ–¹æ³•
console.log('=== æå‰ç»ˆæ­¢ ===\n');

const iterable = {
    [Symbol.iterator]() {
        let count = 0;
        
        return {
            next() {
                console.log(`  next() è¢«è°ƒç”¨ï¼Œcount = ${count}`);
                return { value: count++, done: false };
            },
            
            return() {
                console.log('  return() è¢«è°ƒç”¨ï¼ˆæå‰ç»ˆæ­¢ï¼‰');
                return { value: undefined, done: true };
            }
        };
    }
};

console.log('ä½¿ç”¨ break æå‰ç»ˆæ­¢:');
for (const value of iterable) {
    console.log(`  å€¼: ${value}`);
    if (value === 2) {
        console.log('  æ‰§è¡Œ break');
        break;
    }
}

console.log('\nè¯´æ˜:');
console.log('  break ä¼šè§¦å‘ return() æ–¹æ³•');
console.log('  ç”¨äºæ¸…ç†èµ„æºã€å…³é—­è¿æ¥ç­‰');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
