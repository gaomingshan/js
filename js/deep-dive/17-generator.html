<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæˆå™¨å‡½æ•°æ·±å…¥ - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>ç”Ÿæˆå™¨å‡½æ•°æ·±å…¥</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>ç”Ÿæˆå™¨ï¼ˆGeneratorï¼‰æ˜¯ ES6 å¼•å…¥çš„ä¸€ç§ç‰¹æ®Šå‡½æ•°ï¼Œå¯ä»¥æš‚åœæ‰§è¡Œå’Œæ¢å¤æ‰§è¡Œã€‚å®ƒå¤§å¤§ç®€åŒ–äº†è¿­ä»£å™¨çš„å®ç°ï¼Œå¹¶ä¸ºå¼‚æ­¥ç¼–ç¨‹æä¾›äº†æ–°çš„å¯èƒ½ã€‚</p>
            
            <h2>ä¸€ã€ç”Ÿæˆå™¨åŸºç¡€</h2>
            
            <h3>1.1 å®šä¹‰ç”Ÿæˆå™¨</h3>
            <pre><code>// function* è¯­æ³•å®šä¹‰ç”Ÿæˆå™¨
function* simpleGenerator() {
    yield 1;
    yield 2;
    yield 3;
}

// è°ƒç”¨ç”Ÿæˆå™¨è¿”å›è¿­ä»£å™¨
const gen = simpleGenerator();
console.log(gen.next());  // { value: 1, done: false }
console.log(gen.next());  // { value: 2, done: false }
console.log(gen.next());  // { value: 3, done: false }
console.log(gen.next());  // { value: undefined, done: true }</code></pre>
            
            <h3>1.2 yield å…³é”®å­—</h3>
            <pre><code>// yield æš‚åœæ‰§è¡Œå¹¶è¿”å›å€¼
function* demo() {
    console.log('å¼€å§‹');
    yield 'first';
    console.log('ç»§ç»­');
    yield 'second';
    console.log('ç»“æŸ');
    return 'done';
}

const gen = demo();
console.log(gen.next());  // "å¼€å§‹" â†’ { value: 'first', done: false }
console.log(gen.next());  // "ç»§ç»­" â†’ { value: 'second', done: false }
console.log(gen.next());  // "ç»“æŸ" â†’ { value: 'done', done: true }</code></pre>
            
            <h3>1.3 ç”Ÿæˆå™¨æ˜¯è¿­ä»£å™¨</h3>
            <pre><code>// ç”Ÿæˆå™¨å¯¹è±¡å®ç°äº†è¿­ä»£å™¨æ¥å£
function* numbers() {
    yield 1;
    yield 2;
    yield 3;
}

// å¯ä»¥ç”¨ for...of éå†
for (const num of numbers()) {
    console.log(num);  // 1, 2, 3
}

// å¯ä»¥ç”¨å±•å¼€è¿ç®—ç¬¦
console.log([...numbers()]);  // [1, 2, 3]

// å¯ä»¥ç”¨è§£æ„
const [a, b, c] = numbers();
console.log(a, b, c);  // 1 2 3</code></pre>
            
            <h2>äºŒã€yield* å§”æ‰˜</h2>
            
            <h3>2.1 åŸºæœ¬ç”¨æ³•</h3>
            <pre><code>// yield* å§”æ‰˜ç»™å¦ä¸€ä¸ªç”Ÿæˆå™¨
function* inner() {
    yield 2;
    yield 3;
}

function* outer() {
    yield 1;
    yield* inner();  // å§”æ‰˜
    yield 4;
}

console.log([...outer()]);  // [1, 2, 3, 4]

// ç­‰ä»·äº
function* outerEquivalent() {
    yield 1;
    for (const value of inner()) {
        yield value;
    }
    yield 4;
}</code></pre>
            
            <h3>2.2 å§”æ‰˜ä»»æ„å¯è¿­ä»£å¯¹è±¡</h3>
            <pre><code>// yield* å¯ä»¥å§”æ‰˜ä»»æ„å¯è¿­ä»£å¯¹è±¡
function* gen() {
    yield* [1, 2, 3];      // æ•°ç»„
    yield* 'hello';        // å­—ç¬¦ä¸²
    yield* new Set([4, 5]); // Set
}

console.log([...gen()]);  // [1, 2, 3, 'h', 'e', 'l', 'l', 'o', 4, 5]</code></pre>
            
            <h3>2.3 è·å–è¿”å›å€¼</h3>
            <pre><code>// yield* è¡¨è¾¾å¼çš„å€¼æ˜¯è¢«å§”æ‰˜ç”Ÿæˆå™¨çš„è¿”å›å€¼
function* inner() {
    yield 1;
    yield 2;
    return 'inner done';
}

function* outer() {
    const result = yield* inner();
    console.log('å†…éƒ¨è¿”å›:', result);  // "inner done"
    yield 3;
}

for (const value of outer()) {
    console.log(value);  // 1, 2, 3
}</code></pre>
            
            <h2>ä¸‰ã€ç”Ÿæˆå™¨çš„åŒå‘é€šä¿¡</h2>
            
            <h3>3.1 next() ä¼ å‚</h3>
            <pre><code>// next() å¯ä»¥å‘ç”Ÿæˆå™¨ä¼ é€’å‚æ•°
function* gen() {
    const x = yield 'x';
    console.log('æ”¶åˆ° x:', x);
    
    const y = yield 'y';
    console.log('æ”¶åˆ° y:', y);
    
    return x + y;
}

const g = gen();
console.log(g.next());       // { value: 'x', done: false }
console.log(g.next(10));     // æ”¶åˆ° x: 10, { value: 'y', done: false }
console.log(g.next(20));     // æ”¶åˆ° y: 20, { value: 30, done: true }</code></pre>
            
            <h3>3.2 é¦–æ¬¡ next() çš„å‚æ•°</h3>
            <pre><code>// æ³¨æ„ï¼šç¬¬ä¸€æ¬¡ next() çš„å‚æ•°ä¼šè¢«å¿½ç•¥
function* gen() {
    console.log('ç¬¬ä¸€æ¬¡å‚æ•°:', yield);
}

const g = gen();
g.next('ignored');   // å‚æ•°è¢«å¿½ç•¥
g.next('received');  // ç¬¬ä¸€æ¬¡å‚æ•°: received

// åŸå› ï¼šç¬¬ä¸€æ¬¡ next() æ˜¯å¯åŠ¨ç”Ÿæˆå™¨ï¼Œè¿˜æ²¡æœ‰ yield ç­‰å¾…æ¥æ”¶å€¼</code></pre>
            
            <h3>3.3 throw() æ–¹æ³•</h3>
            <pre><code>// throw() å‘ç”Ÿæˆå™¨å†…éƒ¨æŠ›å‡ºé”™è¯¯
function* gen() {
    try {
        yield 1;
    } catch (e) {
        console.log('æ•è·é”™è¯¯:', e);
    }
    yield 2;
}

const g = gen();
console.log(g.next());        // { value: 1, done: false }
console.log(g.throw('é”™è¯¯')); // æ•è·é”™è¯¯: é”™è¯¯, { value: 2, done: false }
console.log(g.next());        // { value: undefined, done: true }</code></pre>
            
            <h3>3.4 return() æ–¹æ³•</h3>
            <pre><code>// return() å¼ºåˆ¶ç»“æŸç”Ÿæˆå™¨
function* gen() {
    yield 1;
    yield 2;
    yield 3;
}

const g = gen();
console.log(g.next());         // { value: 1, done: false }
console.log(g.return('ç»“æŸ')); // { value: 'ç»“æŸ', done: true }
console.log(g.next());         // { value: undefined, done: true }</code></pre>
            
            <h2>å››ã€ç”Ÿæˆå™¨çš„åº”ç”¨</h2>
            
            <h3>4.1 å®ç° Range</h3>
            <pre><code>// ç”¨ç”Ÿæˆå™¨å®ç°èŒƒå›´
function* range(start, end, step = 1) {
    for (let i = start; i <= end; i += step) {
        yield i;
    }
}

console.log([...range(1, 5)]);      // [1, 2, 3, 4, 5]
console.log([...range(0, 10, 2)]);  // [0, 2, 4, 6, 8, 10]</code></pre>
            
            <h3>4.2 æ–æ³¢é‚£å¥‘æ•°åˆ—</h3>
            <pre><code>// æ— é™æ–æ³¢é‚£å¥‘æ•°åˆ—
function* fibonacci() {
    let [prev, curr] = [0, 1];
    while (true) {
        yield curr;
        [prev, curr] = [curr, prev + curr];
    }
}

// å–å‰ 10 ä¸ª
const fibs = [];
const gen = fibonacci();
for (let i = 0; i < 10; i++) {
    fibs.push(gen.next().value);
}
console.log(fibs);  // [1, 1, 2, 3, 5, 8, 13, 21, 34, 55]</code></pre>
            
            <h3>4.3 æ ‘çš„éå†</h3>
            <pre><code>// äºŒå‰æ ‘çš„ä¸­åºéå†
class TreeNode {
    constructor(value, left = null, right = null) {
        this.value = value;
        this.left = left;
        this.right = right;
    }
    
    *[Symbol.iterator]() {
        if (this.left) yield* this.left;
        yield this.value;
        if (this.right) yield* this.right;
    }
}

const tree = new TreeNode(
    4,
    new TreeNode(2, new TreeNode(1), new TreeNode(3)),
    new TreeNode(6, new TreeNode(5), new TreeNode(7))
);

console.log([...tree]);  // [1, 2, 3, 4, 5, 6, 7]</code></pre>
            
            <h3>4.4 æƒ°æ€§æ±‚å€¼</h3>
            <pre><code>// æƒ°æ€§ç”Ÿæˆæ•°æ®
function* lazyMap(iterable, fn) {
    for (const item of iterable) {
        yield fn(item);
    }
}

function* lazyFilter(iterable, predicate) {
    for (const item of iterable) {
        if (predicate(item)) {
            yield item;
        }
    }
}

// é“¾å¼è°ƒç”¨
const numbers = [1, 2, 3, 4, 5];
const result = lazyMap(
    lazyFilter(numbers, x => x % 2 === 0),
    x => x * 2
);

console.log([...result]);  // [4, 8]ï¼ˆåªè®¡ç®—éœ€è¦çš„éƒ¨åˆ†ï¼‰</code></pre>
            
            <h2>äº”ã€ç”Ÿæˆå™¨ä¸å¼‚æ­¥</h2>
            
            <h3>5.1 æ¨¡æ‹Ÿ async/await</h3>
            <pre><code>// ç”Ÿæˆå™¨å¯ä»¥æ¨¡æ‹Ÿ async/await
function run(genFunc) {
    const gen = genFunc();
    
    function step(arg) {
        const result = gen.next(arg);
        
        if (result.done) {
            return result.value;
        }
        
        return Promise.resolve(result.value).then(step);
    }
    
    return step();
}

// ä½¿ç”¨
function* fetchData() {
    const user = yield fetch('/api/user');
    const posts = yield fetch(`/api/posts/${user.id}`);
    return posts;
}

// run(fetchData).then(posts => console.log(posts));</code></pre>
            
            <h3>5.2 co åº“åŸç†</h3>
            <pre><code>// co åº“çš„ç®€åŒ–å®ç°
function co(genFunc) {
    return new Promise((resolve, reject) => {
        const gen = genFunc();
        
        function step(nextFunc) {
            let result;
            try {
                result = nextFunc();
            } catch(e) {
                return reject(e);
            }
            
            if (result.done) {
                return resolve(result.value);
            }
            
            Promise.resolve(result.value).then(
                value => step(() => gen.next(value)),
                err => step(() => gen.throw(err))
            );
        }
        
        step(() => gen.next());
    });
}</code></pre>
            
            <h2>å…­ã€æœ€ä½³å®è·µ</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>ç®€åŒ–è¿­ä»£å™¨</strong>ï¼šç”¨ç”Ÿæˆå™¨ä»£æ›¿æ‰‹åŠ¨å®ç°</li>
                    <li><strong>æƒ°æ€§è®¡ç®—</strong>ï¼šæŒ‰éœ€ç”Ÿæˆæ•°æ®ï¼ŒèŠ‚çœå†…å­˜</li>
                    <li><strong>yield* å§”æ‰˜</strong>ï¼šå¤ç”¨å…¶ä»–ç”Ÿæˆå™¨</li>
                    <li><strong>åŒå‘é€šä¿¡</strong>ï¼šåˆ©ç”¨ next() ä¼ å‚</li>
                    <li><strong>é”™è¯¯å¤„ç†</strong>ï¼šä½¿ç”¨ try/catch å’Œ throw()</li>
                    <li><strong>æå‰ç»“æŸ</strong>ï¼šä½¿ç”¨ return() æ¸…ç†èµ„æº</li>
                    <li><strong>ç°ä»£å¼‚æ­¥</strong>ï¼šasync/await æ›´ç®€æ´</li>
                </ol>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="https://tc39.es/ecma262/#sec-generator-function-definitions" target="_blank">ECMAScript - Generator Functions</a></li>
                <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Generator" target="_blank">MDN - Generator</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="17-iterable-protocol.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šå¯è¿­ä»£åè®®</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="17-async-iterator.html" class="nav-link next">ä¸‹ä¸€èŠ‚ï¼šå¼‚æ­¥è¿­ä»£å™¨</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šåŸºæœ¬ç”Ÿæˆå™¨</h3>
                <div class="code-block">
                    <pre><code>// ç”Ÿæˆå™¨åŸºç¡€
console.log('=== åŸºæœ¬ç”Ÿæˆå™¨ ===\n');

function* simpleGen() {
    console.log('å¼€å§‹æ‰§è¡Œ');
    yield 1;
    console.log('ç¬¬ä¸€æ¬¡æš‚åœå');
    yield 2;
    console.log('ç¬¬äºŒæ¬¡æš‚åœå');
    yield 3;
    console.log('ç»“æŸ');
}

const gen = simpleGen();

console.log('è°ƒç”¨ next():');
console.log('1.', gen.next());
console.log('2.', gen.next());
console.log('3.', gen.next());
console.log('4.', gen.next());

console.log('\nä½¿ç”¨ for...of:');
for (const value of simpleGen()) {
    console.log('  å€¼:', value);
}</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šyield* å§”æ‰˜</h3>
                <div class="code-block">
                    <pre><code>// yield* å§”æ‰˜æ¼”ç¤º
console.log('=== yield* å§”æ‰˜ ===\n');

function* inner() {
    console.log('  è¿›å…¥ inner');
    yield 'a';
    yield 'b';
    console.log('  ç¦»å¼€ inner');
    return 'innerå®Œæˆ';
}

function* outer() {
    console.log('outer å¼€å§‹');
    yield 1;
    
    console.log('å§”æ‰˜ç»™ inner');
    const result = yield* inner();
    console.log('inner è¿”å›å€¼:', result);
    
    yield 2;
    console.log('outer ç»“æŸ');
}

const gen = outer();
console.log('æ‰§è¡Œè¿‡ç¨‹:');
console.log('1.', gen.next());
console.log('2.', gen.next());
console.log('3.', gen.next());
console.log('4.', gen.next());
console.log('5.', gen.next());</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šåŒå‘é€šä¿¡</h3>
                <div class="code-block">
                    <pre><code>// next() ä¼ å‚
console.log('=== åŒå‘é€šä¿¡ ===\n');

function* conversation() {
    console.log('ç”Ÿæˆå™¨: ä½ å¥½ï¼');
    const name = yield 'è¯·å‘Šè¯‰æˆ‘ä½ çš„åå­—';
    console.log('ç”Ÿæˆå™¨: æ”¶åˆ°åå­— -', name);
    
    const age = yield 'è¯·å‘Šè¯‰æˆ‘ä½ çš„å¹´é¾„';
    console.log('ç”Ÿæˆå™¨: æ”¶åˆ°å¹´é¾„ -', age);
    
    return `ä½ æ˜¯ ${name}ï¼Œ${age} å²`;
}

const gen = conversation();

console.log('1. å¯åŠ¨:');
console.log('  ', gen.next());

console.log('\n2. ä¼ å…¥åå­—:');
console.log('  ', gen.next('Alice'));

console.log('\n3. ä¼ å…¥å¹´é¾„:');
console.log('  ', gen.next(25));</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼šthrow() å’Œ return()</h3>
                <div class="code-block">
                    <pre><code>// é”™è¯¯å¤„ç†å’Œæå‰ç»“æŸ
console.log('=== throw() å’Œ return() ===\n');

function* resilientGen() {
    try {
        yield 1;
        yield 2;
    } catch (e) {
        console.log('  æ•è·é”™è¯¯:', e);
        yield 'recovered';
    }
    yield 3;
}

console.log('æµ‹è¯• throw():');
const gen1 = resilientGen();
console.log('1.', gen1.next());
console.log('2.', gen1.throw('é”™è¯¯!'));
console.log('3.', gen1.next());

console.log('\næµ‹è¯• return():');
const gen2 = resilientGen();
console.log('1.', gen2.next());
console.log('2.', gen2.return('æå‰ç»“æŸ'));
console.log('3.', gen2.next());</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šå®ç”¨ç”Ÿæˆå™¨</h3>
                <div class="code-block">
                    <pre><code>// å®ç”¨ç”Ÿæˆå™¨å‡½æ•°
console.log('=== å®ç”¨ç”Ÿæˆå™¨ ===\n');

// èŒƒå›´ç”Ÿæˆå™¨
function* range(start, end, step = 1) {
    for (let i = start; i <= end; i += step) {
        yield i;
    }
}

console.log('Range(1, 5):');
console.log('  ', [...range(1, 5)]);

console.log('\nRange(0, 10, 2):');
console.log('  ', [...range(0, 10, 2)]);

// æ— é™è®¡æ•°å™¨
function* counter(start = 0) {
    let count = start;
    while (true) {
        yield count++;
    }
}

console.log('\nå‰ 5 ä¸ªè®¡æ•°:');
const cnt = counter(10);
for (let i = 0; i < 5; i++) {
    console.log('  ', cnt.next().value);
}

// å¾ªç¯ç”Ÿæˆå™¨
function* cycle(array) {
    while (true) {
        for (const item of array) {
            yield item;
        }
    }
}

console.log('\nå¾ªç¯ [a, b, c] å– 7 ä¸ª:');
const cyc = cycle(['a', 'b', 'c']);
const items = [];
for (let i = 0; i < 7; i++) {
    items.push(cyc.next().value);
}
console.log('  ', items.join(', '));</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šæƒ°æ€§æ±‚å€¼</h3>
                <div class="code-block">
                    <pre><code>// æƒ°æ€§è®¡ç®—é“¾
console.log('=== æƒ°æ€§æ±‚å€¼ ===\n');

function* lazyMap(iterable, fn) {
    console.log('  lazyMap åˆ›å»º');
    for (const item of iterable) {
        console.log(`  mapping: ${item}`);
        yield fn(item);
    }
}

function* lazyFilter(iterable, predicate) {
    console.log('  lazyFilter åˆ›å»º');
    for (const item of iterable) {
        console.log(`  filtering: ${item}`);
        if (predicate(item)) {
            yield item;
        }
    }
}

const numbers = [1, 2, 3, 4, 5];

console.log('åˆ›å»ºæƒ°æ€§é“¾:');
const chain = lazyMap(
    lazyFilter(numbers, x => x % 2 === 0),
    x => x * 2
);

console.log('\nå¼€å§‹æ±‚å€¼ï¼ˆå– 2 ä¸ªï¼‰:');
const iterator = chain[Symbol.iterator]();
console.log('ç¬¬1ä¸ª:', iterator.next().value);
console.log('ç¬¬2ä¸ª:', iterator.next().value);

console.log('\nè¯´æ˜: åªè®¡ç®—éœ€è¦çš„éƒ¨åˆ†ï¼Œå…¶ä»–æ•°å­—æœªå¤„ç†');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
