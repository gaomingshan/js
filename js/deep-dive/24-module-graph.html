<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¨¡å—ä¾èµ–å›¾ - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>æ¨¡å—ä¾èµ–å›¾</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>æ¨¡å—ä¾èµ–å›¾ï¼ˆModule Dependency Graphï¼‰æè¿°äº†æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚ç†è§£ä¾èµ–å›¾æœ‰åŠ©äºä¼˜åŒ–æ‰“åŒ…ã€ä»£ç åˆ†å‰²å’Œæ€§èƒ½è°ƒä¼˜ã€‚</p>
            
            <h2>ä¸€ã€ä¾èµ–å›¾åŸºç¡€</h2>
            
            <h3>1.1 å›¾çš„ç»“æ„</h3>
            <pre><code>// ç¤ºä¾‹æ¨¡å—ç»“æ„
// app.js
import { utilA } from './utilA.js';
import { utilB } from './utilB.js';

// utilA.js
import { helper } from './helper.js';

// utilB.js
import { helper } from './helper.js';

// helper.js
export function helper() {}

// ä¾èµ–å›¾ï¼š
//     app.js
//    /      \
// utilA    utilB
//    \      /
//    helper</code></pre>
            
            <h3>1.2 å›¾çš„éå†</h3>
            <pre><code>// æ·±åº¦ä¼˜å…ˆéå†ï¼ˆDFSï¼‰
function dfs(module, visited = new Set()) {
    if (visited.has(module)) return;
    visited.add(module);
    
    console.log('è®¿é—®:', module.id);
    
    for (const dep of module.dependencies) {
        dfs(dep, visited);
    }
}

// å¹¿åº¦ä¼˜å…ˆéå†ï¼ˆBFSï¼‰
function bfs(module) {
    const queue = [module];
    const visited = new Set([module]);
    
    while (queue.length > 0) {
        const current = queue.shift();
        console.log('è®¿é—®:', current.id);
        
        for (const dep of current.dependencies) {
            if (!visited.has(dep)) {
                visited.add(dep);
                queue.push(dep);
            }
        }
    }
}</code></pre>
            
            <h2>äºŒã€å¾ªç¯ä¾èµ–æ£€æµ‹</h2>
            
            <h3>2.1 æ£€æµ‹ç®—æ³•</h3>
            <pre><code>// ä½¿ç”¨ DFS æ£€æµ‹å¾ªç¯ä¾èµ–
function detectCycle(module, visited = new Set(), stack = new Set()) {
    if (stack.has(module)) {
        return true;  // å‘ç°å¾ªç¯
    }
    
    if (visited.has(module)) {
        return false;  // å·²è®¿é—®ï¼Œæ— å¾ªç¯
    }
    
    visited.add(module);
    stack.add(module);
    
    for (const dep of module.dependencies) {
        if (detectCycle(dep, visited, stack)) {
            console.log('å¾ªç¯ä¾èµ–:', module.id, '->', dep.id);
            return true;
        }
    }
    
    stack.delete(module);
    return false;
}</code></pre>
            
            <h3>2.2 è§£å†³å¾ªç¯ä¾èµ–</h3>
            <pre><code>// æ–¹æ³• 1ï¼šé‡æ„ä»£ç 
// ä¸å¥½ âŒ
// a.js
import { b } from './b.js';
export const a = 'A' + b;

// b.js
import { a } from './a.js';
export const b = 'B' + a;

// å¥½ âœ“
// a.js
export const a = 'A';

// b.js
export const b = 'B';

// combined.js
import { a } from './a.js';
import { b } from './b.js';
export const combined = a + b;

// æ–¹æ³• 2ï¼šå»¶è¿Ÿå¯¼å…¥
// a.js
export const a = 'A';
export function getB() {
    return require('./b.js').b;
}</code></pre>
            
            <h2>ä¸‰ã€æ‹“æ‰‘æ’åº</h2>
            
            <h3>3.1 Kahn ç®—æ³•</h3>
            <pre><code>// æ‹“æ‰‘æ’åºï¼šç¡®å®šæ¨¡å—åŠ è½½é¡ºåº
function topologicalSort(modules) {
    const inDegree = new Map();
    const result = [];
    
    // è®¡ç®—å…¥åº¦
    for (const module of modules) {
        if (!inDegree.has(module)) {
            inDegree.set(module, 0);
        }
        for (const dep of module.dependencies) {
            inDegree.set(dep, (inDegree.get(dep) || 0) + 1);
        }
    }
    
    // æ‰¾åˆ°æ‰€æœ‰å…¥åº¦ä¸º 0 çš„èŠ‚ç‚¹
    const queue = modules.filter(m => inDegree.get(m) === 0);
    
    while (queue.length > 0) {
        const module = queue.shift();
        result.push(module);
        
        for (const dep of module.dependencies) {
            inDegree.set(dep, inDegree.get(dep) - 1);
            if (inDegree.get(dep) === 0) {
                queue.push(dep);
            }
        }
    }
    
    return result;
}</code></pre>
            
            <h2>å››ã€ä»£ç åˆ†å‰²</h2>
            
            <h3>4.1 åŠ¨æ€å¯¼å…¥ç‚¹</h3>
            <pre><code>// è¯†åˆ«ä»£ç åˆ†å‰²ç‚¹
// app.js
import { common } from './common.js';

// è·¯ç”±æ‡’åŠ è½½
const routes = {
    '/home': () => import('./pages/home.js'),
    '/about': () => import('./pages/about.js'),
    '/contact': () => import('./pages/contact.js')
};

// ä¾èµ–å›¾ä¸­çš„åˆ†å‰²ç‚¹
//      app.js
//         |
//      common.js
//      /  |  \
//   home about contactï¼ˆåŠ¨æ€å¯¼å…¥ï¼‰</code></pre>
            
            <h3>4.2 Chunk åˆ’åˆ†</h3>
            <pre><code>// Webpack é…ç½®ç¤ºä¾‹
module.exports = {
    optimization: {
        splitChunks: {
            chunks: 'all',
            cacheGroups: {
                // æå–ç¬¬ä¸‰æ–¹åº“
                vendors: {
                    test: /[\\/]node_modules[\\/]/,
                    name: 'vendors',
                    priority: 10
                },
                // æå–å…¬å…±ä»£ç 
                commons: {
                    name: 'commons',
                    minChunks: 2,
                    priority: 5
                }
            }
        }
    }
};</code></pre>
            
            <h2>äº”ã€Tree Shaking</h2>
            
            <h3>5.1 æ­»ä»£ç æ¶ˆé™¤</h3>
            <pre><code>// utils.js
export function usedFunction() {
    return 'used';
}

export function unusedFunction() {
    return 'unused';  // æœªä½¿ç”¨
}

// app.js
import { usedFunction } from './utils.js';

console.log(usedFunction());

// æ‰“åŒ…åï¼šunusedFunction è¢«ç§»é™¤

// ä¾èµ–å›¾åˆ†æï¼š
// - æ ‡è®°æ‰€æœ‰ä½¿ç”¨çš„å¯¼å‡º
// - åˆ é™¤æœªæ ‡è®°çš„ä»£ç </code></pre>
            
            <h3>5.2 å‰¯ä½œç”¨å¤„ç†</h3>
            <pre><code>// package.json
{
    "sideEffects": false  // æ‰€æœ‰æ–‡ä»¶æ— å‰¯ä½œç”¨
}

// æˆ–æŒ‡å®šæœ‰å‰¯ä½œç”¨çš„æ–‡ä»¶
{
    "sideEffects": [
        "./src/polyfill.js",
        "*.css"
    ]
}

// æœ‰å‰¯ä½œç”¨çš„ä»£ç ï¼ˆä¸èƒ½è¢«åˆ é™¤ï¼‰
// polyfill.js
Array.prototype.myMethod = function() {};  // å‰¯ä½œç”¨

// æ— å‰¯ä½œç”¨çš„ä»£ç ï¼ˆå¯ä»¥è¢« tree-shakeï¼‰
// utils.js
export function pureFunction(x) {
    return x * 2;
}</code></pre>
            
            <h2>å…­ã€æ€§èƒ½ä¼˜åŒ–</h2>
            
            <h3>6.1 å¹¶è¡ŒåŠ è½½</h3>
            <pre><code>// è¯†åˆ«å¯å¹¶è¡ŒåŠ è½½çš„æ¨¡å—
//      app.js
//     /  |  \
//    A   B   Cï¼ˆç›¸äº’ç‹¬ç«‹ï¼Œå¯å¹¶è¡Œï¼‰
//
// A, B, C å¯ä»¥å¹¶è¡Œä¸‹è½½å’Œæ‰§è¡Œ

// å®ç°å¹¶è¡ŒåŠ è½½
async function loadParallel() {
    const [modA, modB, modC] = await Promise.all([
        import('./a.js'),
        import('./b.js'),
        import('./c.js')
    ]);
    
    return { modA, modB, modC };
}</code></pre>
            
            <h3>6.2 é¢„åŠ è½½</h3>
            <pre><code>// é¢„åŠ è½½å…³é”®è·¯å¾„æ¨¡å—
&lt;link rel="modulepreload" href="./critical.js"&gt;

// é¢„æµ‹æ€§é¢„åŠ è½½
const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
        if (entry.isIntersecting) {
            import('./lazy-module.js');
        }
    });
});

observer.observe(document.querySelector('#trigger'));</code></pre>
            
            <h2>ä¸ƒã€æœ€ä½³å®è·µ</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>é¿å…å¾ªç¯ä¾èµ–</strong>ï¼šé‡æ„ä»£ç ç»“æ„</li>
                    <li><strong>åˆç†ä»£ç åˆ†å‰²</strong>ï¼šæŒ‰è·¯ç”±æˆ–åŠŸèƒ½</li>
                    <li><strong>æ ‡è®°å‰¯ä½œç”¨</strong>ï¼šå¸®åŠ© tree shaking</li>
                    <li><strong>ç›‘æ§åŒ…å¤§å°</strong>ï¼šä½¿ç”¨åˆ†æå·¥å…·</li>
                    <li><strong>é¢„åŠ è½½å…³é”®èµ„æº</strong>ï¼šæå‡æ€§èƒ½</li>
                </ol>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="https://webpack.js.org/concepts/dependency-graph/" target="_blank">Webpack - Dependency Graph</a></li>
                <li><a href="https://webpack.js.org/guides/tree-shaking/" target="_blank">Webpack - Tree Shaking</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="24-module-resolution.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šæ¨¡å—è§£æç®—æ³•</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="24-dynamic-import.html" class="nav-link next">ä¸‹ä¸€èŠ‚ï¼šåŠ¨æ€å¯¼å…¥æœºåˆ¶</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šä¾èµ–å›¾æ¨¡æ‹Ÿ</h3>
                <div class="code-block">
                    <pre><code>// æ¨¡æ‹Ÿæ¨¡å—ä¾èµ–å›¾
console.log('=== ä¾èµ–å›¾ ===\n');

class Module {
    constructor(id) {
        this.id = id;
        this.dependencies = [];
    }
    
    addDependency(module) {
        this.dependencies.push(module);
    }
}

const app = new Module('app');
const utilA = new Module('utilA');
const utilB = new Module('utilB');
const helper = new Module('helper');

app.addDependency(utilA);
app.addDependency(utilB);
utilA.addDependency(helper);
utilB.addDependency(helper);

console.log('ä¾èµ–å…³ç³»:');
console.log('  app -> utilA, utilB');
console.log('  utilA -> helper');
console.log('  utilB -> helper');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šå¾ªç¯ä¾èµ–æ£€æµ‹</h3>
                <div class="code-block">
                    <pre><code>// å¾ªç¯ä¾èµ–æ£€æµ‹
console.log('=== å¾ªç¯ä¾èµ–æ£€æµ‹ ===\n');

class Module {
    constructor(id) {
        this.id = id;
        this.dependencies = [];
    }
}

function detectCycle(module, visited = new Set(), stack = new Set()) {
    if (stack.has(module.id)) {
        return true;
    }
    if (visited.has(module.id)) {
        return false;
    }
    
    visited.add(module.id);
    stack.add(module.id);
    
    for (const dep of module.dependencies) {
        if (detectCycle(dep, visited, stack)) {
            return true;
        }
    }
    
    stack.delete(module.id);
    return false;
}

const a = new Module('a');
const b = new Module('b');
a.dependencies = [b];
b.dependencies = [a];  // å¾ªç¯ï¼

console.log('æ£€æµ‹ç»“æœ:', detectCycle(a) ? 'å‘ç°å¾ªç¯' : 'æ— å¾ªç¯');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šDFS éå†</h3>
                <div class="code-block">
                    <pre><code>// æ·±åº¦ä¼˜å…ˆéå†
console.log('=== DFS éå† ===\n');

class Module {
    constructor(id) {
        this.id = id;
        this.dependencies = [];
    }
}

function dfs(module, visited = new Set()) {
    if (visited.has(module.id)) return;
    
    visited.add(module.id);
    console.log('  è®¿é—®:', module.id);
    
    for (const dep of module.dependencies) {
        dfs(dep, visited);
    }
}

const app = new Module('app');
const a = new Module('A');
const b = new Module('B');
const c = new Module('C');

app.dependencies = [a, b];
a.dependencies = [c];
b.dependencies = [c];

console.log('DFS é¡ºåº:');
dfs(app);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼šBFS éå†</h3>
                <div class="code-block">
                    <pre><code>// å¹¿åº¦ä¼˜å…ˆéå†
console.log('=== BFS éå† ===\n');

class Module {
    constructor(id) {
        this.id = id;
        this.dependencies = [];
    }
}

function bfs(module) {
    const queue = [module];
    const visited = new Set([module.id]);
    
    console.log('BFS é¡ºåº:');
    while (queue.length > 0) {
        const current = queue.shift();
        console.log('  è®¿é—®:', current.id);
        
        for (const dep of current.dependencies) {
            if (!visited.has(dep.id)) {
                visited.add(dep.id);
                queue.push(dep);
            }
        }
    }
}

const app = new Module('app');
const a = new Module('A');
const b = new Module('B');
const c = new Module('C');

app.dependencies = [a, b];
a.dependencies = [c];
b.dependencies = [c];

bfs(app);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šæ‹“æ‰‘æ’åº</h3>
                <div class="code-block">
                    <pre><code>// æ‹“æ‰‘æ’åºï¼ˆç®€åŒ–ç‰ˆï¼‰
console.log('=== æ‹“æ‰‘æ’åº ===\n');

function topologicalSort(graph) {
    const inDegree = new Map();
    const result = [];
    
    // åˆå§‹åŒ–å…¥åº¦
    for (const node of Object.keys(graph)) {
        inDegree.set(node, 0);
    }
    
    // è®¡ç®—å…¥åº¦
    for (const node of Object.keys(graph)) {
        for (const dep of graph[node]) {
            inDegree.set(dep, inDegree.get(dep) + 1);
        }
    }
    
    // æ‰¾å…¥åº¦ä¸º 0 çš„èŠ‚ç‚¹
    const queue = [];
    for (const [node, degree] of inDegree) {
        if (degree === 0) queue.push(node);
    }
    
    while (queue.length > 0) {
        const node = queue.shift();
        result.push(node);
        
        for (const dep of graph[node]) {
            inDegree.set(dep, inDegree.get(dep) - 1);
            if (inDegree.get(dep) === 0) {
                queue.push(dep);
            }
        }
    }
    
    return result;
}

const graph = {
    app: ['A', 'B'],
    A: ['C'],
    B: ['C'],
    C: []
};

console.log('åŠ è½½é¡ºåº:', topologicalSort(graph));</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šå¹¶è¡ŒåŠ è½½æ¨¡æ‹Ÿ</h3>
                <div class="code-block">
                    <pre><code>// å¹¶è¡ŒåŠ è½½æ¨¡æ‹Ÿ
console.log('=== å¹¶è¡ŒåŠ è½½ ===\n');

async function loadModule(name, delay) {
    console.log(`  å¼€å§‹åŠ è½½ ${name}`);
    await new Promise(resolve => setTimeout(resolve, delay));
    console.log(`  å®ŒæˆåŠ è½½ ${name}`);
    return { name, loaded: true };
}

async function sequentialLoad() {
    console.log('1. é¡ºåºåŠ è½½:');
    console.time('sequential');
    await loadModule('A', 100);
    await loadModule('B', 100);
    await loadModule('C', 100);
    console.timeEnd('sequential');
}

async function parallelLoad() {
    console.log('\n2. å¹¶è¡ŒåŠ è½½:');
    console.time('parallel');
    await Promise.all([
        loadModule('A', 100),
        loadModule('B', 100),
        loadModule('C', 100)
    ]);
    console.timeEnd('parallel');
}

sequentialLoad().then(() => parallelLoad());</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
