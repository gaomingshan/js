<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>隐藏类与内联缓存 - JavaScript 深度学习</title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>隐藏类与内联缓存</h1>
            
            <h2>概述</h2>
            <p>隐藏类（Hidden Class）和内联缓存（Inline Cache）是 V8 优化对象属性访问的核心机制。</p>
            
            <h2>一、隐藏类</h2>
            
            <h3>1.1 基本原理</h3>
            <pre><code>// 相同结构的对象共享隐藏类
const obj1 = { x: 1, y: 2 };
const obj2 = { x: 3, y: 4 };
// obj1 和 obj2 共享同一个隐藏类

// 不同结构有不同隐藏类
const obj3 = { x: 1 };      // 隐藏类 A
const obj4 = { x: 1, y: 2 }; // 隐藏类 B</code></pre>
            
            <h3>1.2 优化建议</h3>
            <pre><code>// ✓ 好：相同顺序初始化
function Point(x, y) {
    this.x = x;
    this.y = y;
}

// ✗ 不好：不同顺序
const obj1 = {};
obj1.x = 1;
obj1.y = 2;

const obj2 = {};
obj2.y = 2;  // 顺序不同
obj2.x = 1;</code></pre>
            
            <h2>二、内联缓存</h2>
            
            <h3>2.1 IC 状态</h3>
            <pre><code>// 单态（Monomorphic）- 最快
function getX(obj) {
    return obj.x;
}
getX({ x: 1, y: 2 });
getX({ x: 3, y: 4 });  // 相同结构

// 多态（Polymorphic）- 较快
getX({ x: 1 });
getX({ x: 2, y: 3 });
getX({ x: 4, y: 5, z: 6 });

// 超态（Megamorphic）- 慢
// 太多不同结构</code></pre>
            
            <h2>三、最佳实践</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>使用类或构造函数</strong></li>
                    <li><strong>相同顺序初始化属性</strong></li>
                    <li><strong>避免删除属性</strong></li>
                    <li><strong>避免动态添加属性</strong></li>
                    <li><strong>保持对象结构一致</strong></li>
                </ol>
            </div>
            
            <h2>参考资料</h2>
            <ul>
                <li><a href="https://mathiasbynens.be/notes/shapes-ics" target="_blank">JavaScript engine fundamentals: Shapes and Inline Caches</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="22-jit.html" class="nav-link prev">上一节：JIT 编译优化</a>
                <a href="../index.html" class="nav-link home">返回首页</a>
                <a href="23-destructuring.html" class="nav-link next">下一节：解构赋值深入</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">💻 交互式代码示例</h2>
            
            <div class="code-example">
                <h3>示例 1：隐藏类</h3>
                <div class="code-block">
                    <pre><code>// 隐藏类演示
console.log('=== 隐藏类 ===\n');

console.log('1. 相同结构:');
function Point(x, y) {
    this.x = x;
    this.y = y;
}

const p1 = new Point(1, 2);
const p2 = new Point(3, 4);
console.log('  共享隐藏类');

console.log('\n2. 不同顺序:');
const obj1 = {};
obj1.x = 1;
obj1.y = 2;

const obj2 = {};
obj2.y = 2;
obj2.x = 1;
console.log('  不同隐藏类');</code></pre>
                </div>
                <button class="run-btn">▶ 运行代码</button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>示例 2：单态 vs 多态</h3>
                <div class="code-block">
                    <pre><code>// IC 状态演示
console.log('=== IC 状态 ===\n');

function getX(obj) {
    return obj.x;
}

console.log('单态:');
console.time('mono');
for (let i = 0; i < 100000; i++) {
    getX({ x: 1, y: 2 });
}
console.timeEnd('mono');

console.log('\n多态:');
console.time('poly');
for (let i = 0; i < 100000; i++) {
    getX({ x: 1 });
    getX({ x: 2, y: 3 });
}
console.timeEnd('poly');</code></pre>
                </div>
                <button class="run-btn">▶ 运行代码</button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
