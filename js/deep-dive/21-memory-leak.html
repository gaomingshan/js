<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†…å­˜æ³„æ¼åˆ†æä¸æ’æŸ¥ - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>å†…å­˜æ³„æ¼åˆ†æä¸æ’æŸ¥</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>å†…å­˜æ³„æ¼æ˜¯æŒ‡ç¨‹åºä¸­å·²åˆ†é…çš„å†…å­˜æ— æ³•è¢«é‡Šæ”¾æˆ–å›æ”¶ï¼Œå¯¼è‡´å¯ç”¨å†…å­˜é€æ¸å‡å°‘ã€‚äº†è§£å¸¸è§çš„å†…å­˜æ³„æ¼åœºæ™¯å’Œæ’æŸ¥æ–¹æ³•ï¼Œå¯¹äºå¼€å‘é«˜è´¨é‡åº”ç”¨è‡³å…³é‡è¦ã€‚</p>
            
            <h2>ä¸€ã€å¸¸è§å†…å­˜æ³„æ¼åœºæ™¯</h2>
            
            <h3>1.1 æ„å¤–çš„å…¨å±€å˜é‡</h3>
            <pre><code>// å¿˜è®°å£°æ˜å˜é‡å¯¼è‡´å…¨å±€å˜é‡
function leak() {
    name = 'Alice';  // âŒ åˆ›å»ºäº†å…¨å±€å˜é‡ window.name
}

leak();
console.log(window.name);  // "Alice"ï¼ˆæ°¸è¿œä¸ä¼šè¢«å›æ”¶ï¼‰

// ä¿®å¤ï¼šä½¿ç”¨ä¸¥æ ¼æ¨¡å¼å’Œæ­£ç¡®å£°æ˜
'use strict';
function fixed() {
    let name = 'Alice';  // âœ“ å±€éƒ¨å˜é‡
}

// æˆ–
function fixed2() {
    const name = 'Alice';  // âœ“ å±€éƒ¨å¸¸é‡
}</code></pre>
            
            <h3>1.2 æœªæ¸…ç†çš„å®šæ—¶å™¨</h3>
            <pre><code>// å®šæ—¶å™¨å¼•ç”¨çš„å˜é‡æ— æ³•å›æ”¶
function leak() {
    const data = new Array(10000).fill('x');
    
    setInterval(() => {
        console.log(data.length);  // æŒç»­å¼•ç”¨ data
    }, 1000);
    
    // å®šæ—¶å™¨æ°¸è¿œä¸ä¼šåœæ­¢ï¼Œdata æ°¸è¿œä¸ä¼šè¢«å›æ”¶
}

// ä¿®å¤ï¼šæ¸…ç†å®šæ—¶å™¨
function fixed() {
    const data = new Array(10000).fill('x');
    
    const timer = setInterval(() => {
        console.log(data.length);
    }, 1000);
    
    // é€‚å½“æ—¶æœºæ¸…ç†
    setTimeout(() => {
        clearInterval(timer);  // âœ“ æ¸…ç†å®šæ—¶å™¨
    }, 10000);
}</code></pre>
            
            <h3>1.3 æœªç§»é™¤çš„äº‹ä»¶ç›‘å¬å™¨</h3>
            <pre><code>// äº‹ä»¶ç›‘å¬å™¨æŒæœ‰å¼•ç”¨
function leak() {
    const element = document.getElementById('button');
    const data = new Array(10000).fill('x');
    
    element.addEventListener('click', function() {
        console.log(data.length);  // é—­åŒ…å¼•ç”¨ data
    });
    
    // element è¢«ç§»é™¤åï¼Œç›‘å¬å™¨ä»åœ¨å†…å­˜ä¸­
    element.remove();
}

// ä¿®å¤ï¼šç§»é™¤ç›‘å¬å™¨
function fixed() {
    const element = document.getElementById('button');
    const data = new Array(10000).fill('x');
    
    function handler() {
        console.log(data.length);
    }
    
    element.addEventListener('click', handler);
    
    // æ¸…ç†
    element.removeEventListener('click', handler);  // âœ“
    element.remove();
}</code></pre>
            
            <h3>1.4 DOM å¼•ç”¨</h3>
            <pre><code>// ä¿æŒå¯¹å·²åˆ é™¤ DOM çš„å¼•ç”¨
const elements = {
    button: document.getElementById('button')
};

// ä» DOM ä¸­åˆ é™¤
document.body.removeChild(elements.button);

// ä½† elements.button ä»ç„¶å¼•ç”¨è¯¥ DOM èŠ‚ç‚¹
// å¯¼è‡´æ•´ä¸ª DOM å­æ ‘æ— æ³•å›æ”¶

// ä¿®å¤ï¼šæ¸…é™¤å¼•ç”¨
elements.button = null;  // âœ“</code></pre>
            
            <h3>1.5 é—­åŒ…å¼•ç”¨</h3>
            <pre><code>// é—­åŒ…ä¿æŒå¯¹å¤§å¯¹è±¡çš„å¼•ç”¨
function leak() {
    const largeData = new Array(10000).fill('x');
    const smallData = 'y';
    
    return function() {
        return smallData;  // åªä½¿ç”¨ smallData
    };
    
    // ä½†é—­åŒ…ä¼šä¿æŒæ•´ä¸ªä½œç”¨åŸŸï¼ŒåŒ…æ‹¬ largeData
}

// ä¿®å¤ï¼šæœ€å°åŒ–é—­åŒ…ä½œç”¨åŸŸ
function fixed() {
    const largeData = new Array(10000).fill('x');
    const smallData = 'y';
    
    // å¤„ç† largeData...
    
    // è§£é™¤å¼•ç”¨
    largeData = null;
    
    return function() {
        return smallData;  // âœ“ largeData å·²è¢«å›æ”¶
    };
}</code></pre>
            
            <h3>1.6 å¾ªç¯å¼•ç”¨ï¼ˆè€ç‰ˆæœ¬ IEï¼‰</h3>
            <pre><code>// åœ¨è€ç‰ˆæœ¬ IE ä¸­ï¼ŒDOM å’Œ JS å¯¹è±¡å¾ªç¯å¼•ç”¨å¯¼è‡´æ³„æ¼
function leak() {
    const element = document.getElementById('div');
    const obj = {};
    
    element.customData = obj;  // DOM å¼•ç”¨ JS
    obj.element = element;     // JS å¼•ç”¨ DOM
    
    // åœ¨è€ç‰ˆæœ¬ IE ä¸­æ— æ³•å›æ”¶
}

// ç°ä»£æµè§ˆå™¨å·²ç»è§£å†³ï¼Œä½†ä»å»ºè®®é¿å…</code></pre>
            
            <h2>äºŒã€æ’æŸ¥å·¥å…·</h2>
            
            <h3>2.1 Chrome DevTools</h3>
            <pre><code>// 1. Memory Profilerï¼ˆå†…å­˜åˆ†æå™¨ï¼‰

// Heap Snapshotï¼ˆå †å¿«ç…§ï¼‰
// - è®°å½•å½“å‰æ—¶åˆ»çš„å†…å­˜çŠ¶æ€
// - æŸ¥çœ‹å¯¹è±¡æ•°é‡å’Œå¤§å°
// - å¯¹æ¯”å¤šä¸ªå¿«ç…§æ‰¾å‡ºå¢é•¿çš„å¯¹è±¡

// Allocation Timelineï¼ˆåˆ†é…æ—¶é—´çº¿ï¼‰
// - å®æ—¶è®°å½•å†…å­˜åˆ†é…
// - æ‰¾å‡ºé¢‘ç¹åˆ†é…çš„å¯¹è±¡
// - æŸ¥çœ‹å¯¹è±¡çš„ä¿ç•™è·¯å¾„

// Allocation Samplingï¼ˆåˆ†é…é‡‡æ ·ï¼‰
// - ä½å¼€é”€çš„é‡‡æ ·
// - æ‰¾å‡ºå†…å­˜çƒ­ç‚¹

// 2. Performance Monitorï¼ˆæ€§èƒ½ç›‘è§†å™¨ï¼‰
// - å®æ—¶æŸ¥çœ‹ JS å †å¤§å°
// - DOM èŠ‚ç‚¹æ•°é‡
// - ç›‘å¬å™¨æ•°é‡

// 3. Task Managerï¼ˆä»»åŠ¡ç®¡ç†å™¨ï¼‰
// - Shift + Esc æ‰“å¼€
// - æŸ¥çœ‹å„æ ‡ç­¾é¡µå†…å­˜ä½¿ç”¨</code></pre>
            
            <h3>2.2 æ’æŸ¥æ­¥éª¤</h3>
            <pre><code>// æ­¥éª¤ 1ï¼šé‡ç°é—®é¢˜
// - ç¡®å®šå¯¼è‡´å†…å­˜å¢é•¿çš„æ“ä½œ
// - é‡å¤æ‰§è¡Œè¯¥æ“ä½œ

// æ­¥éª¤ 2ï¼šè®°å½•å †å¿«ç…§
// 1. æ“ä½œå‰è®°å½•å¿«ç…§ A
// 2. æ‰§è¡Œæ“ä½œ
// 3. æ“ä½œåè®°å½•å¿«ç…§ B
// 4. å†æ¬¡æ‰§è¡Œæ“ä½œ
// 5. å†æ¬¡è®°å½•å¿«ç…§ C

// æ­¥éª¤ 3ï¼šå¯¹æ¯”å¿«ç…§
// - æŸ¥çœ‹ B å’Œ A çš„å·®å¼‚
// - æŸ¥çœ‹ C å’Œ B çš„å·®å¼‚
// - æ‰¾å‡ºæŒç»­å¢é•¿çš„å¯¹è±¡

// æ­¥éª¤ 4ï¼šæŸ¥çœ‹ä¿ç•™è·¯å¾„
// - é€‰æ‹©å¢é•¿çš„å¯¹è±¡
// - æŸ¥çœ‹ "Retainers"ï¼ˆä¿ç•™è€…ï¼‰
// - æ‰¾å‡ºæ˜¯ä»€ä¹ˆå¼•ç”¨äº†è¯¥å¯¹è±¡

// æ­¥éª¤ 5ï¼šå®šä½ä»£ç 
// - æ ¹æ®ä¿ç•™è·¯å¾„æ‰¾åˆ°ä»£ç ä½ç½®
// - åˆ†æä¸ºä»€ä¹ˆæ²¡æœ‰è¢«å›æ”¶</code></pre>
            
            <h2>ä¸‰ã€å®é™…æ¡ˆä¾‹</h2>
            
            <h3>3.1 æ¡ˆä¾‹1ï¼šå®šæ—¶å™¨æ³„æ¼</h3>
            <pre><code>// é—®é¢˜ä»£ç 
class Component {
    constructor() {
        this.data = new Array(10000).fill('x');
        
        setInterval(() => {
            this.render();
        }, 1000);
    }
    
    render() {
        console.log(this.data.length);
    }
    
    destroy() {
        // âŒ å¿˜è®°æ¸…ç†å®šæ—¶å™¨
    }
}

// æ¯æ¬¡åˆ›å»º Component éƒ½æ³„æ¼å†…å­˜
for (let i = 0; i < 10; i++) {
    new Component();
}

// ä¿®å¤ä»£ç 
class ComponentFixed {
    constructor() {
        this.data = new Array(10000).fill('x');
        
        this.timer = setInterval(() => {
            this.render();
        }, 1000);
    }
    
    render() {
        console.log(this.data.length);
    }
    
    destroy() {
        clearInterval(this.timer);  // âœ“ æ¸…ç†å®šæ—¶å™¨
        this.data = null;            // âœ“ è§£é™¤å¼•ç”¨
    }
}</code></pre>
            
            <h3>3.2 æ¡ˆä¾‹2ï¼šäº‹ä»¶ç›‘å¬å™¨æ³„æ¼</h3>
            <pre><code>// é—®é¢˜ä»£ç 
class ListView {
    constructor(items) {
        this.items = items;
        this.handlers = [];
        this.render();
    }
    
    render() {
        this.items.forEach((item, index) => {
            const element = document.createElement('div');
            
            // âŒ æ¯æ¬¡ render éƒ½æ·»åŠ æ–°çš„ç›‘å¬å™¨
            element.addEventListener('click', () => {
                this.handleClick(index);
            });
            
            document.body.appendChild(element);
        });
    }
    
    handleClick(index) {
        console.log('Clicked:', index);
    }
}

// ä¿®å¤ä»£ç 
class ListViewFixed {
    constructor(items) {
        this.items = items;
        this.handlers = new Map();
        this.render();
    }
    
    render() {
        this.items.forEach((item, index) => {
            const element = document.createElement('div');
            
            const handler = () => this.handleClick(index);
            this.handlers.set(element, handler);
            
            element.addEventListener('click', handler);
            document.body.appendChild(element);
        });
    }
    
    destroy() {
        // âœ“ æ¸…ç†æ‰€æœ‰ç›‘å¬å™¨
        this.handlers.forEach((handler, element) => {
            element.removeEventListener('click', handler);
            element.remove();
        });
        this.handlers.clear();
    }
}</code></pre>
            
            <h3>3.3 æ¡ˆä¾‹3ï¼šé—­åŒ…æ³„æ¼</h3>
            <pre><code>// é—®é¢˜ä»£ç 
function createCache() {
    const cache = {};
    
    return {
        set(key, value) {
            cache[key] = value;
        },
        get(key) {
            return cache[key];
        }
        // âŒ æ²¡æœ‰æ¸…ç†æ–¹æ³•
    };
}

const userCache = createCache();

// æŒç»­æ·»åŠ æ•°æ®
for (let i = 0; i < 10000; i++) {
    userCache.set(`user_${i}`, {
        id: i,
        data: new Array(1000).fill('x')
    });
}

// ä¿®å¤ä»£ç 
function createCacheFixed() {
    const cache = new Map();
    const maxSize = 1000;
    
    return {
        set(key, value) {
            // âœ“ é™åˆ¶å¤§å°
            if (cache.size >= maxSize) {
                const firstKey = cache.keys().next().value;
                cache.delete(firstKey);
            }
            cache.set(key, value);
        },
        get(key) {
            return cache.get(key);
        },
        clear() {
            cache.clear();  // âœ“ æä¾›æ¸…ç†æ–¹æ³•
        }
    };
}</code></pre>
            
            <h2>å››ã€é˜²æ­¢å†…å­˜æ³„æ¼çš„æ¨¡å¼</h2>
            
            <h3>4.1 WeakMap æ¨¡å¼</h3>
            <pre><code>// ä½¿ç”¨ WeakMap å­˜å‚¨ç§æœ‰æ•°æ®
const privateData = new WeakMap();

class Person {
    constructor(name) {
        privateData.set(this, { name });
    }
    
    getName() {
        return privateData.get(this).name;
    }
}

let person = new Person('Alice');
console.log(person.getName());  // "Alice"

person = null;  // Person å®ä¾‹å’Œç§æœ‰æ•°æ®éƒ½å¯ä»¥è¢«å›æ”¶</code></pre>
            
            <h3>4.2 æ¸…ç†å‡½æ•°æ¨¡å¼</h3>
            <pre><code>// æä¾›æ¸…ç†å‡½æ•°
class Component {
    constructor() {
        this.listeners = [];
        this.timers = [];
    }
    
    addEventListener(element, event, handler) {
        element.addEventListener(event, handler);
        this.listeners.push({ element, event, handler });
    }
    
    setInterval(callback, delay) {
        const timer = setInterval(callback, delay);
        this.timers.push(timer);
        return timer;
    }
    
    destroy() {
        // æ¸…ç†æ‰€æœ‰ç›‘å¬å™¨
        this.listeners.forEach(({ element, event, handler }) => {
            element.removeEventListener(event, handler);
        });
        
        // æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨
        this.timers.forEach(timer => {
            clearInterval(timer);
        });
        
        this.listeners = [];
        this.timers = [];
    }
}</code></pre>
            
            <h3>4.3 LRU ç¼“å­˜æ¨¡å¼</h3>
            <pre><code>// é™åˆ¶ç¼“å­˜å¤§å°çš„ LRU ç¼“å­˜
class LRUCache {
    constructor(capacity) {
        this.capacity = capacity;
        this.cache = new Map();
    }
    
    get(key) {
        if (!this.cache.has(key)) return -1;
        
        // æ›´æ–°è®¿é—®é¡ºåº
        const value = this.cache.get(key);
        this.cache.delete(key);
        this.cache.set(key, value);
        return value;
    }
    
    put(key, value) {
        // åˆ é™¤æ—§å€¼
        if (this.cache.has(key)) {
            this.cache.delete(key);
        }
        
        // æ£€æŸ¥å®¹é‡
        if (this.cache.size >= this.capacity) {
            // åˆ é™¤æœ€ä¹…æœªä½¿ç”¨çš„ï¼ˆç¬¬ä¸€ä¸ªï¼‰
            const firstKey = this.cache.keys().next().value;
            this.cache.delete(firstKey);
        }
        
        this.cache.set(key, value);
    }
}

const cache = new LRUCache(100);  // æœ€å¤š100é¡¹</code></pre>
            
            <h2>äº”ã€ç›‘æ§å’Œé¢„è­¦</h2>
            
            <h3>5.1 å†…å­˜ç›‘æ§</h3>
            <pre><code>// æµè§ˆå™¨ç¯å¢ƒ
if (performance.memory) {
    function checkMemory() {
        const { usedJSHeapSize, totalJSHeapSize, jsHeapSizeLimit } = performance.memory;
        
        const usage = usedJSHeapSize / totalJSHeapSize;
        
        console.log({
            used: `${(usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`,
            total: `${(totalJSHeapSize / 1024 / 1024).toFixed(2)} MB`,
            limit: `${(jsHeapSizeLimit / 1024 / 1024).toFixed(2)} MB`,
            usage: `${(usage * 100).toFixed(2)}%`
        });
        
        if (usage > 0.9) {
            console.warn('å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼');
        }
    }
    
    setInterval(checkMemory, 5000);
}

// Node.js ç¯å¢ƒ
function checkMemoryNode() {
    const used = process.memoryUsage();
    
    console.log({
        rss: `${Math.round(used.rss / 1024 / 1024)} MB`,
        heapTotal: `${Math.round(used.heapTotal / 1024 / 1024)} MB`,
        heapUsed: `${Math.round(used.heapUsed / 1024 / 1024)} MB`,
        external: `${Math.round(used.external / 1024 / 1024)} MB`
    });
}</code></pre>
            
            <h2>å…­ã€æœ€ä½³å®è·µ</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼</strong>ï¼šé¿å…æ„å¤–å…¨å±€å˜é‡</li>
                    <li><strong>åŠæ—¶æ¸…ç†</strong>ï¼šå®šæ—¶å™¨ã€ç›‘å¬å™¨ã€å¼•ç”¨</li>
                    <li><strong>æä¾›æ¸…ç†æ–¹æ³•</strong>ï¼šç»„ä»¶é”€æ¯æ—¶æ¸…ç†èµ„æº</li>
                    <li><strong>ä½¿ç”¨ WeakMap</strong>ï¼šè‡ªåŠ¨å›æ”¶é”®å¯¹è±¡</li>
                    <li><strong>é™åˆ¶ç¼“å­˜å¤§å°</strong>ï¼šä½¿ç”¨ LRU ç­‰ç­–ç•¥</li>
                    <li><strong>å®šæœŸç›‘æ§</strong>ï¼šä½¿ç”¨å·¥å…·æ£€æŸ¥å†…å­˜</li>
                    <li><strong>ä»£ç å®¡æŸ¥</strong>ï¼šå…³æ³¨å¯èƒ½æ³„æ¼çš„æ¨¡å¼</li>
                </ol>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="https://developer.chrome.com/docs/devtools/memory-problems/" target="_blank">Chrome DevTools - Memory Problems</a></li>
                <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Memory_Management" target="_blank">MDN - å†…å­˜ç®¡ç†</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="21-gc.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šåƒåœ¾å›æ”¶ç®—æ³•</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="22-v8-internals.html" class="nav-link next">ä¸‹ä¸€èŠ‚ï¼šV8 å†…éƒ¨æœºåˆ¶</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šæ„å¤–å…¨å±€å˜é‡</h3>
                <div class="code-block">
                    <pre><code>// æ„å¤–å…¨å±€å˜é‡å¯¼è‡´çš„æ³„æ¼
console.log('=== æ„å¤–å…¨å±€å˜é‡ ===\n');

function leak() {
    // å¿˜è®° var/let/const
    leaked = 'This is a leak';
    console.log('  åˆ›å»ºäº†å…¨å±€å˜é‡');
}

leak();

console.log('æ£€æŸ¥å…¨å±€å˜é‡:');
console.log('  window.leaked =', window.leaked);

console.log('\nä¿®å¤: ä½¿ç”¨ä¸¥æ ¼æ¨¡å¼');
console.log("'use strict';");
console.log('function fixed() {');
console.log("  leaked = 'error';  // æŠ›å‡ºé”™è¯¯");
console.log('}');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šå®šæ—¶å™¨æ³„æ¼</h3>
                <div class="code-block">
                    <pre><code>// å®šæ—¶å™¨å¯¼è‡´çš„å†…å­˜æ³„æ¼
console.log('=== å®šæ—¶å™¨æ³„æ¼ ===\n');

let timerId = null;

function leakTimer() {
    const data = new Array(100).fill('x');
    console.log('åˆ›å»ºå®šæ—¶å™¨ï¼Œå¼•ç”¨å¤§æ•°ç»„');
    
    timerId = setInterval(() => {
        console.log('  æ•°ç»„é•¿åº¦:', data.length);
    }, 1000);
}

console.log('å¯åŠ¨å®šæ—¶å™¨:');
leakTimer();

setTimeout(() => {
    console.log('\n2ç§’åæ¸…ç†:');
    clearInterval(timerId);
    console.log('  å®šæ—¶å™¨å·²æ¸…ç†');
    console.log('  data å¯ä»¥è¢«å›æ”¶');
}, 2000);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šé—­åŒ…æ³„æ¼</h3>
                <div class="code-block">
                    <pre><code>// é—­åŒ…å¼•ç”¨å¤§å¯¹è±¡
console.log('=== é—­åŒ…æ³„æ¼ ===\n');

console.log('1. æ³„æ¼ç‰ˆæœ¬:');
function leakyClosure() {
    const largeData = new Array(1000).fill('x');
    const small = 'y';
    
    return function() {
        return small;  // åªç”¨ small
    };
    // ä½†æ•´ä¸ªä½œç”¨åŸŸï¼ˆåŒ…æ‹¬ largeDataï¼‰è¢«ä¿ç•™
}

const fn1 = leakyClosure();
console.log('  è¿”å›å‡½æ•°ï¼Œä½† largeData ä»åœ¨å†…å­˜ä¸­');

console.log('\n2. ä¿®å¤ç‰ˆæœ¬:');
function fixedClosure() {
    let largeData = new Array(1000).fill('x');
    const small = 'y';
    
    // å¤„ç† largeData...
    console.log('  å¤„ç† largeData...');
    
    largeData = null;  // è§£é™¤å¼•ç”¨
    
    return function() {
        return small;
    };
}

const fn2 = fixedClosure();
console.log('  largeData å·²é‡Šæ”¾');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼šWeakMap é˜²æ³„æ¼</h3>
                <div class="code-block">
                    <pre><code>// ä½¿ç”¨ WeakMap é¿å…æ³„æ¼
console.log('=== WeakMap é˜²æ³„æ¼ ===\n');

const privateData = new WeakMap();

class User {
    constructor(name) {
        privateData.set(this, {
            name,
            secret: 'private data'
        });
        console.log(`  åˆ›å»ºç”¨æˆ·: ${name}`);
    }
    
    getName() {
        return privateData.get(this).name;
    }
}

console.log('åˆ›å»ºç”¨æˆ·:');
let user = new User('Alice');
console.log('  user.getName():', user.getName());

console.log('\nè§£é™¤å¼•ç”¨:');
user = null;
console.log('  user = null');
console.log('  User å®ä¾‹å’Œç§æœ‰æ•°æ®éƒ½å¯è¢« GC');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šLRU ç¼“å­˜</h3>
                <div class="code-block">
                    <pre><code>// LRU ç¼“å­˜é™åˆ¶å†…å­˜
console.log('=== LRU ç¼“å­˜ ===\n');

class LRUCache {
    constructor(capacity) {
        this.capacity = capacity;
        this.cache = new Map();
    }
    
    get(key) {
        if (!this.cache.has(key)) return null;
        
        const value = this.cache.get(key);
        this.cache.delete(key);
        this.cache.set(key, value);
        return value;
    }
    
    put(key, value) {
        if (this.cache.has(key)) {
            this.cache.delete(key);
        }
        
        if (this.cache.size >= this.capacity) {
            const first = this.cache.keys().next().value;
            this.cache.delete(first);
            console.log(`  åˆ é™¤æœ€æ—§çš„: ${first}`);
        }
        
        this.cache.set(key, value);
    }
}

const cache = new LRUCache(3);

console.log('æ·»åŠ æ•°æ®:');
cache.put('a', 1);
cache.put('b', 2);
cache.put('c', 3);
console.log('  a, b, c');

cache.put('d', 4);  // a è¢«åˆ é™¤
console.log('  æ·»åŠ  dï¼ˆå®¹é‡å·²æ»¡ï¼‰');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šå†…å­˜ç›‘æ§</h3>
                <div class="code-block">
                    <pre><code>// ç›‘æ§å†…å­˜ä½¿ç”¨
console.log('=== å†…å­˜ç›‘æ§ ===\n');

if (performance.memory) {
    function checkMemory() {
        const {
            usedJSHeapSize,
            totalJSHeapSize,
            jsHeapSizeLimit
        } = performance.memory;
        
        const usage = (usedJSHeapSize / totalJSHeapSize * 100).toFixed(2);
        
        console.log('å†…å­˜çŠ¶æ€:');
        console.log(`  å·²ä½¿ç”¨: ${(usedJSHeapSize / 1024 / 1024).toFixed(2)} MB`);
        console.log(`  æ€»å¤§å°: ${(totalJSHeapSize / 1024 / 1024).toFixed(2)} MB`);
        console.log(`  ä½¿ç”¨ç‡: ${usage}%`);
        
        if (usage > 90) {
            console.warn('  âš ï¸ å†…å­˜ä½¿ç”¨ç‡è¿‡é«˜ï¼');
        }
    }
    
    checkMemory();
} else {
    console.log('performance.memory ä¸å¯ç”¨');
    console.log('ï¼ˆä»…åœ¨ Chrome ä¸­å¯ç”¨ï¼‰');
}</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
