<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼‚æ­¥è¿­ä»£å™¨åè®® - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>å¼‚æ­¥è¿­ä»£å™¨åè®®</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>å¼‚æ­¥è¿­ä»£å™¨ï¼ˆAsync Iteratorï¼‰æ˜¯ ES2018 å¼•å…¥çš„ç‰¹æ€§ï¼Œå…è®¸å¼‚æ­¥åœ°è¿­ä»£æ•°æ®ã€‚é…åˆ for await...of è¯­æ³•ï¼Œå¯ä»¥ä¼˜é›…åœ°å¤„ç†å¼‚æ­¥æ•°æ®æµã€‚</p>
            
            <h2>ä¸€ã€å¼‚æ­¥è¿­ä»£å™¨åè®®</h2>
            
            <h3>1.1 æ¥å£å®šä¹‰</h3>
            <pre><code>// å¼‚æ­¥è¿­ä»£å™¨æ¥å£
interface AsyncIterator {
    next(): Promise<IteratorResult>;
}

interface IteratorResult {
    value: any;
    done: boolean;
}

// ç¤ºä¾‹
const asyncIterator = {
    current: 0,
    last: 3,
    
    async next() {
        await new Promise(resolve => setTimeout(resolve, 100));
        
        if (this.current <= this.last) {
            return {
                value: this.current++,
                done: false
            };
        } else {
            return {
                value: undefined,
                done: true
            };
        }
    }
};

// æ‰‹åŠ¨è°ƒç”¨
asyncIterator.next().then(console.log);  // { value: 0, done: false }</code></pre>
            
            <h3>1.2 å¼‚æ­¥å¯è¿­ä»£åè®®</h3>
            <pre><code>// å¼‚æ­¥å¯è¿­ä»£å¯¹è±¡å¿…é¡»å®ç° [Symbol.asyncIterator]
interface AsyncIterable {
    [Symbol.asyncIterator](): AsyncIterator;
}

// å®ç°å¼‚æ­¥å¯è¿­ä»£å¯¹è±¡
const asyncIterable = {
    data: [1, 2, 3],
    
    [Symbol.asyncIterator]() {
        let index = 0;
        const data = this.data;
        
        return {
            async next() {
                // æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
                await new Promise(resolve => setTimeout(resolve, 100));
                
                if (index < data.length) {
                    return { value: data[index++], done: false };
                } else {
                    return { value: undefined, done: true };
                }
            }
        };
    }
};</code></pre>
            
            <h2>äºŒã€for await...of è¯­æ³•</h2>
            
            <h3>2.1 åŸºæœ¬ä½¿ç”¨</h3>
            <pre><code>// for await...of éå†å¼‚æ­¥å¯è¿­ä»£å¯¹è±¡
async function example() {
    const asyncIterable = {
        data: [1, 2, 3],
        
        [Symbol.asyncIterator]() {
            let index = 0;
            
            return {
                async next() {
                    await new Promise(r => setTimeout(r, 100));
                    
                    if (index < this.data.length) {
                        return { value: this.data[index++], done: false };
                    }
                    return { done: true };
                }
            };
        }
    };
    
    for await (const value of asyncIterable) {
        console.log(value);  // 1, 2, 3ï¼ˆæ¯ä¸ªé—´éš” 100msï¼‰
    }
}

example();</code></pre>
            
            <h3>2.2 å¤„ç† Promise æ•°ç»„</h3>
            <pre><code>// for await...of å¯ä»¥å¤„ç† Promise æ•°ç»„
async function processPromises() {
    const promises = [
        Promise.resolve(1),
        Promise.resolve(2),
        Promise.resolve(3)
    ];
    
    for await (const value of promises) {
        console.log(value);  // 1, 2, 3
    }
}

processPromises();</code></pre>
            
            <h2>ä¸‰ã€å¼‚æ­¥ç”Ÿæˆå™¨</h2>
            
            <h3>3.1 async function*</h3>
            <pre><code>// å¼‚æ­¥ç”Ÿæˆå™¨å‡½æ•°
async function* asyncGenerator() {
    yield await Promise.resolve(1);
    yield await Promise.resolve(2);
    yield await Promise.resolve(3);
}

// ä½¿ç”¨
async function use() {
    for await (const value of asyncGenerator()) {
        console.log(value);  // 1, 2, 3
    }
}

use();</code></pre>
            
            <h3>3.2 ç®€åŒ–å¼‚æ­¥è¿­ä»£å™¨</h3>
            <pre><code>// ç”¨å¼‚æ­¥ç”Ÿæˆå™¨ç®€åŒ–å®ç°
async function* fetchPages(url, maxPages) {
    for (let page = 1; page <= maxPages; page++) {
        const response = await fetch(`${url}?page=${page}`);
        yield await response.json();
    }
}

// ä½¿ç”¨
async function loadAllPages() {
    for await (const pageData of fetchPages('/api/data', 5)) {
        console.log('é¡µé¢æ•°æ®:', pageData);
    }
}</code></pre>
            
            <h3>3.3 yield* å§”æ‰˜</h3>
            <pre><code>// å¼‚æ­¥ç”Ÿæˆå™¨ä¹Ÿæ”¯æŒ yield*
async function* inner() {
    yield await Promise.resolve('a');
    yield await Promise.resolve('b');
}

async function* outer() {
    yield 1;
    yield* inner();  // å§”æ‰˜ç»™å¼‚æ­¥ç”Ÿæˆå™¨
    yield 2;
}

async function test() {
    for await (const value of outer()) {
        console.log(value);  // 1, 'a', 'b', 2
    }
}

test();</code></pre>
            
            <h2>å››ã€å®é™…åº”ç”¨</h2>
            
            <h3>4.1 è¯»å–æ–‡ä»¶æµ</h3>
            <pre><code>// Node.js è¯»å–æµ
async function* readLines(stream) {
    let buffer = '';
    
    for await (const chunk of stream) {
        buffer += chunk.toString();
        const lines = buffer.split('\n');
        buffer = lines.pop(); // ä¿ç•™æœªå®Œæˆçš„è¡Œ
        
        for (const line of lines) {
            yield line;
        }
    }
    
    if (buffer) {
        yield buffer;
    }
}

// ä½¿ç”¨
const fs = require('fs');
const stream = fs.createReadStream('file.txt');

for await (const line of readLines(stream)) {
    console.log(line);
}</code></pre>
            
            <h3>4.2 åˆ†é¡µ API</h3>
            <pre><code>// è‡ªåŠ¨å¤„ç†åˆ†é¡µçš„ API è°ƒç”¨
async function* fetchAllUsers(apiUrl) {
    let page = 1;
    let hasMore = true;
    
    while (hasMore) {
        const response = await fetch(`${apiUrl}?page=${page}`);
        const data = await response.json();
        
        for (const user of data.users) {
            yield user;
        }
        
        hasMore = data.hasMore;
        page++;
    }
}

// ä½¿ç”¨
async function processAllUsers() {
    for await (const user of fetchAllUsers('/api/users')) {
        console.log(user.name);
    }
}</code></pre>
            
            <h3>4.3 äº‹ä»¶æµ</h3>
            <pre><code>// å°†äº‹ä»¶è½¬æ¢ä¸ºå¼‚æ­¥å¯è¿­ä»£å¯¹è±¡
function observeClicks(element) {
    return {
        [Symbol.asyncIterator]() {
            const queue = [];
            let resolve;
            
            element.addEventListener('click', e => {
                if (resolve) {
                    resolve({ value: e, done: false });
                    resolve = null;
                } else {
                    queue.push(e);
                }
            });
            
            return {
                async next() {
                    if (queue.length > 0) {
                        return { value: queue.shift(), done: false };
                    }
                    
                    return new Promise(r => {
                        resolve = r;
                    });
                }
            };
        }
    };
}

// ä½¿ç”¨
async function handleClicks() {
    for await (const event of observeClicks(document.body)) {
        console.log('ç‚¹å‡»ä½ç½®:', event.clientX, event.clientY);
        
        if (event.clientX > 500) break;  // æ¡ä»¶é€€å‡º
    }
}</code></pre>
            
            <h2>äº”ã€é”™è¯¯å¤„ç†</h2>
            
            <h3>5.1 try/catch</h3>
            <pre><code>// åœ¨ for await...of ä¸­å¤„ç†é”™è¯¯
async function* mayFail() {
    yield 1;
    throw new Error('å‡ºé”™äº†');
    yield 2;  // ä¸ä¼šæ‰§è¡Œ
}

async function handleErrors() {
    try {
        for await (const value of mayFail()) {
            console.log(value);  // 1
        }
    } catch (e) {
        console.error('æ•è·é”™è¯¯:', e.message);
    }
}

handleErrors();</code></pre>
            
            <h3>5.2 throw() æ–¹æ³•</h3>
            <pre><code>// å‘å¼‚æ­¥ç”Ÿæˆå™¨æŠ›å‡ºé”™è¯¯
async function* resilient() {
    try {
        yield 1;
    } catch (e) {
        console.log('æ•è·:', e);
        yield 'recovered';
    }
    yield 2;
}

async function test() {
    const gen = resilient();
    console.log(await gen.next());      // { value: 1, done: false }
    console.log(await gen.throw('é”™è¯¯')); // æ•è·: é”™è¯¯, { value: 'recovered', done: false }
    console.log(await gen.next());      // { value: 2, done: false }
}

test();</code></pre>
            
            <h2>å…­ã€æ€§èƒ½è€ƒè™‘</h2>
            
            <h3>6.1 å¹¶å‘æ§åˆ¶</h3>
            <pre><code>// é™åˆ¶å¹¶å‘æ•°é‡
async function* fetchWithConcurrency(urls, concurrency) {
    const results = [];
    
    for (let i = 0; i < urls.length; i += concurrency) {
        const batch = urls.slice(i, i + concurrency);
        const promises = batch.map(url => fetch(url));
        const responses = await Promise.all(promises);
        
        for (const response of responses) {
            yield await response.json();
        }
    }
}

// ä½¿ç”¨
async function loadData() {
    const urls = Array(10).fill('/api/data');
    
    for await (const data of fetchWithConcurrency(urls, 3)) {
        console.log(data);  // æ¯æ¬¡å¤„ç† 3 ä¸ª
    }
}</code></pre>
            
            <h3>6.2 æå‰ç»ˆæ­¢</h3>
            <pre><code>// return() æ–¹æ³•æ¸…ç†èµ„æº
async function* withCleanup() {
    const resource = await openResource();
    
    try {
        yield* resource;
    } finally {
        await resource.close();  // æ¸…ç†
        console.log('èµ„æºå·²å…³é—­');
    }
}

async function use() {
    for await (const item of withCleanup()) {
        if (condition) break;  // è§¦å‘ finally
    }
}</code></pre>
            
            <h2>ä¸ƒã€æœ€ä½³å®è·µ</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>ä½¿ç”¨ for await...of</strong>ï¼šç®€åŒ–å¼‚æ­¥è¿­ä»£ä»£ç </li>
                    <li><strong>å¼‚æ­¥ç”Ÿæˆå™¨</strong>ï¼šä¼˜å…ˆä½¿ç”¨ async function*</li>
                    <li><strong>é”™è¯¯å¤„ç†</strong>ï¼šä½¿ç”¨ try/catch æ•è·é”™è¯¯</li>
                    <li><strong>èµ„æºæ¸…ç†</strong>ï¼šå®ç° return() æˆ–ä½¿ç”¨ finally</li>
                    <li><strong>æ§åˆ¶å¹¶å‘</strong>ï¼šé¿å…è¿‡å¤šå¹¶å‘è¯·æ±‚</li>
                    <li><strong>æå‰ç»ˆæ­¢</strong>ï¼šä½¿ç”¨ break æˆ– return é€€å‡º</li>
                    <li><strong>ç±»å‹æ ‡æ³¨</strong>ï¼šTypeScript ä¸­æ˜ç¡®ç±»å‹</li>
                </ol>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="https://tc39.es/ecma262/#sec-asynciterator-interface" target="_blank">ECMAScript - AsyncIterator</a></li>
                <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Statements/for-await...of" target="_blank">MDN - for await...of</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="17-generator.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šç”Ÿæˆå™¨å‡½æ•°</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="18-promise-aplus.html" class="nav-link next">ä¸‹ä¸€èŠ‚ï¼šPromise/A+</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šå¼‚æ­¥è¿­ä»£å™¨åŸºç¡€</h3>
                <div class="code-block">
                    <pre><code>// æ‰‹åŠ¨å®ç°å¼‚æ­¥è¿­ä»£å™¨
console.log('=== å¼‚æ­¥è¿­ä»£å™¨ ===\n');

const asyncIterable = {
    data: ['a', 'b', 'c'],
    
    [Symbol.asyncIterator]() {
        let index = 0;
        const data = this.data;
        
        return {
            async next() {
                // æ¨¡æ‹Ÿå¼‚æ­¥å»¶è¿Ÿ
                await new Promise(r => setTimeout(r, 100));
                
                if (index < data.length) {
                    return { value: data[index++], done: false };
                } else {
                    return { value: undefined, done: true };
                }
            }
        };
    }
};

async function test() {
    console.log('å¼€å§‹è¿­ä»£...');
    
    for await (const value of asyncIterable) {
        console.log('  å€¼:', value);
    }
    
    console.log('è¿­ä»£å®Œæˆ');
}

test();</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šå¼‚æ­¥ç”Ÿæˆå™¨</h3>
                <div class="code-block">
                    <pre><code>// async function* è¯­æ³•
console.log('=== å¼‚æ­¥ç”Ÿæˆå™¨ ===\n');

async function* countDown(from) {
    console.log('å€’è®¡æ—¶å¼€å§‹:', from);
    
    while (from > 0) {
        await new Promise(r => setTimeout(r, 500));
        yield from--;
    }
    
    console.log('å€’è®¡æ—¶ç»“æŸ');
}

async function runCountdown() {
    console.log('å‡†å¤‡å€’è®¡æ—¶...');
    
    for await (const num of countDown(3)) {
        console.log('  æ•°å­—:', num);
    }
    
    console.log('å®Œæˆï¼');
}

runCountdown();</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šæ¨¡æ‹Ÿåˆ†é¡µ API</h3>
                <div class="code-block">
                    <pre><code>// è‡ªåŠ¨å¤„ç†åˆ†é¡µçš„å¼‚æ­¥ç”Ÿæˆå™¨
console.log('=== åˆ†é¡µ API ===\n');

// æ¨¡æ‹Ÿ API æ•°æ®
const mockAPI = {
    data: Array(15).fill(0).map((_, i) => ({ id: i + 1, name: `Item ${i + 1}` })),
    
    async fetch(page, pageSize) {
        await new Promise(r => setTimeout(r, 200));
        const start = (page - 1) * pageSize;
        const end = start + pageSize;
        const items = this.data.slice(start, end);
        
        return {
            items,
            hasMore: end < this.data.length,
            page
        };
    }
};

async function* fetchAllItems(pageSize = 5) {
    let page = 1;
    let hasMore = true;
    
    while (hasMore) {
        console.log(`  è¯·æ±‚ç¬¬ ${page} é¡µ...`);
        const result = await mockAPI.fetch(page, pageSize);
        
        for (const item of result.items) {
            yield item;
        }
        
        hasMore = result.hasMore;
        page++;
    }
}

async function loadAll() {
    console.log('å¼€å§‹åŠ è½½æ‰€æœ‰æ•°æ®...\n');
    
    let count = 0;
    for await (const item of fetchAllItems()) {
        console.log(`  ${item.id}: ${item.name}`);
        count++;
    }
    
    console.log(`\næ€»å…±åŠ è½½ ${count} é¡¹`);
}

loadAll();</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼šPromise æ•°ç»„</h3>
                <div class="code-block">
                    <pre><code>// for await...of å¤„ç† Promise æ•°ç»„
console.log('=== Promise æ•°ç»„ ===\n');

function createDelayedPromise(value, delay) {
    return new Promise(resolve => {
        setTimeout(() => {
            console.log(`  Promise ${value} resolved`);
            resolve(value);
        }, delay);
    });
}

async function processPromises() {
    const promises = [
        createDelayedPromise(1, 300),
        createDelayedPromise(2, 100),
        createDelayedPromise(3, 200)
    ];
    
    console.log('å¼€å§‹å¤„ç† Promise æ•°ç»„...\n');
    
    for await (const value of promises) {
        console.log('  å¤„ç†å€¼:', value);
    }
    
    console.log('\nå®Œæˆï¼');
    console.log('æ³¨æ„: æŒ‰é¡ºåºç­‰å¾…ï¼Œä¸æ˜¯å¹¶å‘');
}

processPromises();</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šé”™è¯¯å¤„ç†</h3>
                <div class="code-block">
                    <pre><code>// å¼‚æ­¥è¿­ä»£ä¸­çš„é”™è¯¯å¤„ç†
console.log('=== é”™è¯¯å¤„ç† ===\n');

async function* mayFail() {
    yield 1;
    await new Promise(r => setTimeout(r, 100));
    
    yield 2;
    await new Promise(r => setTimeout(r, 100));
    
    throw new Error('æ¨¡æ‹Ÿé”™è¯¯');
    yield 3;  // ä¸ä¼šæ‰§è¡Œ
}

async function handleErrors() {
    try {
        console.log('å¼€å§‹è¿­ä»£...');
        
        for await (const value of mayFail()) {
            console.log('  å€¼:', value);
        }
        
        console.log('æ­£å¸¸ç»“æŸ');
    } catch (e) {
        console.log('\næ•è·é”™è¯¯:', e.message);
    } finally {
        console.log('æ¸…ç†å®Œæˆ');
    }
}

handleErrors();</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šæå‰ç»ˆæ­¢</h3>
                <div class="code-block">
                    <pre><code>// æå‰ç»ˆæ­¢å¼‚æ­¥è¿­ä»£
console.log('=== æå‰ç»ˆæ­¢ ===\n');

async function* infiniteStream() {
    let count = 1;
    
    try {
        while (true) {
            console.log(`  ç”Ÿæˆ ${count}`);
            await new Promise(r => setTimeout(r, 200));
            yield count++;
        }
    } finally {
        console.log('  æ¸…ç†èµ„æºï¼ˆfinallyï¼‰');
    }
}

async function consumeStream() {
    console.log('å¼€å§‹æ¶ˆè´¹æµ...\n');
    
    for await (const value of infiniteStream()) {
        console.log(`  æ¥æ”¶: ${value}`);
        
        if (value >= 3) {
            console.log('  è¾¾åˆ°æ¡ä»¶ï¼Œæå‰é€€å‡º');
            break;  // è§¦å‘ finally
        }
    }
    
    console.log('\næµå·²å…³é—­');
}

consumeStream();</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
