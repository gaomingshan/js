<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JavaScript å¹¶å‘æ¨¡å‹ - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>JavaScript å¹¶å‘æ¨¡å‹</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>JavaScript é‡‡ç”¨å•çº¿ç¨‹ã€åŸºäºäº‹ä»¶å¾ªç¯çš„å¹¶å‘æ¨¡å‹ã€‚è™½ç„¶æ˜¯å•çº¿ç¨‹ï¼Œä½†é€šè¿‡å¼‚æ­¥ç¼–ç¨‹å¯ä»¥å®ç°é«˜æ•ˆçš„å¹¶å‘å¤„ç†ã€‚ç†è§£è¿™ä¸ªæ¨¡å‹å¯¹äºç¼–å†™é«˜æ€§èƒ½åº”ç”¨è‡³å…³é‡è¦ã€‚</p>
            
            <h2>ä¸€ã€å•çº¿ç¨‹æ¨¡å‹</h2>
            
            <h3>1.1 ä¸ºä»€ä¹ˆæ˜¯å•çº¿ç¨‹</h3>
            <div class="info">
                <p><strong>å†å²åŸå› </strong>ï¼š</p>
                <ul>
                    <li>JavaScript æœ€åˆè®¾è®¡ä¸ºæµè§ˆå™¨è„šæœ¬è¯­è¨€</li>
                    <li>é¿å… DOM æ“ä½œçš„ç«æ€æ¡ä»¶</li>
                    <li>ç®€åŒ–ç¼–ç¨‹æ¨¡å‹</li>
                </ul>
                
                <p><strong>ä¼˜ç‚¹</strong>ï¼š</p>
                <ul>
                    <li>æ— éœ€å¤„ç†çº¿ç¨‹åŒæ­¥</li>
                    <li>é¿å…æ­»é”é—®é¢˜</li>
                    <li>ä»£ç æ‰§è¡Œé¡ºåºå¯é¢„æµ‹</li>
                </ul>
                
                <p><strong>ç¼ºç‚¹</strong>ï¼š</p>
                <ul>
                    <li>é•¿æ—¶é—´è¿ç®—ä¼šé˜»å¡</li>
                    <li>æ— æ³•åˆ©ç”¨å¤šæ ¸ CPU</li>
                </ul>
            </div>
            
            <h3>1.2 Run-to-Completion</h3>
            <pre><code>// JavaScript æ‰§è¡Œéµå¾ª Run-to-Completion åŸåˆ™
// ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶ä¸ä¼šè¢«å…¶ä»–ä»»åŠ¡ä¸­æ–­

function task1() {
    console.log('Task 1 start');
    for (let i = 0; i < 1000000000; i++) {
        // é•¿æ—¶é—´è¿ç®—ï¼Œä¸ä¼šè¢«ä¸­æ–­
    }
    console.log('Task 1 end');
}

function task2() {
    console.log('Task 2');
}

task1();  // å¿…é¡»å®Œå…¨æ‰§è¡Œå®Œ
task2();  // æ‰èƒ½æ‰§è¡Œè¿™ä¸ª

// Task 1 æœŸé—´ï¼Œå…¶ä»–ä»»åŠ¡æ— æ³•æ‰§è¡Œ</code></pre>
            
            <h2>äºŒã€å¹¶å‘ vs å¹¶è¡Œ</h2>
            
            <h3>2.1 æ¦‚å¿µåŒºåˆ†</h3>
            <pre><code>// å¹¶å‘ï¼ˆConcurrencyï¼‰ï¼šå¤šä¸ªä»»åŠ¡åœ¨é‡å çš„æ—¶é—´æ®µå†…æ‰§è¡Œ
// å¹¶è¡Œï¼ˆParallelismï¼‰ï¼šå¤šä¸ªä»»åŠ¡åœ¨åŒä¸€æ—¶åˆ»æ‰§è¡Œ

// JavaScript æ˜¯å¹¶å‘çš„ï¼Œä½†ä¸æ˜¯å¹¶è¡Œçš„

// å¹¶å‘ç¤ºä¾‹ï¼ˆJavaScriptï¼‰ï¼š
Promise.all([
    fetch('/api/user'),
    fetch('/api/posts'),
    fetch('/api/comments')
]);
// ä¸‰ä¸ªè¯·æ±‚å¹¶å‘è¿›è¡Œï¼Œä½† JavaScript ä»£ç æ˜¯å•çº¿ç¨‹æ‰§è¡Œ

// çœŸæ­£çš„å¹¶è¡Œéœ€è¦ Web Workersï¼š
const worker1 = new Worker('worker1.js');
const worker2 = new Worker('worker2.js');
// ä¸¤ä¸ª Worker å¯ä»¥å¹¶è¡Œè¿è¡Œ</code></pre>
            
            <h3>2.2 å¯è§†åŒ–å¯¹æ¯”</h3>
            <pre><code>// å¹¶å‘ï¼ˆConcurrencyï¼‰ï¼š
// æ—¶é—´ â†’
// Task A: â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆ
// Task B: â–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘
// äº¤æ›¿æ‰§è¡Œï¼Œå•æ ¸ CPU

// å¹¶è¡Œï¼ˆParallelismï¼‰ï¼š
// æ—¶é—´ â†’
// Task A: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (Core 1)
// Task B: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  (Core 2)
// åŒæ—¶æ‰§è¡Œï¼Œå¤šæ ¸ CPU</code></pre>
            
            <h2>ä¸‰ã€å¼‚æ­¥å¹¶å‘æ¨¡å¼</h2>
            
            <h3>3.1 å›è°ƒæ¨¡å¼</h3>
            <pre><code>// ä¼ ç»Ÿå›è°ƒå®ç°å¹¶å‘
function fetchData(callback) {
    setTimeout(() => {
        callback('Data');
    }, 100);
}

function fetchUser(callback) {
    setTimeout(() => {
        callback('User');
    }, 100);
}

// å¹¶å‘æ‰§è¡Œ
let results = [];
let count = 0;

fetchData(data => {
    results[0] = data;
    if (++count === 2) done();
});

fetchUser(user => {
    results[1] = user;
    if (++count === 2) done();
});

function done() {
    console.log('All done:', results);
}</code></pre>
            
            <h3>3.2 Promise å¹¶å‘</h3>
            <pre><code>// Promise.all - ç­‰å¾…æ‰€æœ‰å®Œæˆ
Promise.all([
    fetch('/api/data'),
    fetch('/api/user'),
    fetch('/api/posts')
]).then(results => {
    console.log('All resolved:', results);
}).catch(error => {
    console.log('Any rejected:', error);
});

// Promise.race - ç¬¬ä¸€ä¸ªå®Œæˆ
Promise.race([
    fetch('/api/fast'),
    fetch('/api/slow')
]).then(result => {
    console.log('First resolved:', result);
});

// Promise.allSettled - ç­‰å¾…æ‰€æœ‰å®Œæˆï¼ˆä¸ç®¡æˆåŠŸå¤±è´¥ï¼‰
Promise.allSettled([
    Promise.resolve(1),
    Promise.reject('error'),
    Promise.resolve(3)
]).then(results => {
    // [
    //   { status: 'fulfilled', value: 1 },
    //   { status: 'rejected', reason: 'error' },
    //   { status: 'fulfilled', value: 3 }
    // ]
});

// Promise.any - ç¬¬ä¸€ä¸ªæˆåŠŸ
Promise.any([
    Promise.reject('error1'),
    Promise.resolve('success'),
    Promise.reject('error2')
]).then(result => {
    console.log('First fulfilled:', result);  // 'success'
});</code></pre>
            
            <h3>3.3 async/await å¹¶å‘</h3>
            <pre><code>// é”™è¯¯ï¼šé¡ºåºæ‰§è¡Œï¼ˆä¸å¹¶å‘ï¼‰
async function sequential() {
    const data1 = await fetch('/api/data1');  // ç­‰å¾…
    const data2 = await fetch('/api/data2');  // ç„¶åç­‰å¾…
    return [data1, data2];
}

// æ­£ç¡®ï¼šå¹¶å‘æ‰§è¡Œ
async function concurrent() {
    const promise1 = fetch('/api/data1');  // ç«‹å³å¼€å§‹
    const promise2 = fetch('/api/data2');  // ç«‹å³å¼€å§‹
    
    const data1 = await promise1;  // ç­‰å¾…ç¬¬ä¸€ä¸ª
    const data2 = await promise2;  // ç­‰å¾…ç¬¬äºŒä¸ª
    return [data1, data2];
}

// æˆ–ä½¿ç”¨ Promise.all
async function concurrentAll() {
    const [data1, data2] = await Promise.all([
        fetch('/api/data1'),
        fetch('/api/data2')
    ]);
    return [data1, data2];
}</code></pre>
            
            <h2>å››ã€å¹¶å‘æ§åˆ¶</h2>
            
            <h3>4.1 é™åˆ¶å¹¶å‘æ•°é‡</h3>
            <pre><code>// å¹¶å‘æ‰§è¡Œï¼Œä½†é™åˆ¶åŒæ—¶è¿è¡Œçš„æ•°é‡
class ConcurrencyLimiter {
    constructor(limit) {
        this.limit = limit;
        this.running = 0;
        this.queue = [];
    }
    
    async run(task) {
        while (this.running >= this.limit) {
            await new Promise(resolve => this.queue.push(resolve));
        }
        
        this.running++;
        
        try {
            return await task();
        } finally {
            this.running--;
            const resolve = this.queue.shift();
            if (resolve) resolve();
        }
    }
}

// ä½¿ç”¨
const limiter = new ConcurrencyLimiter(3);

const tasks = Array(10).fill(0).map((_, i) => 
    () => fetch(`/api/data${i}`)
);

const results = await Promise.all(
    tasks.map(task => limiter.run(task))
);
// æœ€å¤šåŒæ—¶ 3 ä¸ªè¯·æ±‚</code></pre>
            
            <h3>4.2 ä»»åŠ¡é˜Ÿåˆ—</h3>
            <pre><code>// ä¸²è¡Œæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—
class TaskQueue {
    constructor() {
        this.queue = [];
        this.running = false;
    }
    
    add(task) {
        return new Promise((resolve, reject) => {
            this.queue.push(async () => {
                try {
                    const result = await task();
                    resolve(result);
                } catch (error) {
                    reject(error);
                }
            });
            
            if (!this.running) {
                this.run();
            }
        });
    }
    
    async run() {
        this.running = true;
        
        while (this.queue.length > 0) {
            const task = this.queue.shift();
            await task();
        }
        
        this.running = false;
    }
}

// ä½¿ç”¨
const queue = new TaskQueue();
queue.add(() => fetch('/api/1'));
queue.add(() => fetch('/api/2'));
queue.add(() => fetch('/api/3'));
// æŒ‰é¡ºåºæ‰§è¡Œ</code></pre>
            
            <h2>äº”ã€Web Workers</h2>
            
            <h3>5.1 çœŸæ­£çš„å¹¶è¡Œ</h3>
            <pre><code>// ä¸»çº¿ç¨‹
const worker = new Worker('worker.js');

// å‘é€æ¶ˆæ¯
worker.postMessage({ type: 'calculate', data: [1, 2, 3] });

// æ¥æ”¶æ¶ˆæ¯
worker.onmessage = (event) => {
    console.log('Result:', event.data);
};

// worker.js
self.onmessage = (event) => {
    if (event.data.type === 'calculate') {
        // æ‰§è¡Œè®¡ç®—å¯†é›†å‹ä»»åŠ¡
        const result = heavyCalculation(event.data.data);
        self.postMessage(result);
    }
};

function heavyCalculation(data) {
    // ä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹
    let sum = 0;
    for (let i = 0; i < 1000000000; i++) {
        sum += data[i % data.length];
    }
    return sum;
}</code></pre>
            
            <h3>5.2 Worker Pool</h3>
            <pre><code>// Worker æ± ç®¡ç†
class WorkerPool {
    constructor(workerScript, poolSize) {
        this.workers = [];
        this.queue = [];
        
        for (let i = 0; i < poolSize; i++) {
            const worker = new Worker(workerScript);
            worker.busy = false;
            worker.onmessage = (event) => {
                worker.busy = false;
                worker.resolve(event.data);
                this.runNext();
            };
            this.workers.push(worker);
        }
    }
    
    async run(data) {
        return new Promise((resolve, reject) => {
            this.queue.push({ data, resolve, reject });
            this.runNext();
        });
    }
    
    runNext() {
        const worker = this.workers.find(w => !w.busy);
        if (worker && this.queue.length > 0) {
            const { data, resolve, reject } = this.queue.shift();
            worker.busy = true;
            worker.resolve = resolve;
            worker.postMessage(data);
        }
    }
}

// ä½¿ç”¨
const pool = new WorkerPool('worker.js', 4);
const results = await Promise.all([
    pool.run({ task: 1 }),
    pool.run({ task: 2 }),
    pool.run({ task: 3 }),
    pool.run({ task: 4 }),
    pool.run({ task: 5 })
]);
// æœ€å¤š 4 ä¸ª Worker å¹¶è¡Œ</code></pre>
            
            <h2>å…­ã€SharedArrayBuffer ä¸ Atomics</h2>
            
            <h3>6.1 å…±äº«å†…å­˜</h3>
            <pre><code>// ä¸»çº¿ç¨‹
const sab = new SharedArrayBuffer(1024);
const view = new Int32Array(sab);

const worker = new Worker('worker.js');
worker.postMessage({ buffer: sab });

// Worker çº¿ç¨‹
self.onmessage = (event) => {
    const view = new Int32Array(event.data.buffer);
    
    // åŸå­æ“ä½œ
    Atomics.add(view, 0, 1);  // view[0] += 1ï¼ˆåŸå­æ€§ï¼‰
    Atomics.store(view, 1, 42);  // view[1] = 42
    
    // ç­‰å¾…/é€šçŸ¥
    Atomics.wait(view, 2, 0);  // ç­‰å¾… view[2] !== 0
    Atomics.notify(view, 2, 1);  // é€šçŸ¥ä¸€ä¸ªç­‰å¾…è€…
};</code></pre>
            
            <h2>ä¸ƒã€æœ€ä½³å®è·µ</h2>
            
            <div class="tip">
                <ol>
                    <li><strong>ç†è§£å•çº¿ç¨‹</strong>ï¼šé¿å…é•¿æ—¶é—´é˜»å¡æ“ä½œ</li>
                    <li><strong>å¼‚æ­¥ I/O</strong>ï¼šç½‘ç»œã€æ–‡ä»¶æ“ä½œç”¨å¼‚æ­¥</li>
                    <li><strong>Promise.all å¹¶å‘</strong>ï¼šå¤šä¸ªç‹¬ç«‹ä»»åŠ¡åŒæ—¶æ‰§è¡Œ</li>
                    <li><strong>æ§åˆ¶å¹¶å‘æ•°</strong>ï¼šé¿å…èµ„æºè€—å°½</li>
                    <li><strong>Worker å¤„ç†å¯†é›†è®¡ç®—</strong>ï¼šä¸é˜»å¡ä¸»çº¿ç¨‹</li>
                    <li><strong>é¿å…åµŒå¥—å›è°ƒ</strong>ï¼šä½¿ç”¨ Promise æˆ– async/await</li>
                    <li><strong>é”™è¯¯å¤„ç†</strong>ï¼šå¹¶å‘ä»»åŠ¡çš„é”™è¯¯è¦å¦¥å–„å¤„ç†</li>
                </ol>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop" target="_blank">MDN - äº‹ä»¶å¾ªç¯</a></li>
                <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Web_Workers_API" target="_blank">MDN - Web Workers</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="19-task-queue.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šå®ä»»åŠ¡ä¸å¾®ä»»åŠ¡</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="20-proxy.html" class="nav-link next">ä¸‹ä¸€èŠ‚ï¼šProxy ä»£ç†</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šRun-to-Completion</h3>
                <div class="code-block">
                    <pre><code>// Run-to-Completion åŸåˆ™
console.log('=== Run-to-Completion ===\n');

function heavyTask() {
    console.log('å¼€å§‹å¯†é›†è®¡ç®—...');
    const start = Date.now();
    
    // æ¨¡æ‹Ÿå¯†é›†è®¡ç®—ï¼ˆ100msï¼‰
    while (Date.now() - start < 100) {
        // è®¡ç®—ä¸­ï¼Œä¸ä¼šè¢«ä¸­æ–­
    }
    
    console.log('è®¡ç®—å®Œæˆï¼ˆ100msï¼‰');
}

console.log('1: å¼€å§‹');

setTimeout(() => {
    console.log('3: è¿™ä¸ªè¦ç­‰ heavyTask å®Œæˆ');
}, 0);

heavyTask();  // é˜»å¡æ‰§è¡Œ

console.log('2: ç»“æŸ');

console.log('\nè¯´æ˜:');
console.log('  heavyTask æ‰§è¡ŒæœŸé—´ä¸ä¼šè¢«ä¸­æ–­');
console.log('  setTimeout å¿…é¡»ç­‰å¾…');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šé¡ºåº vs å¹¶å‘</h3>
                <div class="code-block">
                    <pre><code>// async/await é¡ºåºæ‰§è¡Œ vs å¹¶å‘æ‰§è¡Œ
console.log('=== é¡ºåº vs å¹¶å‘ ===\n');

function delay(ms, value) {
    return new Promise(resolve => {
        setTimeout(() => resolve(value), ms);
    });
}

async function sequential() {
    console.log('é¡ºåºæ‰§è¡Œå¼€å§‹');
    const start = Date.now();
    
    const result1 = await delay(100, 'A');
    console.log('  æ”¶åˆ°:', result1);
    
    const result2 = await delay(100, 'B');
    console.log('  æ”¶åˆ°:', result2);
    
    console.log('  æ€»è€—æ—¶:', Date.now() - start, 'ms\n');
}

async function concurrent() {
    console.log('å¹¶å‘æ‰§è¡Œå¼€å§‹');
    const start = Date.now();
    
    const [result1, result2] = await Promise.all([
        delay(100, 'A'),
        delay(100, 'B')
    ]);
    
    console.log('  æ”¶åˆ°:', result1, result2);
    console.log('  æ€»è€—æ—¶:', Date.now() - start, 'ms');
}

sequential().then(() => concurrent());</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šPromise å¹¶å‘æ–¹æ³•</h3>
                <div class="code-block">
                    <pre><code>// Promise å¹¶å‘æ§åˆ¶æ–¹æ³•
console.log('=== Promise å¹¶å‘æ–¹æ³• ===\n');

const promises = [
    Promise.resolve('Success 1'),
    Promise.reject('Error'),
    Promise.resolve('Success 2')
];

console.log('1. Promise.allï¼ˆä»»ä¸€å¤±è´¥åˆ™å¤±è´¥ï¼‰:');
Promise.all(promises)
    .then(r => console.log('  ç»“æœ:', r))
    .catch(e => console.log('  é”™è¯¯:', e));

setTimeout(() => {
    console.log('\n2. Promise.allSettledï¼ˆå…¨éƒ¨å®Œæˆï¼‰:');
    Promise.allSettled(promises)
        .then(results => {
            results.forEach((r, i) => {
                console.log(`  [${i}]:`, r);
            });
        });
}, 100);

setTimeout(() => {
    console.log('\n3. Promise.raceï¼ˆç¬¬ä¸€ä¸ªå®Œæˆï¼‰:');
    Promise.race([
        new Promise(r => setTimeout(() => r('Slow'), 200)),
        new Promise(r => setTimeout(() => r('Fast'), 100))
    ]).then(r => console.log('  ç»“æœ:', r));
}, 200);</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼šå¹¶å‘æ•°é‡é™åˆ¶</h3>
                <div class="code-block">
                    <pre><code>// é™åˆ¶å¹¶å‘æ•°é‡
console.log('=== å¹¶å‘é™åˆ¶ ===\n');

class ConcurrencyLimiter {
    constructor(limit) {
        this.limit = limit;
        this.running = 0;
        this.queue = [];
    }
    
    async run(task) {
        while (this.running >= this.limit) {
            await new Promise(resolve => this.queue.push(resolve));
        }
        
        this.running++;
        console.log(`  å¼€å§‹ä»»åŠ¡ï¼ˆè¿è¡Œä¸­: ${this.running}ï¼‰`);
        
        try {
            return await task();
        } finally {
            this.running--;
            console.log(`  å®Œæˆä»»åŠ¡ï¼ˆè¿è¡Œä¸­: ${this.running}ï¼‰`);
            const resolve = this.queue.shift();
            if (resolve) resolve();
        }
    }
}

async function test() {
    const limiter = new ConcurrencyLimiter(2);  // æœ€å¤š2ä¸ªå¹¶å‘
    
    const tasks = Array(5).fill(0).map((_, i) =>
        () => new Promise(resolve => {
            setTimeout(() => resolve(`Task ${i + 1}`), 100);
        })
    );
    
    console.log('å¼€å§‹æ‰§è¡Œ 5 ä¸ªä»»åŠ¡ï¼ˆé™åˆ¶2ä¸ªå¹¶å‘ï¼‰:\n');
    
    const results = await Promise.all(
        tasks.map(task => limiter.run(task))
    );
    
    console.log('\næ‰€æœ‰ä»»åŠ¡å®Œæˆ:', results);
}

test();</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šä»»åŠ¡é˜Ÿåˆ—</h3>
                <div class="code-block">
                    <pre><code>// ä¸²è¡Œä»»åŠ¡é˜Ÿåˆ—
console.log('=== ä»»åŠ¡é˜Ÿåˆ— ===\n');

class TaskQueue {
    constructor() {
        this.queue = [];
        this.running = false;
    }
    
    add(task) {
        const promise = new Promise((resolve, reject) => {
            this.queue.push(async () => {
                try {
                    const result = await task();
                    resolve(result);
                } catch (error) {
                    reject(error);
                }
            });
        });
        
        if (!this.running) {
            this.run();
        }
        
        return promise;
    }
    
    async run() {
        this.running = true;
        
        while (this.queue.length > 0) {
            const task = this.queue.shift();
            await task();
        }
        
        this.running = false;
        console.log('  é˜Ÿåˆ—æ‰§è¡Œå®Œæ¯•\n');
    }
}

const queue = new TaskQueue();

console.log('æ·»åŠ  3 ä¸ªä»»åŠ¡:\n');

queue.add(async () => {
    await new Promise(r => setTimeout(r, 100));
    console.log('  Task 1 å®Œæˆ');
    return 1;
});

queue.add(async () => {
    await new Promise(r => setTimeout(r, 100));
    console.log('  Task 2 å®Œæˆ');
    return 2;
});

queue.add(async () => {
    await new Promise(r => setTimeout(r, 100));
    console.log('  Task 3 å®Œæˆ');
    return 3;
});

console.log('ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œ...');</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šå¹¶å‘æ¨¡å¼å¯¹æ¯”</h3>
                <div class="code-block">
                    <pre><code>// ä¸åŒå¹¶å‘æ¨¡å¼çš„å¯¹æ¯”
console.log('=== å¹¶å‘æ¨¡å¼å¯¹æ¯” ===\n');

function task(id, duration) {
    return new Promise(resolve => {
        console.log(`  Task ${id} å¼€å§‹`);
        setTimeout(() => {
            console.log(`  Task ${id} å®Œæˆ`);
            resolve(id);
        }, duration);
    });
}

async function test() {
    console.log('1. å®Œå…¨å¹¶å‘ï¼ˆPromise.allï¼‰:');
    const start1 = Date.now();
    await Promise.all([
        task(1, 100),
        task(2, 100),
        task(3, 100)
    ]);
    console.log(`  æ€»è€—æ—¶: ${Date.now() - start1}ms\n`);
    
    await new Promise(r => setTimeout(r, 200));
    
    console.log('2. å®Œå…¨é¡ºåº:');
    const start2 = Date.now();
    await task(4, 100);
    await task(5, 100);
    await task(6, 100);
    console.log(`  æ€»è€—æ—¶: ${Date.now() - start2}ms\n`);
    
    console.log('è¯´æ˜:');
    console.log('  å¹¶å‘: ~100ms');
    console.log('  é¡ºåº: ~300ms');
}

test();</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
