# 正则表达式完全指南

## 概述

正则表达式（RegExp）是文本匹配与提取的强力工具。JavaScript 的正则引擎通常是**回溯型（backtracking）**实现：

- 优点：表达力强
- 风险：某些模式在特定输入下可能出现指数级回溯（ReDoS 风险）

本章用精简但足够深入的方式覆盖：语法、API、flags、状态陷阱与性能要点。

---

## 一、创建 RegExp

### 1.1 字面量

```js
const r = /abc/i;
```

- 语法简洁
- 通常更适合静态模式

### 1.2 构造函数（动态拼接）

```js
const word = 'abc';
const r = new RegExp(word, 'i');
```

> **提示**
>
> 构造函数里字符串需要双重转义（`"\\d"` 才代表 `\d`）。

---

## 二、Flags（高频）

- `g`：全局匹配（会影响 `lastIndex`）
- `i`：忽略大小写
- `m`：多行（影响 `^$`）
- `s`：dotAll（`.` 匹配换行）
- `u`：Unicode（启用码点语义、支持 `\p{...}`）
- `y`：sticky（从 `lastIndex` 精确位置开始）
- `d`：indices（ES2022，返回匹配索引）

---

## 三、核心语法速览

### 3.1 字符类

- `\d` 数字，`\w` 单词字符，`\s` 空白
- `[...]` 自定义集合，`[^...]` 取反

### 3.2 量词与贪婪/非贪婪

- `* + ? {n,m}`
- 默认贪婪，`+?` / `*?` 为非贪婪

```js
'<div>t</div>'.match(/<.+>/)[0];   // '<div>t</div>'
'<div>t</div>'.match(/<.+?>/)[0];  // '<div>'
```

### 3.3 分组与引用

- 捕获组：`(...)`
- 非捕获组：`(?:...)`
- 命名捕获：`(?<name>...)`
- 反向引用：`\1` / `\k<name>`

---

## 四、API：test / exec / match

### 4.1 `test()` 与 `exec()`

- `test`：只关心是否匹配
- `exec`：拿到匹配详情（含 groups、index 等）

### 4.2 关键陷阱：`g` 会让正则“有状态”

带 `g/y` 的正则会更新 `lastIndex`，因此在循环或多次调用 `test` 时可能出现“忽真忽假”：

```js
const r = /a/g;

r.test('a'); // true
r.test('a'); // false（lastIndex 已移动）
```

解决方式：

- 不需要全局就不要加 `g`
- 或每次手动 `r.lastIndex = 0`

---

## 五、Lookaround（前瞻/后顾）

- 正向前瞻：`(?=...)`
- 负向前瞻：`(?!...)`
- 正向后顾：`(?<=...)`（ES2018）
- 负向后顾：`(?<!...)`

例：提取 `$` 后的数字：

```js
'$100'.match(/(?<=\$)\d+/)[0]; // '100'
```

---

## 六、深入原理：回溯与 ReDoS（必须知道）

回溯型引擎在遇到“可变分支 + 失败”时会尝试大量路径。

典型危险模式：嵌套量词

```js
/^(a+)+$/
```

在输入接近匹配但最终失败时（如 `'aaaa...ab'`）可能产生指数级回溯。

### 6.1 规避策略

1. **避免嵌套量词**：能写 `^a+$` 就别写 `^(a+)+$`
2. **加边界**：`^...$` 限制扫描范围
3. **限制长度**：对用户输入做长度限制
4. **拆分逻辑**：复杂校验用多段简单正则/普通逻辑组合

> **提示**
>
> 正则是工具，不是“越复杂越厉害”。复杂正则要配套测试用例与性能评估。

---

## 七、最佳实践（高信噪比）

1. 复杂正则要写注释/拆分。
2. 捕获组只在需要时使用（否则用 `(?:...)`）。
3. 需要 Unicode 语义时开启 `u`（并考虑 `\p{...}`）。
4. 不要把用户输入直接拼进正则（需要转义）。

---

## 参考资料

- [MDN - Regular Expressions](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Regular_Expressions)
- [ECMA-262 - RegExp](https://tc39.es/ecma262/#sec-regexp-regular-expression-objects)
- [RegExr](https://regexr.com/)
