<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—­åŒ…åŸç†ä¸åº”ç”¨ - JavaScript æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="../assets/css/main.css">
    <link rel="stylesheet" href="../assets/css/page.css">
</head>
<body>
    <div class="page-layout">
        <div class="doc-panel">
            <h1>é—­åŒ…åŸç†ä¸åº”ç”¨</h1>
            
            <h2>æ¦‚è¿°</h2>
            <p>é—­åŒ…ï¼ˆClosureï¼‰æ˜¯ JavaScript ä¸­æœ€å¼ºå¤§ä¹Ÿæœ€å®¹æ˜“è¢«è¯¯è§£çš„ç‰¹æ€§ä¹‹ä¸€ã€‚å®ƒæ˜¯å‡½æ•°å’Œå£°æ˜è¯¥å‡½æ•°çš„è¯æ³•ç¯å¢ƒçš„ç»„åˆã€‚</p>
            
            <div class="tip">
                <strong>ç®€å•å®šä¹‰ï¼š</strong>é—­åŒ…æ˜¯æŒ‡æœ‰æƒè®¿é—®å¦ä¸€ä¸ªå‡½æ•°ä½œç”¨åŸŸä¸­å˜é‡çš„å‡½æ•°ã€‚
            </div>
            
            <h2>ä¸€ã€é—­åŒ…çš„å½¢æˆæ¡ä»¶</h2>
            
            <h3>1.1 å¿…è¦æ¡ä»¶</h3>
            <ol>
                <li>å‡½æ•°åµŒå¥—ï¼šå†…éƒ¨å‡½æ•°å¼•ç”¨å¤–éƒ¨å‡½æ•°çš„å˜é‡</li>
                <li>å¤–éƒ¨å‡½æ•°è¢«è°ƒç”¨ï¼Œè¿”å›å†…éƒ¨å‡½æ•°</li>
                <li>å†…éƒ¨å‡½æ•°åœ¨å¤–éƒ¨è¢«æ‰§è¡Œ</li>
            </ol>
            
            <h3>1.2 è¯æ³•ä½œç”¨åŸŸ</h3>
            <p>JavaScript é‡‡ç”¨è¯æ³•ä½œç”¨åŸŸï¼ˆé™æ€ä½œç”¨åŸŸï¼‰ï¼Œå‡½æ•°çš„ä½œç”¨åŸŸåœ¨å‡½æ•°å®šä¹‰æ—¶å°±ç¡®å®šäº†ï¼Œè€Œä¸æ˜¯åœ¨å‡½æ•°è°ƒç”¨æ—¶ç¡®å®šã€‚</p>
            
            <div class="spec">
                <strong>ECMAScript è§„èŒƒï¼š</strong>æ¯ä¸ªå‡½æ•°éƒ½æœ‰ä¸€ä¸ªå†…éƒ¨å±æ€§ [[Environment]]ï¼Œå®ƒä¿å­˜äº†å‡½æ•°å®šä¹‰æ—¶çš„è¯æ³•ç¯å¢ƒå¼•ç”¨ã€‚è¿™å°±æ˜¯é—­åŒ…çš„åŸºç¡€ã€‚
            </div>
            
            <h2>äºŒã€é—­åŒ…çš„å·¥ä½œåŸç†</h2>
            
            <h3>2.1 æ‰§è¡Œä¸Šä¸‹æ–‡</h3>
            <p>å½“å‡½æ•°æ‰§è¡Œæ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªæ‰§è¡Œä¸Šä¸‹æ–‡ï¼ˆExecution Contextï¼‰ï¼ŒåŒ…å«ï¼š</p>
            <ul>
                <li><strong>å˜é‡ç¯å¢ƒ</strong>ï¼ˆVariable Environmentï¼‰ï¼šå­˜å‚¨ var å£°æ˜å’Œå‡½æ•°å£°æ˜</li>
                <li><strong>è¯æ³•ç¯å¢ƒ</strong>ï¼ˆLexical Environmentï¼‰ï¼šå­˜å‚¨ let/const å£°æ˜</li>
                <li><strong>å¤–éƒ¨ç¯å¢ƒå¼•ç”¨</strong>ï¼ˆOuter Referenceï¼‰ï¼šæŒ‡å‘å¤–å±‚ä½œç”¨åŸŸ</li>
            </ul>
            
            <h3>2.2 ä½œç”¨åŸŸé“¾</h3>
            <p>é—­åŒ…èƒ½è®¿é—®å¤–éƒ¨å˜é‡ï¼Œæ˜¯å› ä¸ºå†…éƒ¨å‡½æ•°ä¿æŒäº†å¯¹å¤–éƒ¨è¯æ³•ç¯å¢ƒçš„å¼•ç”¨ï¼Œå½¢æˆäº†ä½œç”¨åŸŸé“¾ã€‚</p>
            
            <pre><code>ä½œç”¨åŸŸé“¾ç¤ºæ„ï¼š
å†…éƒ¨å‡½æ•° [[Scope]] â†’ å¤–éƒ¨å‡½æ•°çš„è¯æ³•ç¯å¢ƒ â†’ å…¨å±€è¯æ³•ç¯å¢ƒ â†’ null</code></pre>
            
            <h2>ä¸‰ã€é—­åŒ…çš„åº”ç”¨åœºæ™¯</h2>
            
            <h3>3.1 æ•°æ®ç§æœ‰åŒ–</h3>
            <p>åˆ©ç”¨é—­åŒ…åˆ›å»ºç§æœ‰å˜é‡ï¼Œå®ç°å°è£…ï¼š</p>
            
            <h3>3.2 å‡½æ•°å·¥å‚</h3>
            <p>åˆ›å»ºå®šåˆ¶åŒ–çš„å‡½æ•°ï¼š</p>
            
            <h3>3.3 æ¨¡å—æ¨¡å¼</h3>
            <p>å®ç°æ¨¡å—åŒ–å’Œå‘½åç©ºé—´ï¼š</p>
            
            <h3>3.4 æŸ¯é‡ŒåŒ–ï¼ˆCurryingï¼‰</h3>
            <p>å°†å¤šå‚æ•°å‡½æ•°è½¬æ¢ä¸ºå•å‚æ•°å‡½æ•°åºåˆ—ï¼š</p>
            
            <h3>3.5 äº‹ä»¶å¤„ç†å’Œå›è°ƒ</h3>
            <p>ä¿æŒå¯¹ç‰¹å®šæ•°æ®çš„å¼•ç”¨ï¼š</p>
            
            <h2>å››ã€é—­åŒ…çš„é™·é˜±</h2>
            
            <h3>4.1 å¾ªç¯ä¸­çš„é—­åŒ…é—®é¢˜</h3>
            <p>ç»å…¸çš„å¾ªç¯é™·é˜±ï¼Œå·²åœ¨å˜é‡å£°æ˜ç« èŠ‚ä»‹ç»è¿‡ã€‚</p>
            
            <div class="warning">
                <strong>é—®é¢˜æ ¹æºï¼š</strong>var æ˜¯å‡½æ•°ä½œç”¨åŸŸï¼Œå¾ªç¯åˆ›å»ºçš„æ‰€æœ‰é—­åŒ…å…±äº«åŒä¸€ä¸ªå˜é‡ã€‚
            </div>
            
            <h3>4.2 å†…å­˜æ³„æ¼</h3>
            <p>é—­åŒ…ä¼šä¿æŒå¯¹å¤–éƒ¨å˜é‡çš„å¼•ç”¨ï¼Œå¦‚æœä¸å½“ä½¿ç”¨å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ï¼š</p>
            
            <div class="info">
                <strong>è§£å†³æ–¹æ³•ï¼š</strong>
                <ul>
                    <li>åŠæ—¶è§£é™¤å¼•ç”¨ï¼ˆè®¾ä¸º nullï¼‰</li>
                    <li>é¿å…åœ¨é—­åŒ…ä¸­å¼•ç”¨å¤§å¯¹è±¡</li>
                    <li>ä½¿ç”¨å¼±å¼•ç”¨ï¼ˆWeakMap/WeakSetï¼‰</li>
                </ul>
            </div>
            
            <h3>4.3 this æŒ‡å‘é—®é¢˜</h3>
            <p>é—­åŒ…ä¸­çš„ this ä¸ä¼šç»§æ‰¿å¤–éƒ¨å‡½æ•°çš„ thisï¼Œè€Œæ˜¯æŒ‡å‘è°ƒç”¨è€…ï¼š</p>
            
            <h2>äº”ã€é—­åŒ… vs æ™®é€šå‡½æ•°</h2>
            
            <table>
                <thead>
                    <tr>
                        <th>ç‰¹æ€§</th>
                        <th>æ™®é€šå‡½æ•°</th>
                        <th>é—­åŒ…</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>å˜é‡è®¿é—®</td>
                        <td>åªèƒ½è®¿é—®è‡ªå·±çš„å±€éƒ¨å˜é‡å’Œå…¨å±€å˜é‡</td>
                        <td>å¯ä»¥è®¿é—®å¤–éƒ¨å‡½æ•°çš„å˜é‡</td>
                    </tr>
                    <tr>
                        <td>ç”Ÿå‘½å‘¨æœŸ</td>
                        <td>æ‰§è¡Œå®Œæ¯•åï¼Œå±€éƒ¨å˜é‡è¢«é”€æ¯</td>
                        <td>å¤–éƒ¨å˜é‡åœ¨é—­åŒ…å­˜æ´»æœŸé—´ä¿æŒ</td>
                    </tr>
                    <tr>
                        <td>å†…å­˜å ç”¨</td>
                        <td>è¾ƒå°</td>
                        <td>è¾ƒå¤§ï¼ˆä¿æŒé¢å¤–å¼•ç”¨ï¼‰</td>
                    </tr>
                    <tr>
                        <td>çŠ¶æ€ä¿æŒ</td>
                        <td>æ— æ³•ä¿æŒçŠ¶æ€</td>
                        <td>å¯ä»¥ä¿æŒçŠ¶æ€</td>
                    </tr>
                </tbody>
            </table>
            
            <h2>å…­ã€æ€§èƒ½ä¼˜åŒ–å»ºè®®</h2>
            
            <div class="tip">
                <ul>
                    <li>é¿å…ä¸å¿…è¦çš„é—­åŒ…ï¼šå¦‚æœä¸éœ€è¦è®¿é—®å¤–éƒ¨å˜é‡ï¼Œå°±ä¸è¦åˆ›å»ºé—­åŒ…</li>
                    <li>å‡å°‘é—­åŒ…ä¸­çš„å˜é‡å¼•ç”¨ï¼šåªå¼•ç”¨å¿…è¦çš„å˜é‡</li>
                    <li>åŠæ—¶é‡Šæ”¾ï¼šä¸å†éœ€è¦çš„é—­åŒ…åº”è¯¥è§£é™¤å¼•ç”¨</li>
                    <li>ä½¿ç”¨ WeakMapï¼šå­˜å‚¨ä¸ DOM ç›¸å…³çš„æ•°æ®æ—¶</li>
                </ul>
            </div>
            
            <h2>å‚è€ƒèµ„æ–™</h2>
            <ul>
                <li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Closures" target="_blank">MDN - é—­åŒ…</a></li>
                <li><a href="https://tc39.es/ecma262/#sec-execution-contexts" target="_blank">ECMAScript - æ‰§è¡Œä¸Šä¸‹æ–‡</a></li>
                <li><a href="https://tc39.es/ecma262/#sec-lexical-environments" target="_blank">ECMAScript - è¯æ³•ç¯å¢ƒ</a></li>
            </ul>
            
            <div class="nav-links">
                <a href="04-function-basics.html" class="nav-link prev">ä¸Šä¸€èŠ‚ï¼šå‡½æ•°åŸºç¡€</a>
                <a href="../index.html" class="nav-link home">è¿”å›é¦–é¡µ</a>
                <a href="04-this.html" class="nav-link next">ä¸‹ä¸€èŠ‚ï¼šthis ç»‘å®šè§„åˆ™</a>
            </div>
        </div>
        
        <div class="code-panel">
            <h2 style="color: #60a5fa; margin-bottom: 1.5rem;">ğŸ’» äº¤äº’å¼ä»£ç ç¤ºä¾‹</h2>
            
            <!-- ç¤ºä¾‹1: åŸºæœ¬é—­åŒ… -->
            <div class="code-example">
                <h3>ç¤ºä¾‹ 1ï¼šåŸºæœ¬é—­åŒ…</h3>
                <div class="code-block">
                    <pre><code>function outer() {
    const outerVar = 'I am from outer!';
    
    function inner() {
        console.log(outerVar);  // è®¿é—®å¤–éƒ¨å˜é‡
    }
    
    return inner;
}

const myClosure = outer();
myClosure();  // è¾“å‡º: I am from outer!</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <!-- ç¤ºä¾‹2: æ•°æ®ç§æœ‰åŒ– -->
            <div class="code-example">
                <h3>ç¤ºä¾‹ 2ï¼šæ•°æ®ç§æœ‰åŒ–ï¼ˆè®¡æ•°å™¨ï¼‰</h3>
                <div class="code-block">
                    <pre><code>function createCounter() {
    let count = 0;  // ç§æœ‰å˜é‡
    
    return {
        increment() {
            count++;
            console.log('å¢åŠ å:', count);
            return count;
        },
        decrement() {
            count--;
            console.log('å‡å°‘å:', count);
            return count;
        },
        getCount() {
            return count;
        }
    };
}

const counter = createCounter();
counter.increment();  // 1
counter.increment();  // 2
counter.decrement();  // 1
console.log('å½“å‰è®¡æ•°:', counter.getCount());  // 1
console.log('æ— æ³•ç›´æ¥è®¿é—® count:', counter.count);  // undefined</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <!-- ç¤ºä¾‹3: å‡½æ•°å·¥å‚ -->
            <div class="code-example">
                <h3>ç¤ºä¾‹ 3ï¼šå‡½æ•°å·¥å‚</h3>
                <div class="code-block">
                    <pre><code>function createMultiplier(multiplier) {
    return function(number) {
        return number * multiplier;
    };
}

const double = createMultiplier(2);
const triple = createMultiplier(3);

console.log('double(5):', double(5));    // 10
console.log('triple(5):', triple(5));    // 15
console.log('double(10):', double(10));  // 20</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <!-- ç¤ºä¾‹4: æ¨¡å—æ¨¡å¼ -->
            <div class="code-example">
                <h3>ç¤ºä¾‹ 4ï¼šæ¨¡å—æ¨¡å¼</h3>
                <div class="code-block">
                    <pre><code>const Calculator = (function() {
    // ç§æœ‰å˜é‡å’Œæ–¹æ³•
    let result = 0;
    
    function log(operation, value) {
        console.log(`${operation} ${value}, ç»“æœ: ${result}`);
    }
    
    // å…¬å…±æ¥å£
    return {
        add(value) {
            result += value;
            log('åŠ ', value);
            return this;
        },
        subtract(value) {
            result -= value;
            log('å‡', value);
            return this;
        },
        multiply(value) {
            result *= value;
            log('ä¹˜', value);
            return this;
        },
        getResult() {
            return result;
        },
        reset() {
            result = 0;
            console.log('å·²é‡ç½®');
            return this;
        }
    };
})();

Calculator.add(10).multiply(2).subtract(5);
console.log('æœ€ç»ˆç»“æœ:', Calculator.getResult());  // 15</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <!-- ç¤ºä¾‹5: æŸ¯é‡ŒåŒ– -->
            <div class="code-example">
                <h3>ç¤ºä¾‹ 5ï¼šæŸ¯é‡ŒåŒ–åº”ç”¨</h3>
                <div class="code-block">
                    <pre><code>function curry(fn) {
    return function curried(...args) {
        if (args.length >= fn.length) {
            return fn.apply(this, args);
        } else {
            return function(...nextArgs) {
                return curried.apply(this, args.concat(nextArgs));
            };
        }
    };
}

function sum(a, b, c) {
    return a + b + c;
}

const curriedSum = curry(sum);

console.log('å…¨éƒ¨å‚æ•°:', curriedSum(1, 2, 3));      // 6
console.log('éƒ¨åˆ†åº”ç”¨:', curriedSum(1)(2)(3));      // 6
console.log('æ··åˆè°ƒç”¨:', curriedSum(1, 2)(3));      // 6

const add5 = curriedSum(5);
console.log('å¤ç”¨:', add5(10, 15));                 // 30</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
            
            <!-- ç¤ºä¾‹6: å¾ªç¯ä¸­çš„é—­åŒ…é™·é˜± -->
            <div class="code-example">
                <h3>ç¤ºä¾‹ 6ï¼šè§£å†³å¾ªç¯é—­åŒ…é—®é¢˜</h3>
                <div class="code-block">
                    <pre><code>// æ–¹æ³•1: ä½¿ç”¨ let
const funcs1 = [];
for (let i = 0; i < 3; i++) {
    funcs1.push(() => i);
}
console.log('let æ–¹æ¡ˆ:', funcs1.map(f => f()));  // [0, 1, 2]

// æ–¹æ³•2: ä½¿ç”¨ IIFE
const funcs2 = [];
for (var j = 0; j < 3; j++) {
    funcs2.push((function(index) {
        return () => index;
    })(j));
}
console.log('IIFE æ–¹æ¡ˆ:', funcs2.map(f => f()));  // [0, 1, 2]

// æ–¹æ³•3: ä½¿ç”¨ bind
const funcs3 = [];
for (var k = 0; k < 3; k++) {
    funcs3.push((function(val) {
        return val;
    }).bind(null, k));
}
console.log('bind æ–¹æ¡ˆ:', funcs3.map(f => f()));  // [0, 1, 2]</code></pre>
                </div>
                <button class="run-btn">â–¶ è¿è¡Œä»£ç </button>
                <div class="output"></div>
            </div>
        </div>
    </div>
    
    <script src="../assets/js/common.js"></script>
</body>
</html>
