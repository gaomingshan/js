# 案例 4：大型企业应用

## 概述

大型企业应用的构建问题，往往不是“能不能跑”，而是：

- **多人协作下的稳定性**（构建可预测、默认值可治理）
- **复杂交付形态**（多入口、多环境、多部署目标）
- **历史资产与生态兼容**（webpack loader/plugin、内部基建）
- **可观测与可回滚**（CI 指标、产物追踪、故障定位）

在这种场景里，工具选型通常更偏向 **bundler-first 的体系**：

- webpack（最成熟的生态与经验）
- 或 Rspack/Rsbuild（在兼容 webpack 心智的前提下提速）

> **关键点**
>
> 企业级选型的第一优先级往往是“风险控制”，其次才是“极致速度”。

---

## 一、典型业务背景与工程约束

你会经常遇到：

1. **工程规模大**
   - 多团队共建，代码量大，依赖庞杂

2. **交付目标多样**
   - Web（PC）
   - 内嵌（Hybrid/WebView）
   - 多租户/多品牌（同一套源码多份产物）

3. **历史兼容压力**
   - 兼容旧浏览器/企业内核
   - 沉淀了大量 webpack loader/plugin 与内部工具

4. **质量与合规**
   - source map 管理（是否上传、是否脱敏）
   - 安全策略（CSP、依赖审计）

---

## 二、目标：企业级构建要解决什么

### 2.1 构建系统的“工程目标”

- **稳定**：同一输入应产生一致输出（可复现）
- **可观测**：构建耗时、产物体积、chunk 变化可追踪
- **可治理**：统一默认配置、统一插件策略、统一质量门禁
- **可扩展**：支持业务增长（微前端、模块联邦、多入口）

### 2.2 产物目标（交付目标）

- **长期缓存可控**：hash、runtime、vendor 拆分策略稳定
- **按需加载合理**：拆包不碎不乱
- **静态资源路径一致**：publicPath/base、CDN、灰度发布

---

## 三、推荐方案 A：webpack（生态优先，治理优先）

### 3.1 适用理由

- loader/plugin 生态覆盖面最大
- 历史实践最多，排障经验丰富
- 对复杂产物策略（多入口、多 runtime、微前端）控制力强

### 3.2 工程化落地要点（比“写配置”更重要）

1. **配置分层与共享**
   - `webpack.common/dev/prod`
   - 抽成内部包：`@company/webpack-preset`

2. **性能治理**
   - webpack 5 filesystem cache
   - 缩小转译范围（Babel/SWC 只处理必要文件）
   - 产物体积阈值与报警

3. **可观测**
   - stats.json + analyzer
   - CI 记录 build time、bundle size 趋势

> **关键点**
>
> 企业级 webpack 不怕“配置多”，怕的是“配置散”。把共识沉淀成 preset 才能降低长期成本。

---

## 四、推荐方案 B：Rspack/Rsbuild（在兼容成本与性能之间取平衡）

### 4.1 什么时候值得迁移

- webpack v5 项目构建已经成为明显瓶颈
- 你的配置与生态主要停留在 webpack 5 规范范围内
- 你希望保持 webpack 的产物控制力，但获得更好的吞吐

### 4.2 迁移方式（现实可落地）

1. **先最小迁移跑通**：配置文件改名、脚本改命令。
2. **再替换慢链路**：优先处理 babel-loader（可用内置 swc-loader）。
3. **最后治理差异点**：少数 loader/plugin 的兼容与替代。

> **关键点**
>
> 迁移不是“换工具”，是一次工程治理：你需要基线、回滚与分阶段收益。

---

## 五、企业级构建的“组织策略”比工具更重要

### 5.1 建议把构建当成平台治理

- 建立构建 owner（平台/基建团队）
- 统一：
  - 目录约定
  - 环境变量规范
  - 质量门禁
  - 发布流程

### 5.2 建议建立三类基线指标

1. **构建指标**：冷启动、增量构建、CI 总耗时
2. **产物指标**：首屏包体、异步 chunk 数、最大 chunk
3. **故障指标**：线上 404（chunk）、source map 命中率、回滚次数

---

## 六、常见坑与规避

1. **publicPath/base 没治理**
   - 现象：线上 chunk 404、灰度环境加载错资源
   - 规避：将 publicPath 设计成“可配置的部署契约”，并写入发布系统

2. **拆包策略随人而变**
   - 现象：缓存命中率极差
   - 规避：沉淀统一 splitChunks/manualChunks 策略，建立体积回归

3. **source map 管理混乱**
   - 现象：能复现但定位困难，或泄露源码
   - 规避：明确上传策略、脱敏策略、访问权限

---

## 参考资料

- [webpack - Caching](https://webpack.js.org/guides/caching/)
- [webpack - Code Splitting](https://webpack.js.org/guides/code-splitting/)
- [Rspack](https://rspack.rs/)
- [Rsbuild](https://v0.rsbuild.dev/)
