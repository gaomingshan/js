# 构建工具认知误区

## 概述

构建工具之所以“看起来很玄学”，很多时候不是工具真的复杂，而是我们在一开始就带着错误的类比去理解它。

这一章用“误区 → 澄清”的方式，帮你建立更稳的直觉模型：

- 先分清“开发阶段”和“生产阶段”的目标差异
- 再分清“构建范式”和“构建引擎”的职责边界
- 最后才去理解某个具体工具（Vite/webpack/Rollup…）

---

## 一、误区：Vite ≠ 不打包

### 1.1 为什么会产生这个误解

Vite 的开发体验很像“没打包”：启动快、修改即生效。

### 1.2 正确理解

- **开发阶段**：尽量不对“业务源码”做整体 bundling，基于浏览器原生 ESM 按需加载
- **依赖仍会处理**：通常会做依赖预构建（把 CJS/复杂依赖转成更适合浏览器的形态）
- **生产构建仍会打包**：通常交给 bundler（常见是 Rollup）输出可部署产物

> **关键点**
>
> Vite 的创新主要在“Dev 范式”，不是“永远不打包”。

---

## 二、误区：esbuild ≠ webpack 替代品

### 2.1 esbuild 强在哪里

- 极快的解析/转译/压缩
- API 简洁，适合做脚手架与内嵌构建引擎

### 2.2 esbuild 不擅长什么

- 非常复杂的应用级生态与可编程构建系统（成熟度与兼容性是现实问题）
- 需要深度定制的“工程整合”（大量 loader/plugin、历史包袱）

> **直觉理解**
>
> esbuild 更像“高性能编译器内核”；webpack 更像“可编程的应用级构建系统”。它们关注点不同。

---

## 三、误区：Rollup ≠ 只能打包库

Rollup 的确非常适合库（产物干净、tree shaking 强），但它也能打包应用：

- Vite 的生产构建默认就基于 Rollup

真正需要澄清的是：

- “能打包应用”不等于“作为应用级工具最省心”
- 许多应用开发体验（dev server、HMR、约定）通常由上层工具补齐（例如 Vite）

---

## 四、误区：Tree Shaking 会自动移除所有没用代码

Tree Shaking 的前提条件很多：

- 依赖与产物需要可分析（通常 ESM 更友好）
- 副作用语义要正确（`package.json` 的 `sideEffects`）
- 代码要避免阻碍分析的动态行为（例如运行时拼接导出）

```json
{ "sideEffects": false }
```

> **关键点**
>
> Tree Shaking 是“编译期优化”，不是“运行时自动优化”。

---

## 五、误区：代码分割越多越好

过度拆包会带来：

- 额外请求与调度开销
- chunk 过小导致缓存收益不明显
- 首屏关键路径变长（依赖瀑布）

更合理的目标是：

- 拆出稳定且大的第三方依赖（长期缓存）
- 拆出低频但大的功能模块（按需加载）

---

## 六、误区：HMR 就是“不刷新页面”

HMR（热更新）本质是“模块级更新协议”。

- 构建工具负责推送“哪个模块变了”
- 应用/框架负责决定“怎么替换”和“能否保留状态”

所以你会看到：

- 有的改动热更新
- 有的改动会触发整页刷新

这并不一定是工具坏了，而是热更新边界与运行时语义不同。

---

## 七、误区：开发环境能跑，生产环境就一定没问题

开发与生产的差异非常大：

- **开发**：更看重反馈速度与可调试性（源码结构、sourcemap、HMR）
- **生产**：更看重性能与稳定性（拆包、缓存、minify、资源路径、兼容性）

典型问题：

- `base/publicPath` 配置导致 chunk 404
- 生产 minify 后暴露出依赖的“非严格代码”问题
- Tree Shaking 误删（副作用标注不正确）

> **建议**
>
> 把 `build` 和 `preview/serve` 当成日常流程的一部分，而不是上线前最后一次才跑。

---

## 八、误区：构建工具只是“把代码变小”

压缩只是表象，构建工具更重要的价值是：

- 把模块图转成**可部署的资产集合**（JS/CSS/图片/清单）
- 形成稳定的**拆包与缓存策略**
- 把工程能力接入流水线（质量、监控、发布）

---

## 参考资料

- [Vite - Why Vite](https://vite.dev/guide/why.html)
- [webpack - Concepts](https://webpack.js.org/concepts/)
- [Rollup - Introduction](https://rollupjs.org/introduction/)
- [esbuild - Why](https://esbuild.github.io/)
